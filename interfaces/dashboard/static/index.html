<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAM Dashboard</title>
    <style>
        /* --- Reset & Base --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            background: #0f1923;
            color: #e0e0e0;
            min-height: 100vh;
        }

        /* --- Header --- */
        header {
            background: #1a2332;
            border-bottom: 1px solid #2a3a4a;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .logo span {
            color: #5b9bd5;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #888;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e74c3c;
        }

        .status-dot.connected {
            background: #00d672;
        }

        .telegram-status { display:flex; align-items:center; gap:0.4rem; font-size:0.8rem; color:#888; margin-right:0.5rem; }
        .telegram-status .tg-dot { width:8px; height:8px; border-radius:50%; background:#e74c3c; }
        .telegram-status .tg-dot.connected { background:#00d672; }

        /* --- Kill Switch â€” Constitution: "Prominent, always visible" --- */
        .kill-switch-bar {
            background: #1a2332;
            border-bottom: 1px solid #2a3a4a;
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kill-switch-btn {
            background: #c0392b;
            color: #fff;
            border: 2px solid #e74c3c;
            border-radius: 6px;
            padding: 0.6rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 700;
            font-family: inherit;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.15s, box-shadow 0.15s;
        }

        .kill-switch-btn:hover {
            background: #e74c3c;
            box-shadow: 0 0 12px rgba(231, 76, 60, 0.5);
        }

        .kill-switch-btn:active {
            background: #a93226;
        }

        .kill-switch-btn.activated {
            background: #7f1d1d;
            border-color: #991b1b;
            cursor: default;
            box-shadow: none;
        }

        .kill-switch-label {
            font-size: 0.8rem;
            color: #6a7a8a;
        }

        .kill-switch-status {
            font-size: 0.85rem;
            font-weight: 600;
            color: #e74c3c;
            display: none;
        }

        .kill-switch-status.active {
            display: inline;
        }

        /* --- Main Content --- */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #8ab4d6;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* --- Agent Grid --- */
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        /* --- Agent Card --- */
        .agent-card {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1.25rem;
            transition: border-color 0.2s;
        }

        .agent-card:hover {
            border-color: #3a5a7a;
        }

        .agent-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .agent-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .agent-status-badge {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
        }

        .agent-status-badge.online {
            background: rgba(0, 214, 114, 0.15);
            color: #00d672;
        }

        .agent-status-badge.offline {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .agent-status-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .agent-status-badge.online .dot {
            background: #00d672;
        }

        .agent-status-badge.offline .dot {
            background: #e74c3c;
        }

        .agent-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .agent-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-detail .label {
            color: #6a7a8a;
        }

        .agent-detail .value {
            color: #c0c8d0;
            font-family: monospace;
        }

        /* --- Agent Capabilities --- */
        .agent-capabilities {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.5rem;
        }

        .capability-badge {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            background: rgba(91, 155, 213, 0.15);
            color: #5b9bd5;
        }

        /* --- Agent Chat Log --- */
        .agent-chat {
            margin-top: 0.75rem;
            border-top: 1px solid #2a3a4a;
            padding-top: 0.75rem;
        }

        .chat-log {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
            font-family: monospace;
            margin-bottom: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .chat-msg {
            padding: 0.25rem 0.4rem;
            border-radius: 4px;
            line-height: 1.4;
            word-break: break-word;
        }

        .chat-msg.sent {
            color: #5b9bd5;
        }

        .chat-msg.received {
            color: #00d672;
        }

        .chat-msg.error {
            color: #e74c3c;
        }

        .chat-msg .chat-prefix {
            font-weight: 600;
            margin-right: 0.3rem;
        }

        .chat-input-row {
            display: flex;
            gap: 0.4rem;
        }

        .chat-input {
            flex: 1;
            background: #0f1923;
            border: 1px solid #2a3a4a;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: monospace;
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
            outline: none;
        }

        .chat-input:focus {
            border-color: #5b9bd5;
        }

        .chat-input::placeholder {
            color: #4a5a6a;
        }

        .chat-send-btn {
            background: #2a3a4a;
            border: 1px solid #3a5a7a;
            border-radius: 4px;
            color: #8ab4d6;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .chat-send-btn:hover {
            background: #3a5a7a;
        }

        .chat-send-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }

        /* --- Task Queue Section --- */
        .task-section {
            margin-bottom: 2rem;
        }

        .task-submit-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .task-submit-form input[type="text"] {
            flex: 1;
            background: #0f1923;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            outline: none;
        }

        .task-submit-form input[type="text"]:focus {
            border-color: #5b9bd5;
        }

        .task-submit-form input[type="text"]::placeholder {
            color: #4a5a6a;
        }

        .task-submit-form select {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.5rem 0.5rem;
            outline: none;
            cursor: pointer;
        }

        .task-submit-btn {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1.2rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .task-submit-btn:hover {
            background: #3b82f6;
        }

        .task-submit-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }

        /* Stats bar */
        .task-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }

        .task-stat {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .task-stat .label {
            color: #6a7a8a;
        }

        .task-stat .value {
            font-weight: 600;
            font-family: monospace;
        }

        .task-stat .value.pending { color: #f59e0b; }
        .task-stat .value.running { color: #3b82f6; }
        .task-stat .value.completed { color: #00d672; }
        .task-stat .value.failed { color: #e74c3c; }

        /* Active task with OATI phase indicator */
        .task-active-panel {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .task-active-panel.hidden {
            display: none;
        }

        .task-active-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .task-active-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .task-active-id {
            font-size: 0.8rem;
            color: #6a7a8a;
            font-family: monospace;
        }

        .oati-phases {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .oati-phase {
            flex: 1;
            text-align: center;
            padding: 0.4rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            background: #0f1923;
            color: #3a4a5a;
            border: 1px solid #1a2a3a;
            transition: all 0.3s;
        }

        .oati-phase.active {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-color: #3b82f6;
            animation: oati-pulse 1.5s ease-in-out infinite;
        }

        .oati-phase.done {
            background: rgba(0, 214, 114, 0.15);
            color: #00d672;
            border-color: #00d672;
            animation: none;
        }

        .oati-phase.failed {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
            border-color: #e74c3c;
            animation: none;
        }

        @keyframes oati-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .task-active-detail {
            font-size: 0.8rem;
            color: #6a7a8a;
            margin-top: 0.4rem;
        }

        /* Task history list */
        .task-history {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 0.75rem 1rem;
        }

        .task-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .task-item-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .task-id {
            font-size: 0.75rem;
            font-family: monospace;
            color: #5b9bd5;
        }

        .task-status-badge {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
        }

        .task-status-badge.pending {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .task-status-badge.running {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .task-status-badge.completed {
            background: rgba(0, 214, 114, 0.15);
            color: #00d672;
        }

        .task-status-badge.failed {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .task-meta {
            font-size: 0.75rem;
            color: #6a7a8a;
        }

        .task-description {
            font-size: 0.85rem;
            color: #c0c8d0;
            line-height: 1.4;
        }

        .task-result {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #0f1923;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: monospace;
            color: #a0b0c0;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.4;
        }

        .task-empty-state {
            text-align: center;
            padding: 2rem;
            color: #4a5a6a;
            font-size: 0.9rem;
        }

        /* --- Empty State --- */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #4a5a6a;
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: #6a7a8a;
        }

        .empty-state p {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .empty-state code {
            background: #1a2332;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* --- Agent Health --- */
        .agent-health {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #2a3a4a;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            font-size: 0.8rem;
        }

        .health-indicator {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .health-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .health-dot.green { background: #00d672; }
        .health-dot.yellow { background: #f59e0b; }
        .health-dot.red { background: #e74c3c; }

        .health-label {
            font-weight: 600;
            font-size: 0.8rem;
        }

        .health-label.green { color: #00d672; }
        .health-label.yellow { color: #f59e0b; }
        .health-label.red { color: #e74c3c; }

        .health-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .health-row .label {
            color: #6a7a8a;
        }

        .health-row .value {
            color: #c0c8d0;
            font-family: monospace;
        }

        .health-row .value.warn {
            color: #f59e0b;
        }

        .health-bar-container {
            height: 6px;
            background: #0f1923;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.2rem;
        }

        .health-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .health-bar-fill.green { background: #00d672; }
        .health-bar-fill.yellow { background: #f59e0b; }
        .health-bar-fill.red { background: #e74c3c; }

        .ping-row {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.2rem;
        }

        .ping-btn {
            background: #2a3a4a;
            border: 1px solid #3a5a7a;
            border-radius: 4px;
            color: #8ab4d6;
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .ping-btn:hover {
            background: #3a5a7a;
        }

        .ping-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .ping-result {
            font-family: monospace;
            font-size: 0.8rem;
            color: #c0c8d0;
        }

        .agent-status-badge.busy {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .agent-status-badge.busy .dot {
            background: #f59e0b;
        }

        /* --- Event Log --- */
        .event-log-section {
            margin-bottom: 2rem;
        }

        .event-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .event-log-header h2 {
            margin-bottom: 0;
        }

        .event-log-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .event-log-btn {
            background: #2a3a4a;
            border: 1px solid #3a5a7a;
            border-radius: 4px;
            color: #8ab4d6;
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .event-log-btn:hover {
            background: #3a5a7a;
        }

        .event-log-container {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.78rem;
            line-height: 1.5;
        }

        .event-entry {
            padding: 0.3rem 0.75rem;
            border-bottom: 1px solid #1f2d3d;
            display: flex;
            gap: 0.5rem;
            align-items: baseline;
        }

        .event-entry:last-child {
            border-bottom: none;
        }

        .event-time {
            color: #4a5a6a;
            flex-shrink: 0;
            font-size: 0.72rem;
        }

        .event-severity {
            font-weight: 700;
            font-size: 0.7rem;
            padding: 0.05rem 0.3rem;
            border-radius: 3px;
            flex-shrink: 0;
            text-transform: uppercase;
        }

        .event-severity.info {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .event-severity.warn {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .event-severity.error {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .event-category {
            color: #5b9bd5;
            flex-shrink: 0;
            font-size: 0.72rem;
        }

        .event-message {
            color: #c0c8d0;
            word-break: break-word;
        }

        .event-message.warn {
            color: #f59e0b;
        }

        .event-message.error {
            color: #e74c3c;
        }

        .event-empty {
            text-align: center;
            padding: 1.5rem;
            color: #4a5a6a;
        }

        /* --- Analytics Section --- */
        .analytics-section {
            margin-bottom: 2rem;
        }

        .analytics-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .analytics-card {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .analytics-card .card-label {
            font-size: 0.75rem;
            color: #6a7a8a;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .analytics-card .card-value {
            font-size: 1.4rem;
            font-weight: 700;
            font-family: monospace;
            color: #e0e0e0;
        }

        .analytics-card .card-value.accent {
            color: #5b9bd5;
        }

        .analytics-card .card-value.success {
            color: #00d672;
        }

        .analytics-card .card-value.cost {
            color: #f59e0b;
        }

        .analytics-bar-chart {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem 1.25rem;
        }

        .analytics-bar-chart h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #8ab4d6;
            margin-bottom: 0.75rem;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .bar-label {
            flex: 0 0 140px;
            font-size: 0.8rem;
            color: #c0c8d0;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bar-track {
            flex: 1;
            height: 20px;
            background: #0f1923;
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: #5b9bd5;
            border-radius: 4px;
            transition: width 0.4s ease;
            min-width: 2px;
        }

        .bar-count {
            flex: 0 0 40px;
            font-size: 0.8rem;
            font-family: monospace;
            color: #8ab4d6;
        }

        .analytics-empty {
            text-align: center;
            padding: 1.5rem;
            color: #4a5a6a;
            font-size: 0.85rem;
        }

        /* --- Memory Status Section --- */
        .memory-section {
            margin-bottom: 2rem;
        }

        .memory-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .memory-card {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .memory-card .card-label {
            font-size: 0.75rem;
            color: #6a7a8a;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .memory-card .card-value {
            font-size: 1.4rem;
            font-weight: 700;
            font-family: monospace;
            color: #e0e0e0;
        }

        .memory-card .card-value.memory-accent {
            color: #a78bfa;
        }

        .memory-card .card-value.memory-working {
            color: #34d399;
        }

        .memory-usage-bar {
            height: 6px;
            background: #2a3a4a;
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .memory-usage-fill {
            height: 100%;
            border-radius: 3px;
            background: #a78bfa;
            transition: width 0.3s ease;
        }

        .memory-usage-fill.warning {
            background: #f59e0b;
        }

        .memory-usage-fill.critical {
            background: #e74c3c;
        }

        .memory-working-list {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem 1.25rem;
        }

        .memory-working-list h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #8ab4d6;
            margin-bottom: 0.75rem;
        }

        .memory-working-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px solid #1f2d3d;
            font-size: 0.8rem;
        }

        .memory-working-entry:last-child {
            border-bottom: none;
        }

        .memory-working-entry .entry-desc {
            color: #c0c8d0;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 0.75rem;
        }

        .memory-working-entry .entry-phase {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            background: rgba(167, 139, 250, 0.15);
            color: #a78bfa;
        }

        /* --- Long-Term Memory --- */
        .memory-ltm-section {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-top: 1rem;
        }

        .memory-ltm-section h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #8ab4d6;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ltm-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.1rem 0.5rem;
            border-radius: 10px;
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
        }

        .ltm-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .ltm-card {
            background: #141e2a;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            text-align: center;
        }

        .ltm-card .ltm-card-label {
            font-size: 0.7rem;
            color: #6b7b8d;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .ltm-card .ltm-card-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #60a5fa;
        }

        .ltm-status {
            font-size: 0.7rem;
            color: #6b7b8d;
            margin-top: 0.4rem;
        }

        .ltm-status.error {
            color: #f87171;
        }

        /* --- Episodic Memory --- */
        .memory-episodic-section {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-top: 1rem;
        }

        .memory-episodic-section h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #d4a054;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .episodic-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.1rem 0.5rem;
            border-radius: 10px;
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .episodic-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .episodic-card {
            background: #141e2a;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            text-align: center;
        }

        .episodic-card .episodic-card-label {
            font-size: 0.7rem;
            color: #6b7b8d;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .episodic-card .episodic-card-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #f59e0b;
        }

        .episodic-search {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .episodic-search input {
            flex: 1;
            background: #141e2a;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.8rem;
        }

        .episodic-search input:focus {
            outline: none;
            border-color: #f59e0b;
        }

        .episodic-search button {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }

        .episodic-search button:hover {
            background: rgba(245, 158, 11, 0.25);
        }

        .episodic-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .episodic-entry {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #1e2d3d;
        }

        .episodic-entry:last-child {
            border-bottom: none;
        }

        .episodic-participant {
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            text-transform: uppercase;
            white-space: nowrap;
            min-width: 55px;
            text-align: center;
        }

        .episodic-participant.user {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
        }

        .episodic-participant.assistant {
            background: rgba(52, 211, 153, 0.15);
            color: #34d399;
        }

        .episodic-participant.system {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .episodic-content {
            flex: 1;
            font-size: 0.75rem;
            color: #c0c8d0;
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .episodic-time {
            font-size: 0.65rem;
            color: #6b7b8d;
            white-space: nowrap;
        }

        .episodic-status {
            font-size: 0.7rem;
            color: #6b7b8d;
            margin-top: 0.4rem;
        }

        /* --- Command Palette --- */
        .command-palette-section {
            margin-bottom: 2rem;
        }

        .command-palette-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .command-palette-form select {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.5rem 0.5rem;
            outline: none;
            cursor: pointer;
        }

        .command-palette-form select:focus {
            border-color: #5b9bd5;
        }

        .command-params {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .command-param-group {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .command-param-group label {
            font-size: 0.8rem;
            color: #6a7a8a;
            white-space: nowrap;
        }

        .command-param-group input {
            background: #0f1923;
            border: 1px solid #2a3a4a;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: monospace;
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
            outline: none;
            width: 160px;
        }

        .command-param-group input:focus {
            border-color: #5b9bd5;
        }

        .command-param-group input::placeholder {
            color: #4a5a6a;
        }

        .command-description {
            font-size: 0.8rem;
            color: #6a7a8a;
            margin-bottom: 0.5rem;
        }

        .command-execute-btn {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1.2rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .command-execute-btn:hover {
            background: #3b82f6;
        }

        .command-execute-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .command-result-panel {
            margin-top: 0.5rem;
            padding: 0.75rem 1rem;
            background: #0f1923;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: monospace;
            color: #a0b0c0;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.4;
            display: none;
        }

        .command-result-panel.visible {
            display: block;
        }

        .command-result-panel .result-header {
            color: #5b9bd5;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .command-result-panel .result-error {
            color: #e74c3c;
        }

        .command-result-panel .result-pending {
            color: #f59e0b;
        }

        /* --- Task Chains --- */
        .chain-section {
            margin-bottom: 2rem;
        }

        .chain-builder {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .chain-builder-header {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .chain-builder-header input[type="text"] {
            flex: 1;
            min-width: 200px;
            background: #0f1923;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            outline: none;
        }

        .chain-builder-header input[type="text"]:focus {
            border-color: #5b9bd5;
        }

        .chain-builder-header input[type="text"]::placeholder {
            color: #4a5a6a;
        }

        .chain-builder-btn {
            background: #2a3a4a;
            border: 1px solid #3a5a7a;
            border-radius: 6px;
            color: #8ab4d6;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .chain-builder-btn:hover {
            background: #3a5a7a;
        }

        .chain-builder-btn.primary {
            background: #2563eb;
            border-color: #3b82f6;
            color: #fff;
        }

        .chain-builder-btn.primary:hover {
            background: #3b82f6;
        }

        .chain-builder-btn.primary:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .chain-step-rows {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .chain-step-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            background: #0f1923;
            border: 1px solid #1a2a3a;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
        }

        .chain-step-num {
            font-size: 0.75rem;
            font-weight: 700;
            color: #5b9bd5;
            flex-shrink: 0;
            width: 1.5rem;
            text-align: center;
        }

        .chain-step-row input[type="text"] {
            flex: 1;
            background: transparent;
            border: 1px solid #2a3a4a;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.35rem 0.5rem;
            outline: none;
        }

        .chain-step-row input[type="text"]:focus {
            border-color: #5b9bd5;
        }

        .chain-step-row input[type="text"]::placeholder {
            color: #4a5a6a;
        }

        .chain-step-row select {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.8rem;
            padding: 0.35rem 0.3rem;
            outline: none;
            cursor: pointer;
        }

        .chain-step-remove {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 1rem;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            transition: background 0.15s;
            flex-shrink: 0;
        }

        .chain-step-remove:hover {
            background: rgba(231, 76, 60, 0.15);
        }

        /* Chain cards */
        .chain-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chain-card {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem 1.25rem;
        }

        .chain-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .chain-card-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chain-card-name {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .chain-card-id {
            font-size: 0.75rem;
            font-family: monospace;
            color: #6a7a8a;
        }

        .chain-status-badge {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
        }

        .chain-status-badge.pending {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .chain-status-badge.running {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .chain-status-badge.completed {
            background: rgba(0, 214, 114, 0.15);
            color: #00d672;
        }

        .chain-status-badge.failed {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .chain-progress-bar {
            height: 6px;
            background: #0f1923;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .chain-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease, background 0.3s;
        }

        .chain-progress-fill.running {
            background: #3b82f6;
        }

        .chain-progress-fill.completed {
            background: #00d672;
        }

        .chain-progress-fill.failed {
            background: #e74c3c;
        }

        .chain-steps {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .chain-step {
            flex: 1;
            min-width: 60px;
            text-align: center;
            padding: 0.35rem 0.4rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            background: #0f1923;
            color: #3a4a5a;
            border: 1px solid #1a2a3a;
            transition: all 0.3s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chain-step.active {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-color: #3b82f6;
            animation: oati-pulse 1.5s ease-in-out infinite;
        }

        .chain-step.done {
            background: rgba(0, 214, 114, 0.15);
            color: #00d672;
            border-color: #00d672;
            animation: none;
        }

        .chain-step.failed {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
            border-color: #e74c3c;
            animation: none;
        }

        .chain-empty {
            text-align: center;
            padding: 1.5rem;
            color: #4a5a6a;
            font-size: 0.85rem;
        }

        /* --- Task Scheduler --- */
        .schedule-section {
            margin-bottom: 2rem;
        }

        .schedule-builder {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .schedule-builder-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .schedule-builder-row input[type="text"],
        .schedule-builder-row input[type="number"] {
            flex: 1;
            min-width: 120px;
            background: #0f1923;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            outline: none;
        }

        .schedule-builder-row input:focus {
            border-color: #5b9bd5;
        }

        .schedule-builder-row input::placeholder {
            color: #4a5a6a;
        }

        .schedule-builder-row select {
            background: #0f1923;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
            outline: none;
            cursor: pointer;
        }

        .schedule-builder-row select:focus {
            border-color: #5b9bd5;
        }

        .schedule-builder-row label {
            font-size: 0.8rem;
            color: #7a8a9a;
            white-space: nowrap;
        }

        .schedule-builder-row .schedule-builder-btn {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .schedule-builder-row .schedule-builder-btn:hover {
            background: #3b82f6;
        }

        .schedule-card {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 0.85rem 1rem;
            margin-bottom: 0.5rem;
            transition: opacity 0.3s;
        }

        .schedule-card.disabled {
            opacity: 0.5;
        }

        .schedule-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .schedule-card-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .schedule-card-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: #e0e0e0;
        }

        .schedule-card-id {
            font-size: 0.75rem;
            color: #4a5a6a;
            font-family: 'JetBrains Mono', monospace;
        }

        .schedule-enabled-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .schedule-enabled-badge.on {
            background: rgba(0, 214, 114, 0.15);
            color: #00d672;
        }

        .schedule-enabled-badge.off {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .schedule-type-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .schedule-card-meta {
            font-size: 0.8rem;
            color: #5a6a7a;
            margin-bottom: 0.4rem;
        }

        .schedule-card-meta span {
            margin-right: 1rem;
        }

        .schedule-card-actions {
            display: flex;
            gap: 0.4rem;
        }

        .schedule-card-btn {
            background: #2a3a4a;
            border: 1px solid #3a5a7a;
            border-radius: 6px;
            color: #8ab4d6;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.3rem 0.7rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .schedule-card-btn:hover {
            background: #3a5a7a;
        }

        .schedule-card-btn.danger {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .schedule-card-btn.danger:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        .schedule-empty {
            text-align: center;
            padding: 1.5rem;
            color: #4a5a6a;
            font-size: 0.85rem;
        }

        .schedule-interval-input {
            max-width: 100px;
        }

        .schedule-time-input {
            max-width: 100px;
        }

        /* --- Content Calendar --- */
        .content-section {
            margin-bottom: 2rem;
        }

        .content-builder {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .content-builder-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .content-builder-row input[type="text"],
        .content-builder-row input[type="date"] {
            flex: 1;
            min-width: 120px;
            background: #0f1923;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            outline: none;
        }

        .content-builder-row input:focus {
            border-color: #5b9bd5;
        }

        .content-builder-row input::placeholder {
            color: #4a5a6a;
        }

        .content-builder-row select {
            background: #0f1923;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
            outline: none;
            cursor: pointer;
        }

        .content-builder-row select:focus {
            border-color: #5b9bd5;
        }

        .content-builder-row label {
            font-size: 0.8rem;
            color: #7a8a9a;
            white-space: nowrap;
        }

        .content-builder-row .content-builder-btn {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .content-builder-row .content-builder-btn:hover {
            background: #3b82f6;
        }

        .content-card {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 0.85rem 1rem;
            margin-bottom: 0.5rem;
        }

        .content-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .content-card-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .content-card-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: #e0e0e0;
        }

        .content-card-id {
            font-size: 0.75rem;
            color: #4a5a6a;
            font-family: 'JetBrains Mono', monospace;
        }

        .content-status-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .content-status-badge.idea        { background: rgba(74, 90, 106, 0.25); color: #7a8a9a; }
        .content-status-badge.planned      { background: rgba(37, 99, 235, 0.2); color: #60a5fa; }
        .content-status-badge.in_progress  { background: rgba(217, 119, 6, 0.2); color: #fbbf24; }
        .content-status-badge.review       { background: rgba(234, 88, 12, 0.2); color: #fb923c; }
        .content-status-badge.published    { background: rgba(22, 163, 74, 0.2); color: #4ade80; }
        .content-status-badge.archived     { background: rgba(107, 114, 128, 0.2); color: #6b7280; }

        .content-type-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .content-card-meta {
            font-size: 0.8rem;
            color: #5a6a7a;
            margin-bottom: 0.4rem;
        }

        .content-card-meta span {
            margin-right: 1rem;
        }

        .content-card-actions {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        .content-card-actions select {
            background: #0f1923;
            border: 1px solid #2a3a4a;
            border-radius: 6px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.75rem;
            padding: 0.25rem 0.4rem;
            outline: none;
            cursor: pointer;
        }

        .content-card-btn {
            background: #2a3a4a;
            border: 1px solid #3a5a7a;
            border-radius: 6px;
            color: #8ab4d6;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.3rem 0.7rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .content-card-btn:hover {
            background: #3a5a7a;
        }

        .content-card-btn.danger {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .content-card-btn.danger:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        .content-empty {
            text-align: center;
            padding: 1.5rem;
            color: #4a5a6a;
            font-size: 0.85rem;
        }

        /* --- Persona Panel --- */
        .persona-section {
            margin-bottom: 2rem;
        }

        .persona-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .persona-header h2 {
            margin: 0;
        }

        .persona-reload-btn {
            background: transparent;
            border: 1px solid #a78bfa;
            color: #a78bfa;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .persona-reload-btn:hover {
            background: rgba(167, 139, 250, 0.15);
        }

        .persona-card {
            background: #1a2332;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .persona-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #a78bfa;
            margin-bottom: 0.15rem;
        }

        .persona-tagline {
            font-style: italic;
            color: #8892a4;
            margin-bottom: 0.75rem;
        }

        .persona-role {
            color: #c9d1d9;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .persona-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-bottom: 0.5rem;
        }

        .persona-tag {
            display: inline-block;
            padding: 0.15rem 0.55rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .persona-tag.tone {
            border: 1px solid #a78bfa;
            color: #a78bfa;
        }

        .persona-tag.domain {
            border: 1px solid #34d399;
            color: #34d399;
        }

        .persona-prompt-preview {
            background: #0d1520;
            border-radius: 6px;
            padding: 0.85rem 1rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.8rem;
            color: #8892a4;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .persona-token-estimate {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.75rem;
            color: #586e75;
            margin-top: 0.4rem;
            text-align: right;
        }

        /* --- Settings Panel --- */
        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .settings-header h2 {
            margin-bottom: 0;
        }

        .settings-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .settings-last-loaded {
            font-size: 0.75rem;
            color: #6a7a8a;
            font-family: monospace;
        }

        .settings-reload-btn {
            background: #2a3a4a;
            border: 1px solid #3a5a7a;
            border-radius: 4px;
            color: #8ab4d6;
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .settings-reload-btn:hover {
            background: #3a5a7a;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
        }

        .settings-card {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 0.75rem 1rem;
        }

        .settings-card h3 {
            font-size: 0.8rem;
            font-weight: 600;
            color: #5b9bd5;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.5rem;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.2rem 0;
            font-size: 0.78rem;
        }

        .settings-row .key {
            color: #6a7a8a;
        }

        .settings-row .val {
            color: #c0c8d0;
            font-family: monospace;
        }

        /* --- Notification Bell --- */
        .notification-bell {
            position: relative;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-bell svg {
            width: 22px;
            height: 22px;
            fill: #8ab4d6;
            transition: fill 0.15s;
        }

        .notification-bell:hover svg {
            fill: #b0d0ee;
        }

        .notification-bell .badge {
            position: absolute;
            top: 0;
            right: -2px;
            background: #e74c3c;
            color: #fff;
            font-size: 0.65rem;
            font-weight: 700;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            line-height: 1;
        }

        .notification-bell .badge.hidden {
            display: none;
        }

        /* --- Notification Dropdown --- */
        .notification-wrapper {
            position: relative;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            width: 360px;
            max-height: 420px;
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 1000;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .notification-dropdown.open {
            display: flex;
            flex-direction: column;
        }

        .notification-dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #2a3a4a;
            flex-shrink: 0;
        }

        .notification-dropdown-header h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #e0e0e0;
        }

        .notification-mark-all {
            background: none;
            border: none;
            color: #5b9bd5;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }

        .notification-mark-all:hover {
            background: rgba(91, 155, 213, 0.15);
        }

        .notification-list {
            overflow-y: auto;
            flex: 1;
        }

        .notification-item {
            padding: 0.6rem 1rem;
            border-bottom: 1px solid #1f2d3d;
            cursor: pointer;
            transition: background 0.1s;
            border-left: 3px solid transparent;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item:hover {
            background: rgba(255,255,255,0.03);
        }

        .notification-item.unread {
            border-left-color: #5b9bd5;
            background: rgba(91, 155, 213, 0.05);
        }

        .notification-item.read {
            opacity: 0.6;
        }

        .notification-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.2rem;
        }

        .notification-item-title {
            font-size: 0.82rem;
            font-weight: 600;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .notification-severity-badge {
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.05rem 0.35rem;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .notification-severity-badge.info {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .notification-severity-badge.warn {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .notification-severity-badge.error {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .notification-severity-badge.critical {
            background: rgba(220, 38, 38, 0.25);
            color: #f87171;
        }

        .notification-item-time {
            font-size: 0.7rem;
            color: #4a5a6a;
        }

        .notification-item-message {
            font-size: 0.78rem;
            color: #a0b0c0;
            line-height: 1.3;
        }

        .notification-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: #4a5a6a;
            font-size: 0.85rem;
        }

        /* --- Toast Container --- */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
            max-width: 380px;
        }

        .toast {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            pointer-events: auto;
            cursor: pointer;
            animation: toast-in 0.3s ease-out;
            border-left: 4px solid #5b9bd5;
        }

        .toast.toast-out {
            animation: toast-out 0.3s ease-in forwards;
        }

        .toast.severity-info { border-left-color: #60a5fa; }
        .toast.severity-warn { border-left-color: #f59e0b; }
        .toast.severity-error { border-left-color: #e74c3c; }
        .toast.severity-critical {
            border-left-color: #dc2626;
            animation: toast-in 0.3s ease-out, critical-pulse 2s ease-in-out infinite;
        }
        .toast.severity-critical.toast-out {
            animation: toast-out 0.3s ease-in forwards;
        }

        .toast-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .toast-message {
            font-size: 0.78rem;
            color: #a0b0c0;
            line-height: 1.3;
        }

        @keyframes toast-in {
            from {
                opacity: 0;
                transform: translateX(40px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toast-out {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(40px);
            }
        }

        @keyframes critical-pulse {
            0%, 100% { box-shadow: 0 4px 16px rgba(0,0,0,0.4); }
            50% { box-shadow: 0 4px 16px rgba(220, 38, 38, 0.4), 0 0 8px rgba(220, 38, 38, 0.2); }
        }

        /* --- File Transfer Section --- */
        .file-transfer-section {
            margin-bottom: 2rem;
        }

        .ft-forms {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .ft-form {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 1rem 1.25rem;
        }

        .ft-form h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #8ab4d6;
            margin-bottom: 0.75rem;
        }

        .ft-form-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .ft-form select,
        .ft-form input[type="text"] {
            background: #0f1923;
            border: 1px solid #2a3a4a;
            border-radius: 4px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
            outline: none;
        }

        .ft-form select:focus,
        .ft-form input[type="text"]:focus {
            border-color: #5b9bd5;
        }

        .ft-form input[type="text"]::placeholder {
            color: #4a5a6a;
        }

        .ft-form select {
            cursor: pointer;
        }

        .ft-form input[type="file"] {
            font-size: 0.8rem;
            color: #a0b0c0;
        }

        .ft-form input[type="file"]::file-selector-button {
            background: #2a3a4a;
            border: 1px solid #3a5a7a;
            border-radius: 4px;
            color: #8ab4d6;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .ft-form input[type="file"]::file-selector-button:hover {
            background: #3a5a7a;
        }

        .ft-btn {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.4rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .ft-btn:hover { background: #3b82f6; }
        .ft-btn:disabled { opacity: 0.4; cursor: default; }

        .ft-btn.secondary {
            background: #2a3a4a;
            border-color: #3a5a7a;
            color: #8ab4d6;
        }

        .ft-btn.secondary:hover { background: #3a5a7a; }

        .ft-active-transfers {
            margin-bottom: 1rem;
        }

        .ft-transfer-card {
            background: #1a2332;
            border: 1px solid #2a3a4a;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
        }

        .ft-transfer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .ft-transfer-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ft-direction {
            font-size: 0.85rem;
        }

        .ft-direction.upload { color: #5b9bd5; }
        .ft-direction.download { color: #f59e0b; }

        .ft-filename {
            font-size: 0.85rem;
            font-weight: 600;
            color: #e0e0e0;
        }

        .ft-meta {
            font-size: 0.75rem;
            color: #6a7a8a;
            font-family: monospace;
        }

        .ft-status-badge {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
        }

        .ft-status-badge.active {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .ft-status-badge.completed {
            background: rgba(0, 214, 114, 0.15);
            color: #00d672;
        }

        .ft-status-badge.failed {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .ft-status-badge.cancelled {
            background: rgba(106, 122, 138, 0.15);
            color: #6a7a8a;
        }

        .ft-progress-bar {
            height: 6px;
            background: #0f1923;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.4rem;
        }

        .ft-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
            background: #3b82f6;
        }

        .ft-progress-fill.completed { background: #00d672; }
        .ft-progress-fill.failed { background: #e74c3c; }

        .ft-error {
            font-size: 0.75rem;
            color: #e74c3c;
            margin-top: 0.3rem;
        }

        .ft-cancel-btn {
            background: none;
            border: 1px solid #4a5a6a;
            border-radius: 4px;
            color: #6a7a8a;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            cursor: pointer;
        }

        .ft-cancel-btn:hover {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        .ft-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .ft-empty {
            text-align: center;
            padding: 1.5rem;
            color: #4a5a6a;
            font-size: 0.85rem;
        }

        @media (max-width: 640px) {
            .ft-forms {
                grid-template-columns: 1fr;
            }
        }

        /* --- Responsive --- */
        @media (max-width: 640px) {
            header {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .kill-switch-bar {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .agent-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo"><span>CAM</span> Dashboard</div>
        <div style="display:flex;align-items:center;gap:1rem;">
            <div class="notification-wrapper">
                <button class="notification-bell" id="notification-bell" onclick="toggleNotificationDropdown()" title="Notifications">
                    <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                    <span class="badge hidden" id="notification-badge">0</span>
                </button>
                <div class="notification-dropdown" id="notification-dropdown">
                    <div class="notification-dropdown-header">
                        <h3>Notifications</h3>
                        <button class="notification-mark-all" onclick="dismissAllNotifications()">Mark all read</button>
                    </div>
                    <div class="notification-list" id="notification-list">
                        <div class="notification-empty">No notifications yet.</div>
                    </div>
                </div>
            </div>
            <div class="telegram-status" id="telegram-status" title="Telegram Bot">
                <div class="tg-dot" id="tg-status-dot"></div>
                <span>Telegram</span>
            </div>
            <div class="connection-status">
                <div class="status-dot" id="ws-status-dot"></div>
                <span id="ws-status-text">Connecting...</span>
            </div>
        </div>
    </header>

    <div class="kill-switch-bar">
        <div>
            <button class="kill-switch-btn" id="kill-switch-btn" onclick="killSwitch()">
                Kill Switch
            </button>
            <span class="kill-switch-label"> â€” halt all agents</span>
        </div>
        <span class="kill-switch-status" id="kill-switch-status">ALL AGENTS HALTED</span>
    </div>

    <main>
        <section class="task-section">
            <h2>Task Queue</h2>

            <div class="task-submit-form">
                <input type="text" id="task-input" placeholder="Describe a task..." autocomplete="off"
                    onkeydown="if(event.key==='Enter')submitTask()">
                <select id="task-complexity">
                    <option value="low">LOW</option>
                    <option value="medium">MEDIUM</option>
                    <option value="high">HIGH</option>
                </select>
                <input type="text" id="task-capabilities" placeholder="Capabilities (comma-separated)" autocomplete="off"
                    style="max-width:220px" onkeydown="if(event.key==='Enter')submitTask()">
                <button class="task-submit-btn" onclick="submitTask()">Submit</button>
            </div>

            <div class="task-stats" id="task-stats">
                <div class="task-stat"><span class="label">Pending</span> <span class="value pending" id="stat-pending">0</span></div>
                <div class="task-stat"><span class="label">Running</span> <span class="value running" id="stat-running">0</span></div>
                <div class="task-stat"><span class="label">Completed</span> <span class="value completed" id="stat-completed">0</span></div>
                <div class="task-stat"><span class="label">Failed</span> <span class="value failed" id="stat-failed">0</span></div>
            </div>

            <div class="task-active-panel hidden" id="task-active-panel">
                <div class="task-active-header">
                    <span class="task-active-title" id="task-active-title"></span>
                    <span class="task-active-id" id="task-active-id"></span>
                </div>
                <div class="oati-phases" id="oati-phases">
                    <div class="oati-phase" data-phase="OBSERVE">Observe</div>
                    <div class="oati-phase" data-phase="THINK">Think</div>
                    <div class="oati-phase" data-phase="ACT">Act</div>
                    <div class="oati-phase" data-phase="ITERATE">Iterate</div>
                </div>
                <div class="task-active-detail" id="task-active-detail"></div>
            </div>

            <div class="task-history" id="task-history">
                <div class="task-empty-state">No tasks yet. Submit one above.</div>
            </div>
        </section>

        <section class="chain-section">
            <h2>Task Chains</h2>

            <div class="chain-builder">
                <div class="chain-builder-header">
                    <input type="text" id="chain-name-input" placeholder="Chain name..." autocomplete="off">
                    <button class="chain-builder-btn" onclick="addChainStep()">+ Add Step</button>
                    <button class="chain-builder-btn" onclick="loadTestChain()">Load Test Chain</button>
                    <button class="chain-builder-btn primary" id="chain-submit-btn" onclick="submitChain()">Submit Chain</button>
                </div>
                <div class="chain-step-rows" id="chain-step-rows">
                    <!-- Dynamic step rows rendered here -->
                </div>
            </div>

            <div class="chain-list" id="chain-list">
                <div class="chain-empty">No chains yet. Build one above or click "Load Test Chain" to try it out.</div>
            </div>
        </section>

        <section class="schedule-section">
            <h2>Task Scheduler</h2>

            <div class="schedule-builder">
                <div class="schedule-builder-row">
                    <input type="text" id="sched-name" placeholder="Schedule name..." autocomplete="off">
                    <input type="text" id="sched-desc" placeholder="Task description (command)..." autocomplete="off">
                </div>
                <div class="schedule-builder-row">
                    <label>Type:</label>
                    <select id="sched-type" onchange="onScheduleTypeChange()">
                        <option value="interval">Interval</option>
                        <option value="once">Once</option>
                        <option value="daily">Daily</option>
                    </select>
                    <label>Complexity:</label>
                    <select id="sched-complexity">
                        <option value="low">LOW</option>
                        <option value="medium">MEDIUM</option>
                        <option value="high">HIGH</option>
                    </select>
                    <span id="sched-interval-group">
                        <label>Every:</label>
                        <input type="number" id="sched-interval" class="schedule-interval-input" value="300" min="10" step="10"> <label>sec</label>
                    </span>
                    <span id="sched-time-group" style="display:none;">
                        <label>At (UTC):</label>
                        <input type="text" id="sched-time" class="schedule-time-input" value="09:00" placeholder="HH:MM">
                    </span>
                    <input type="text" id="sched-caps" placeholder="Capabilities (comma-sep)..." style="max-width:180px" autocomplete="off">
                    <button class="schedule-builder-btn" onclick="createSchedule()">Create</button>
                </div>
            </div>

            <div id="schedule-list">
                <div class="schedule-empty">No scheduled tasks yet.</div>
            </div>
        </section>

        <section class="content-section">
            <h2>Content Calendar</h2>

            <div class="content-builder">
                <div class="content-builder-row">
                    <input type="text" id="content-title" placeholder="Content title..." autocomplete="off">
                    <input type="text" id="content-desc" placeholder="Description (optional)..." autocomplete="off">
                </div>
                <div class="content-builder-row">
                    <label>Type:</label>
                    <select id="content-type">
                        <option value="general">General</option>
                        <option value="script_outline">Script Outline</option>
                        <option value="video">Video</option>
                        <option value="episode_description">Episode Description</option>
                        <option value="research">Research</option>
                    </select>
                    <label>Date:</label>
                    <input type="date" id="content-date">
                    <button class="content-builder-btn" onclick="createContentEntry()">Add</button>
                </div>
            </div>

            <div id="content-list">
                <div class="content-empty">No content entries yet.</div>
            </div>
        </section>

        <section class="command-palette-section">
            <h2>Command Palette</h2>

            <div class="command-palette-form">
                <select id="cmd-select" onchange="onCommandSelect()">
                    <option value="">-- Select command --</option>
                </select>
                <select id="cmd-agent-select">
                    <option value="">-- Select agent --</option>
                </select>
                <button class="command-execute-btn" id="cmd-execute-btn" onclick="executeCommand()" disabled>Execute</button>
            </div>
            <div class="command-description" id="cmd-description"></div>
            <div class="command-params" id="cmd-params"></div>
            <div class="command-result-panel" id="cmd-result-panel"></div>
        </section>

        <section class="file-transfer-section">
            <h2>File Transfer</h2>

            <div class="ft-forms">
                <div class="ft-form">
                    <h3>Send File to Agent</h3>
                    <div class="ft-form-row">
                        <select id="ft-send-agent">
                            <option value="">-- Select agent --</option>
                        </select>
                    </div>
                    <div class="ft-form-row">
                        <input type="file" id="ft-send-file">
                    </div>
                    <div class="ft-form-row">
                        <input type="text" id="ft-send-dest" placeholder="Dest path (optional, e.g. ~/receive/file.txt)" style="flex:1;">
                    </div>
                    <div class="ft-form-row">
                        <button class="ft-btn" onclick="sendFile()" id="ft-send-btn">Send</button>
                    </div>
                </div>

                <div class="ft-form">
                    <h3>Request File from Agent</h3>
                    <div class="ft-form-row">
                        <select id="ft-request-agent">
                            <option value="">-- Select agent --</option>
                        </select>
                    </div>
                    <div class="ft-form-row">
                        <input type="text" id="ft-request-path" placeholder="Remote file path (e.g. ~/logs/cam.log)" style="flex:1;">
                    </div>
                    <div class="ft-form-row">
                        <button class="ft-btn secondary" onclick="requestFile()" id="ft-request-btn">Request</button>
                    </div>
                </div>
            </div>

            <div class="ft-active-transfers" id="ft-active-transfers"></div>
            <div class="ft-history" id="ft-history"></div>
        </section>

        <section class="memory-section">
            <h2>Memory Status</h2>
            <div class="memory-cards">
                <div class="memory-card">
                    <span class="card-label">Short-Term Messages</span>
                    <span class="card-value memory-accent" id="mem-stm-count">0</span>
                    <div class="memory-usage-bar">
                        <div class="memory-usage-fill" id="mem-stm-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="memory-card">
                    <span class="card-label">STM Capacity</span>
                    <span class="card-value" id="mem-stm-max">0</span>
                </div>
                <div class="memory-card">
                    <span class="card-label">Summaries</span>
                    <span class="card-value" id="mem-stm-summaries">0</span>
                </div>
                <div class="memory-card">
                    <span class="card-label">Working Memory Tasks</span>
                    <span class="card-value memory-working" id="mem-wm-count">0</span>
                </div>
            </div>
            <div class="memory-working-list" id="mem-working-list">
                <h3>Active Working Memory Entries</h3>
                <div id="mem-working-entries">
                    <div class="analytics-empty">No active tasks in working memory.</div>
                </div>
            </div>
            <div class="memory-ltm-section" id="mem-ltm-section">
                <h3>Long-Term Memory <span class="ltm-badge" id="mem-ltm-total">0</span></h3>
                <div class="ltm-cards">
                    <div class="ltm-card">
                        <div class="ltm-card-label">Knowledge</div>
                        <div class="ltm-card-value" id="mem-ltm-knowledge">0</div>
                    </div>
                    <div class="ltm-card">
                        <div class="ltm-card-label">Task Results</div>
                        <div class="ltm-card-value" id="mem-ltm-task-result">0</div>
                    </div>
                    <div class="ltm-card">
                        <div class="ltm-card-label">Preferences</div>
                        <div class="ltm-card-value" id="mem-ltm-preference">0</div>
                    </div>
                    <div class="ltm-card">
                        <div class="ltm-card-label">Learnings</div>
                        <div class="ltm-card-value" id="mem-ltm-learning">0</div>
                    </div>
                </div>
                <div class="ltm-status" id="mem-ltm-status"></div>
            </div>
            <div class="memory-episodic-section" id="mem-episodic-section">
                <h3>Episodic Memory <span class="episodic-badge" id="mem-episodic-total">0</span></h3>
                <div class="episodic-cards">
                    <div class="episodic-card">
                        <div class="episodic-card-label">Today</div>
                        <div class="episodic-card-value" id="mem-episodic-today">0</div>
                    </div>
                    <div class="episodic-card">
                        <div class="episodic-card-label">Oldest</div>
                        <div class="episodic-card-value" id="mem-episodic-oldest">--</div>
                    </div>
                    <div class="episodic-card">
                        <div class="episodic-card-label">Newest</div>
                        <div class="episodic-card-value" id="mem-episodic-newest">--</div>
                    </div>
                </div>
                <div class="episodic-search">
                    <input type="text" id="episodic-search-input" placeholder="Search conversation history..." />
                    <button onclick="searchEpisodes()">Search</button>
                </div>
                <div class="episodic-results" id="episodic-results"></div>
                <div class="episodic-status" id="mem-episodic-status"></div>
            </div>
        </section>

        <section class="analytics-section">
            <h2>Analytics</h2>
            <div class="analytics-stats" id="analytics-stats">
                <div class="analytics-card">
                    <span class="card-label">Total Tasks</span>
                    <span class="card-value" id="an-total-tasks">0</span>
                </div>
                <div class="analytics-card">
                    <span class="card-label">Success Rate</span>
                    <span class="card-value success" id="an-success-rate">--</span>
                </div>
                <div class="analytics-card">
                    <span class="card-label">Avg Completion</span>
                    <span class="card-value" id="an-avg-completion">--</span>
                </div>
                <div class="analytics-card">
                    <span class="card-label">Total Model Cost</span>
                    <span class="card-value cost" id="an-model-cost">$0.00</span>
                </div>
                <div class="analytics-card">
                    <span class="card-label">Model Calls</span>
                    <span class="card-value accent" id="an-model-calls">0</span>
                </div>
                <div class="analytics-card">
                    <span class="card-label">Total Tokens</span>
                    <span class="card-value" id="an-total-tokens">0</span>
                </div>
            </div>
            <div class="analytics-bar-chart" id="analytics-bar-chart">
                <h3>Tasks per Agent</h3>
                <div id="agent-bar-chart">
                    <div class="analytics-empty">No task data yet.</div>
                </div>
            </div>
        </section>

        <section class="event-log-section">
            <div class="event-log-header">
                <h2>Activity Log</h2>
                <div class="event-log-actions">
                    <button class="event-log-btn" onclick="clearEventLog()">Clear</button>
                    <button class="event-log-btn" onclick="exportEventLog()">Export</button>
                </div>
            </div>
            <div class="event-log-container" id="event-log">
                <div class="event-empty">No events yet. Activity will appear here.</div>
            </div>
        </section>

        <section class="persona-section" id="persona-section">
            <div class="persona-header">
                <h2>Persona</h2>
                <button class="persona-reload-btn" onclick="reloadPersona()">Reload persona.yaml</button>
            </div>
            <div id="persona-identity" class="persona-card">
                <div class="analytics-empty">Waiting for persona data...</div>
            </div>
            <div id="persona-prompt-card" class="persona-card" style="display:none;">
                <h3 style="margin:0 0 0.5rem;font-size:0.95rem;color:#c9d1d9;">System Prompt Preview</h3>
                <div class="persona-prompt-preview" id="persona-prompt-text"></div>
                <div class="persona-token-estimate" id="persona-token-estimate"></div>
            </div>
        </section>

        <section class="settings-section">
            <div class="settings-header">
                <h2>Settings</h2>
                <div class="settings-actions">
                    <span class="settings-last-loaded" id="settings-last-loaded"></span>
                    <button class="settings-reload-btn" onclick="reloadConfig()">Reload Config</button>
                </div>
            </div>
            <div class="settings-grid" id="settings-grid">
                <div class="analytics-empty">Waiting for config...</div>
            </div>
        </section>

        <h2>Agent Status Board</h2>
        <div id="agent-board">
            <!-- Agent cards rendered here by JS -->
        </div>
    </main>

    <div class="toast-container" id="toast-container"></div>

    <script>
        // ---------------------------------------------------------------
        // State
        // ---------------------------------------------------------------
        let agents = [];
        let ws = null;
        let reconnectTimer = null;

        // Per-agent chat logs: { agent_id: [{type, text}, ...] }
        const chatLogs = {};

        // Notification state
        let notifications = [];
        let unreadCount = 0;

        // Per-agent health metrics: { agent_id: {...metrics} }
        let agentHealth = {};

        // Command library from server
        let commandLibrary = [];
        // Track pending command palette execution: { agent_id, command_name }
        let pendingCommand = null;

        // File transfer state
        let fileTransfers = [];  // all transfers (active + history)

        const board = document.getElementById("agent-board");
        const statusDot = document.getElementById("ws-status-dot");
        const statusText = document.getElementById("ws-status-text");

        // ---------------------------------------------------------------
        // WebSocket connection
        // ---------------------------------------------------------------
        function connect() {
            const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/dashboard`);

            ws.onopen = () => {
                statusDot.classList.add("connected");
                statusText.textContent = "Connected";
                // Clear any pending reconnect
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === "agent_status") {
                    agents = data.agents;
                    renderAgents();
                } else if (data.type === "kill_switch") {
                    setKillSwitchState(data.active);
                } else if (data.type === "command_response") {
                    addChatMessage(data.agent_id, "received", data.response);
                    // Also route to command palette result if this is our pending command
                    if (pendingCommand && data.agent_id === pendingCommand.agent_id) {
                        showCommandResult(data.response, false);
                        pendingCommand = null;
                    }
                } else if (data.type === "task_status") {
                    handleTaskStatus(data);
                } else if (data.type === "task_phase") {
                    handleTaskPhase(data);
                } else if (data.type === "task_submitted") {
                    // Confirmation â€” could show a toast, for now just log
                    if (!data.ok) console.warn("Task submit failed:", data.error);
                } else if (data.type === "health_status") {
                    agentHealth = data.health || {};
                    renderAgents();
                } else if (data.type === "ping_result") {
                    handlePingResult(data);
                } else if (data.type === "event_log") {
                    handleEventLog(data.events || []);
                } else if (data.type === "event") {
                    handleNewEvent(data.event);
                } else if (data.type === "analytics") {
                    handleAnalytics(data.data);
                } else if (data.type === "command_library") {
                    commandLibrary = data.commands || [];
                    renderCommandSelect();
                } else if (data.type === "command_execute_result") {
                    handleCommandExecuteResult(data);
                } else if (data.type === "config") {
                    handleConfig(data);
                } else if (data.type === "chain_status") {
                    handleChainStatus(data);
                } else if (data.type === "chain_submitted") {
                    if (!data.ok) console.warn("Chain submit failed:", data.error);
                } else if (data.type === "notification") {
                    handleNewNotification(data.notification, data.unread_count);
                } else if (data.type === "notification_history") {
                    handleNotificationHistory(data.notifications, data.unread_count);
                } else if (data.type === "notification_count") {
                    unreadCount = data.unread_count;
                    updateNotificationBadge();
                } else if (data.type === "content_calendar_status") {
                    handleContentCalendarStatus(data);
                } else if (data.type === "content_entry_created") {
                    if (!data.ok) console.warn("Content entry create failed:", data.error);
                } else if (data.type === "content_entry_deleted") {
                    if (!data.ok) console.warn("Content entry delete failed:", data.error);
                } else if (data.type === "content_entry_updated") {
                    if (!data.ok) console.warn("Content entry update failed:", data.error);
                } else if (data.type === "schedule_status") {
                    handleScheduleStatus(data);
                } else if (data.type === "schedule_created") {
                    if (!data.ok) console.warn("Schedule create failed:", data.error);
                } else if (data.type === "schedule_deleted") {
                    if (!data.ok) console.warn("Schedule delete failed:", data.error);
                } else if (data.type === "schedule_toggled") {
                    if (!data.ok) console.warn("Schedule toggle failed:", data.error);
                } else if (data.type === "schedule_updated") {
                    if (!data.ok) console.warn("Schedule update failed:", data.error);
                } else if (data.type === "file_transfer_progress") {
                    handleTransferProgress(data);
                } else if (data.type === "file_transfer_history") {
                    handleTransferHistory(data);
                } else if (data.type === "memory_status") {
                    handleMemoryStatus(data);
                } else if (data.type === "episodic_search_results") {
                    handleEpisodicSearchResults(data);
                } else if (data.type === "persona") {
                    handlePersona(data);
                } else if (data.type === "telegram_status") {
                    const dot = document.getElementById("tg-status-dot");
                    if (dot) {
                        data.connected ? dot.classList.add("connected") : dot.classList.remove("connected");
                    }
                }
            };

            ws.onclose = () => {
                statusDot.classList.remove("connected");
                statusText.textContent = "Disconnected â€” retrying...";
                // Auto-reconnect after 3 seconds
                reconnectTimer = setTimeout(connect, 3000);
            };

            ws.onerror = () => {
                // onclose will fire after this, which handles reconnect
                ws.close();
            };
        }

        // ---------------------------------------------------------------
        // Render agent cards
        // ---------------------------------------------------------------
        function renderAgents() {
            if (agents.length === 0) {
                board.innerHTML = `
                    <div class="empty-state">
                        <h3>No agents connected</h3>
                        <p>Agents will appear here when they connect via WebSocket.<br>
                        Endpoint: <code>ws://&lt;dashboard-ip&gt;:8080/ws/agent/&lt;agent-id&gt;</code></p>
                    </div>
                `;
                return;
            }

            // Save any in-progress input text before re-render
            const savedInputs = {};
            document.querySelectorAll(".chat-input").forEach(input => {
                if (input.value) {
                    savedInputs[input.dataset.agentId] = input.value;
                }
            });

            // Sort: online agents first, then alphabetical by name
            const sorted = [...agents].sort((a, b) => {
                if (a.status !== b.status) return a.status === "online" ? -1 : 1;
                return a.name.localeCompare(b.name);
            });

            board.innerHTML = '<div class="agent-grid">' +
                sorted.map(agent => agentCard(agent)).join("") +
                '</div>';

            // Restore saved input text
            for (const [agentId, value] of Object.entries(savedInputs)) {
                const input = document.querySelector(`.chat-input[data-agent-id="${agentId}"]`);
                if (input) input.value = value;
            }

            // Auto-scroll chat logs to bottom
            document.querySelectorAll(".chat-log").forEach(log => {
                log.scrollTop = log.scrollHeight;
            });
        }

        function agentCard(agent) {
            const isOnline = agent.status === "online" || agent.status === "busy";
            const statusClass = agent.status === "busy" ? "busy" : (isOnline ? "online" : "offline");
            const agentId = agent.agent_id;
            const messages = chatLogs[agentId] || [];

            // Render chat message history
            const chatHtml = messages.map(m => {
                const prefix = m.type === "sent" ? "you>" : "agent>";
                const cssClass = m.type === "error" ? "error" : m.type;
                return `<div class="chat-msg ${cssClass}"><span class="chat-prefix">${prefix}</span>${escapeHtml(m.text)}</div>`;
            }).join("");

            return `
                <div class="agent-card">
                    <div class="agent-card-header">
                        <div class="agent-name">${escapeHtml(agent.name)}</div>
                        <div class="agent-status-badge ${statusClass}">
                            <div class="dot"></div>
                            ${agent.status}
                        </div>
                    </div>
                    <div class="agent-details">
                        <div class="agent-detail">
                            <span class="label">IP Address</span>
                            <span class="value">${escapeHtml(agent.ip_address)}</span>
                        </div>
                        <div class="agent-detail">
                            <span class="label">Uptime</span>
                            <span class="value">${formatUptime(agent.connected_at, isOnline)}</span>
                        </div>
                        <div class="agent-detail">
                            <span class="label">Heartbeats</span>
                            <span class="value">${agent.heartbeat_count ?? 0}</span>
                        </div>
                        <div class="agent-detail">
                            <span class="label">Last Seen</span>
                            <span class="value">${formatTime(agent.last_heartbeat)}</span>
                        </div>
                    </div>
                    ${renderHealthSection(agentId, isOnline)}
                    ${renderCapabilities(agent.capabilities)}
                    <div class="agent-chat">
                        <div class="chat-log" id="chat-log-${agentId}">${chatHtml}</div>
                        <div class="chat-input-row">
                            <input type="text"
                                class="chat-input"
                                data-agent-id="${agentId}"
                                placeholder="Send command..."
                                onkeydown="if(event.key==='Enter')sendCommand('${agentId}')"
                                ${isOnline ? "" : "disabled"}>
                            <button class="chat-send-btn"
                                onclick="sendCommand('${agentId}')"
                                ${isOnline ? "" : "disabled"}>Send</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ---------------------------------------------------------------
        // Kill switch
        // ---------------------------------------------------------------
        let killSwitchActive = false;

        function killSwitch() {
            if (killSwitchActive) return;
            // Confirmation â€” this is a big red button, make sure they mean it
            if (!confirm("KILL SWITCH: This will shut down ALL connected agents immediately.\n\nAre you sure?")) {
                return;
            }
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "kill_switch" }));
            }
        }

        function setKillSwitchState(active) {
            killSwitchActive = active;
            const btn = document.getElementById("kill-switch-btn");
            const status = document.getElementById("kill-switch-status");
            if (active) {
                btn.classList.add("activated");
                btn.textContent = "Kill Switch Active";
                status.classList.add("active");
            } else {
                btn.classList.remove("activated");
                btn.textContent = "Kill Switch";
                status.classList.remove("active");
            }
        }

        // ---------------------------------------------------------------
        // Agent commands
        // ---------------------------------------------------------------
        function sendCommand(agentId) {
            const input = document.querySelector(`.chat-input[data-agent-id="${agentId}"]`);
            if (!input) return;
            const text = input.value.trim();
            if (!text) return;

            // Show the sent message in the chat log
            addChatMessage(agentId, "sent", text);

            // Send to server for routing to the agent
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "command",
                    agent_id: agentId,
                    command: text,
                }));
            }

            input.value = "";
            input.focus();
        }

        function addChatMessage(agentId, type, text) {
            // type: "sent", "received", or "error"
            if (!chatLogs[agentId]) chatLogs[agentId] = [];
            chatLogs[agentId].push({ type, text });

            // Keep last 50 messages per agent to avoid unbounded growth
            if (chatLogs[agentId].length > 50) {
                chatLogs[agentId] = chatLogs[agentId].slice(-50);
            }

            // Update the chat log in the DOM directly (avoid full re-render)
            const logEl = document.getElementById(`chat-log-${agentId}`);
            if (logEl) {
                const prefix = type === "sent" ? "you>" : "agent>";
                const cssClass = type === "error" ? "error" : type;
                const msgEl = document.createElement("div");
                msgEl.className = `chat-msg ${cssClass}`;
                msgEl.innerHTML = `<span class="chat-prefix">${prefix}</span>${escapeHtml(text)}`;
                logEl.appendChild(msgEl);
                logEl.scrollTop = logEl.scrollHeight;
            }
        }

        // ---------------------------------------------------------------
        // Agent health
        // ---------------------------------------------------------------
        function renderHealthSection(agentId, isOnline) {
            const h = agentHealth[agentId];
            if (!h) return "";

            const level = h.health_level || "green";
            const levelLabels = { green: "Healthy", yellow: "Degraded", red: "Unhealthy" };
            const missed = h.missed_heartbeats || 0;
            const latency = h.heartbeat_latency_ms != null ? `${h.heartbeat_latency_ms}ms` : "\u2014";
            const completed = h.tasks_completed || 0;
            const failed = h.tasks_failed || 0;
            const active = h.active_tasks || 0;
            const rate = h.success_rate != null ? h.success_rate : 100;
            const rtt = h.last_ping_rtt_ms != null ? `${h.last_ping_rtt_ms}ms` : "\u2014";

            const barColor = rate >= 75 ? "green" : (rate >= 50 ? "yellow" : "red");

            return `
                <div class="agent-health">
                    <div class="health-indicator">
                        <div class="health-dot ${level}"></div>
                        <span class="health-label ${level}">${levelLabels[level]}</span>
                    </div>
                    <div class="health-row">
                        <span class="label">HB Latency</span>
                        <span class="value">${latency}</span>
                    </div>
                    <div class="health-row">
                        <span class="label">Missed HBs</span>
                        <span class="value${missed > 0 ? ' warn' : ''}">${missed}</span>
                    </div>
                    <div class="health-row">
                        <span class="label">Tasks</span>
                        <span class="value">${completed} ok / ${failed} fail</span>
                    </div>
                    <div class="health-row">
                        <span class="label">Load</span>
                        <span class="value">${active} active</span>
                    </div>
                    <div class="health-row">
                        <span class="label">Success Rate</span>
                        <span class="value">${rate.toFixed(0)}%</span>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-bar-fill ${barColor}" style="width:${rate}%"></div>
                    </div>
                    <div class="ping-row">
                        <button class="ping-btn"
                            onclick="pingAgent('${agentId}')"
                            ${isOnline ? '' : 'disabled'}
                            id="ping-btn-${agentId}">Ping</button>
                        <span class="ping-result" id="ping-result-${agentId}">${rtt !== "\u2014" ? rtt : ""}</span>
                    </div>
                </div>
            `;
        }

        function pingAgent(agentId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: "ping_agent", agent_id: agentId }));

            // Show pinging state
            const resultEl = document.getElementById(`ping-result-${agentId}`);
            if (resultEl) resultEl.textContent = "pinging...";
            const btn = document.getElementById(`ping-btn-${agentId}`);
            if (btn) btn.disabled = true;

            // Re-enable after 5s timeout
            setTimeout(() => {
                if (btn) btn.disabled = false;
                if (resultEl && resultEl.textContent === "pinging...") {
                    resultEl.textContent = "timeout";
                }
            }, 5000);
        }

        function handlePingResult(data) {
            const agentId = data.agent_id;
            const resultEl = document.getElementById(`ping-result-${agentId}`);
            const btn = document.getElementById(`ping-btn-${agentId}`);

            if (resultEl) {
                if (data.error) {
                    resultEl.textContent = data.error;
                } else if (data.rtt_ms != null) {
                    resultEl.textContent = `${data.rtt_ms}ms`;
                }
            }
            if (btn) btn.disabled = false;
        }

        // ---------------------------------------------------------------
        // Utility functions
        // ---------------------------------------------------------------
        function formatTime(isoString) {
            if (!isoString) return "\u2014";
            const date = new Date(isoString);
            const now = new Date();
            const diffSec = Math.floor((now - date) / 1000);

            if (diffSec < 5) return "just now";
            if (diffSec < 60) return `${diffSec}s ago`;
            if (diffSec < 3600) return `${Math.floor(diffSec / 60)}m ${diffSec % 60}s ago`;
            if (diffSec < 86400) {
                const h = Math.floor(diffSec / 3600);
                const m = Math.floor((diffSec % 3600) / 60);
                return `${h}h ${m}m ago`;
            }
            return date.toLocaleString();
        }

        function formatUptime(isoString, isOnline) {
            if (!isoString) return "\u2014";
            if (!isOnline) return "offline";
            const date = new Date(isoString);
            const now = new Date();
            const diffSec = Math.floor((now - date) / 1000);

            if (diffSec < 60) return `${diffSec}s`;
            if (diffSec < 3600) {
                const m = Math.floor(diffSec / 60);
                const s = diffSec % 60;
                return `${m}m ${s}s`;
            }
            const h = Math.floor(diffSec / 3600);
            const m = Math.floor((diffSec % 3600) / 60);
            if (h < 24) return `${h}h ${m}m`;
            const d = Math.floor(h / 24);
            return `${d}d ${h % 24}h`;
        }

        function renderCapabilities(caps) {
            if (!caps || caps.length === 0) return "";
            const badges = caps.map(c =>
                `<span class="capability-badge">${escapeHtml(c)}</span>`
            ).join("");
            return `<div class="agent-capabilities">${badges}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }

        // ---------------------------------------------------------------
        // Event Log
        // ---------------------------------------------------------------
        let eventLog = [];
        const MAX_DISPLAY_EVENTS = 500;

        function handleEventLog(events) {
            eventLog = events;
            renderEventLog();
        }

        function handleNewEvent(event) {
            eventLog.push(event);
            // Trim oldest if over limit
            if (eventLog.length > MAX_DISPLAY_EVENTS) {
                eventLog = eventLog.slice(-MAX_DISPLAY_EVENTS);
            }
            appendEventEntry(event);
        }

        function renderEventLog() {
            const container = document.getElementById("event-log");
            if (eventLog.length === 0) {
                container.innerHTML = '<div class="event-empty">No events yet. Activity will appear here.</div>';
                return;
            }
            container.innerHTML = eventLog.map(e => eventEntryHtml(e)).join("");
            container.scrollTop = container.scrollHeight;
        }

        function appendEventEntry(event) {
            const container = document.getElementById("event-log");
            // Remove empty state if present
            const empty = container.querySelector(".event-empty");
            if (empty) empty.remove();

            const wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 40;

            const div = document.createElement("div");
            div.className = "event-entry";
            div.innerHTML = eventEntryInner(event);
            container.appendChild(div);

            // Auto-scroll only if user was already at the bottom
            if (wasAtBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function eventEntryHtml(event) {
            return `<div class="event-entry">${eventEntryInner(event)}</div>`;
        }

        function eventEntryInner(event) {
            const time = formatEventTime(event.timestamp);
            const sev = (event.severity || "INFO").toLowerCase();
            const cat = event.category || "";
            const msg = event.message || "";
            const msgClass = sev === "error" ? " error" : (sev === "warn" ? " warn" : "");
            return `<span class="event-time">${time}</span>`
                + `<span class="event-severity ${sev}">${event.severity}</span>`
                + `<span class="event-category">[${escapeHtml(cat)}]</span>`
                + `<span class="event-message${msgClass}">${escapeHtml(msg)}</span>`;
        }

        function formatEventTime(isoString) {
            if (!isoString) return "";
            const d = new Date(isoString);
            return d.toLocaleTimeString("en-US", { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
        }

        function clearEventLog() {
            eventLog = [];
            renderEventLog();
        }

        function exportEventLog() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            fetch("/api/events/export", { method: "POST" })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        alert(`Exported ${data.event_count} events to ${data.filepath}`);
                    }
                })
                .catch(err => console.error("Export failed:", err));
        }

        // ---------------------------------------------------------------
        // Task Queue
        // ---------------------------------------------------------------
        let tasks = [];
        let taskCounts = { pending: 0, running: 0, completed: 0, failed: 0 };
        let activePhase = null;   // { task_id, phase, detail }
        let phaseClearTimer = null;

        function submitTask() {
            const input = document.getElementById("task-input");
            const select = document.getElementById("task-complexity");
            const capsInput = document.getElementById("task-capabilities");
            const desc = input.value.trim();
            if (!desc) return;

            const caps = capsInput.value
                .split(",")
                .map(s => s.trim())
                .filter(s => s.length > 0);

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "task_submit",
                    description: desc,
                    complexity: select.value,
                    required_capabilities: caps,
                }));
            }
            input.value = "";
            capsInput.value = "";
            input.focus();
        }

        function handleTaskStatus(data) {
            tasks = data.tasks || [];
            taskCounts = data.counts || taskCounts;
            renderTaskStats();
            renderTaskHistory();
        }

        function handleTaskPhase(data) {
            // Clear any pending phase-clear timer
            if (phaseClearTimer) {
                clearTimeout(phaseClearTimer);
                phaseClearTimer = null;
            }

            activePhase = {
                task_id: data.task_id,
                short_id: data.short_id,
                phase: data.phase,
                detail: data.detail || "",
            };
            renderActiveTask();

            // Clear the phase indicator 3s after terminal states
            if (data.phase === "COMPLETED" || data.phase === "FAILED") {
                phaseClearTimer = setTimeout(() => {
                    activePhase = null;
                    renderActiveTask();
                }, 3000);
            }
        }

        function renderTaskStats() {
            document.getElementById("stat-pending").textContent = taskCounts.pending || 0;
            document.getElementById("stat-running").textContent = taskCounts.running || 0;
            document.getElementById("stat-completed").textContent = taskCounts.completed || 0;
            document.getElementById("stat-failed").textContent = taskCounts.failed || 0;
        }

        function renderActiveTask() {
            const panel = document.getElementById("task-active-panel");
            if (!activePhase) {
                panel.classList.add("hidden");
                return;
            }

            panel.classList.remove("hidden");

            // Find the task description from our list
            const task = tasks.find(t => t.task_id === activePhase.task_id);
            document.getElementById("task-active-title").textContent =
                task ? task.description : activePhase.short_id;
            document.getElementById("task-active-id").textContent = activePhase.short_id;

            // Update OATI phase boxes
            const phaseOrder = ["OBSERVE", "THINK", "ACT", "ITERATE"];
            const currentIdx = phaseOrder.indexOf(activePhase.phase);
            const isFinal = activePhase.phase === "COMPLETED" || activePhase.phase === "FAILED";

            document.querySelectorAll("#oati-phases .oati-phase").forEach(el => {
                const phaseName = el.dataset.phase;
                const idx = phaseOrder.indexOf(phaseName);
                el.className = "oati-phase";

                if (isFinal) {
                    // All phases complete â€” mark them green or red
                    el.classList.add(activePhase.phase === "COMPLETED" ? "done" : "failed");
                } else if (idx < currentIdx) {
                    el.classList.add("done");
                } else if (idx === currentIdx) {
                    el.classList.add("active");
                }
            });

            document.getElementById("task-active-detail").textContent = activePhase.detail;
        }

        function renderTaskHistory() {
            const container = document.getElementById("task-history");
            if (tasks.length === 0) {
                container.innerHTML = '<div class="task-empty-state">No tasks yet. Submit one above.</div>';
                return;
            }

            container.innerHTML = tasks.map(t => {
                const resultHtml = t.result
                    ? `<div class="task-result">${escapeHtml(String(t.result))}</div>`
                    : "";

                const timeStr = t.completed_at
                    ? formatTime(t.completed_at)
                    : formatTime(t.created_at);

                const caps = (t.required_capabilities || []);
                const capBadges = caps.length > 0
                    ? caps.map(c => `<span class="capability-badge">${escapeHtml(c)}</span>`).join("")
                    : "";

                return `
                    <div class="task-item">
                        <div class="task-item-header">
                            <div class="task-item-left">
                                <span class="task-id">${escapeHtml(t.short_id)}</span>
                                <span class="task-status-badge ${t.status}">${t.status}</span>
                                <span class="task-status-badge" style="background:rgba(91,155,213,0.1);color:#5b9bd5">${escapeHtml(t.complexity)}</span>
                                ${capBadges}
                            </div>
                            <span class="task-meta">${escapeHtml(t.source)} &middot; ${timeStr}</span>
                        </div>
                        <div class="task-description">${escapeHtml(t.description)}</div>
                        ${resultHtml}
                    </div>
                `;
            }).join("");
        }

        // Update relative timestamps every 5 seconds (uptime + last seen + tasks)
        setInterval(() => {
            if (agents.length > 0) renderAgents();
            if (tasks.length > 0) renderTaskHistory();
        }, 5000);

        // ---------------------------------------------------------------
        // Memory Status
        // ---------------------------------------------------------------

        function handleMemoryStatus(data) {
            const stm = data.short_term || {};
            const wm = data.working || {};
            const ltm = data.long_term || {};

            // Short-term memory cards
            const stmCount = stm.message_count || 0;
            const stmMax = stm.max_messages || 0;
            const stmPct = stm.usage_pct || 0;
            const summaries = stm.summary_count || 0;

            document.getElementById("mem-stm-count").textContent = stmCount;
            document.getElementById("mem-stm-max").textContent = stmMax;
            document.getElementById("mem-stm-summaries").textContent = summaries;

            // Usage bar with color thresholds
            const bar = document.getElementById("mem-stm-bar");
            bar.style.width = stmPct + "%";
            bar.className = "memory-usage-fill";
            if (stmPct > 90) bar.classList.add("critical");
            else if (stmPct > 70) bar.classList.add("warning");

            // Working memory
            const wmCount = wm.active_count || 0;
            const wmEntries = wm.entries || [];
            document.getElementById("mem-wm-count").textContent = wmCount;

            // Render working memory entries
            const container = document.getElementById("mem-working-entries");
            if (wmEntries.length === 0) {
                container.innerHTML = '<div class="analytics-empty">No active tasks in working memory.</div>';
            } else {
                container.innerHTML = wmEntries.map(e => `
                    <div class="memory-working-entry">
                        <span class="entry-desc" title="${e.description || ''}">${e.short_id} â€” ${e.description || 'Unknown'}</span>
                        <span class="entry-phase">${e.phase || '?'}</span>
                    </div>
                `).join("");
            }

            // Long-term memory
            const ltmTotal = ltm.total_count || 0;
            const ltmCounts = ltm.counts_by_category || {};
            const ltmInitialized = ltm.initialized || false;
            const ltmError = ltm.error || null;

            document.getElementById("mem-ltm-total").textContent = ltmTotal;
            document.getElementById("mem-ltm-knowledge").textContent = ltmCounts.knowledge || 0;
            document.getElementById("mem-ltm-task-result").textContent = ltmCounts.task_result || 0;
            document.getElementById("mem-ltm-preference").textContent = ltmCounts.user_preference || 0;
            document.getElementById("mem-ltm-learning").textContent = ltmCounts.system_learning || 0;

            const statusEl = document.getElementById("mem-ltm-status");
            if (ltmError) {
                statusEl.textContent = "Error: " + ltmError;
                statusEl.className = "ltm-status error";
            } else if (ltmInitialized) {
                statusEl.textContent = "Collection: " + (ltm.collection_name || "cam_long_term");
                statusEl.className = "ltm-status";
            } else {
                statusEl.textContent = "Not initialized";
                statusEl.className = "ltm-status";
            }

            // Episodic memory
            const ep = data.episodic || {};
            document.getElementById("mem-episodic-total").textContent = ep.total_count || 0;
            document.getElementById("mem-episodic-today").textContent = ep.count_today || 0;

            // Format oldest/newest as short dates
            const oldest = ep.oldest_timestamp;
            const newest = ep.newest_timestamp;
            document.getElementById("mem-episodic-oldest").textContent =
                oldest ? new Date(oldest).toLocaleDateString() : "--";
            document.getElementById("mem-episodic-newest").textContent =
                newest ? new Date(newest).toLocaleDateString() : "--";

            const epStatus = document.getElementById("mem-episodic-status");
            epStatus.textContent = "Retention: " + (ep.retention_days || 365) + " days";
        }

        function searchEpisodes() {
            const input = document.getElementById("episodic-search-input");
            const keyword = (input.value || "").trim();
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({
                type: "episodic_search",
                keyword: keyword,
                limit: 50,
            }));
        }

        function handleEpisodicSearchResults(data) {
            const container = document.getElementById("episodic-results");
            const episodes = data.episodes || [];

            if (episodes.length === 0) {
                container.innerHTML = '<div class="analytics-empty">No episodes found.</div>';
                return;
            }

            container.innerHTML = episodes.map(ep => {
                const time = new Date(ep.timestamp);
                const timeStr = time.toLocaleString(undefined, {
                    month: "short", day: "numeric",
                    hour: "2-digit", minute: "2-digit",
                });
                const participant = ep.participant || "system";
                const content = (ep.content || "").substring(0, 200);
                return `
                    <div class="episodic-entry">
                        <span class="episodic-participant ${participant}">${participant}</span>
                        <span class="episodic-content" title="${ep.content || ''}">${content}</span>
                        <span class="episodic-time">${timeStr}</span>
                    </div>
                `;
            }).join("");
        }

        // Enter key triggers episodic search
        document.getElementById("episodic-search-input")
            .addEventListener("keydown", function(e) {
                if (e.key === "Enter") searchEpisodes();
            });

        // Analytics
        // ---------------------------------------------------------------
        let analyticsData = null;

        function handleAnalytics(data) {
            analyticsData = data;
            renderAnalytics();
        }

        function renderAnalytics() {
            if (!analyticsData) return;
            const d = analyticsData;

            document.getElementById("an-total-tasks").textContent = formatNumber(d.total_tasks);
            document.getElementById("an-success-rate").textContent =
                d.total_tasks > 0 ? d.success_rate.toFixed(1) + "%" : "--";
            document.getElementById("an-avg-completion").textContent =
                d.total_tasks > 0 ? formatDuration(d.avg_completion_seconds) : "--";
            document.getElementById("an-model-cost").textContent = "$" + d.total_model_cost_usd.toFixed(4);
            document.getElementById("an-model-calls").textContent = formatNumber(d.total_model_calls);
            document.getElementById("an-total-tokens").textContent = formatNumber(d.total_model_tokens);

            renderAgentBarChart(d.tasks_per_agent || {});
        }

        function renderAgentBarChart(agentTasks) {
            const container = document.getElementById("agent-bar-chart");
            const entries = Object.entries(agentTasks);

            if (entries.length === 0) {
                container.innerHTML = '<div class="analytics-empty">No task data yet.</div>';
                return;
            }

            // Sort by count descending
            entries.sort((a, b) => b[1] - a[1]);
            const maxCount = entries[0][1];

            container.innerHTML = entries.map(([agent, count]) => {
                const pct = maxCount > 0 ? (count / maxCount) * 100 : 0;
                return `
                    <div class="bar-row">
                        <span class="bar-label" title="${escapeHtml(agent)}">${escapeHtml(agent)}</span>
                        <div class="bar-track">
                            <div class="bar-fill" style="width:${pct}%"></div>
                        </div>
                        <span class="bar-count">${count}</span>
                    </div>
                `;
            }).join("");
        }

        function formatDuration(seconds) {
            if (seconds == null || seconds === 0) return "--";
            if (seconds < 60) return seconds.toFixed(1) + "s";
            const m = Math.floor(seconds / 60);
            const s = Math.round(seconds % 60);
            return m + "m " + s + "s";
        }

        function formatNumber(n) {
            if (n == null) return "0";
            if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
            if (n >= 1000) return (n / 1000).toFixed(1) + "K";
            return String(n);
        }

        // ---------------------------------------------------------------
        // Command Palette
        // ---------------------------------------------------------------
        function renderCommandSelect() {
            const select = document.getElementById("cmd-select");
            // Keep the placeholder option
            select.innerHTML = '<option value="">-- Select command --</option>';
            commandLibrary.forEach(cmd => {
                const opt = document.createElement("option");
                opt.value = cmd.name;
                opt.textContent = cmd.name.replace(/_/g, " ");
                select.appendChild(opt);
            });
            updateCommandExecuteBtn();
        }

        function renderAgentSelect() {
            const select = document.getElementById("cmd-agent-select");
            const prev = select.value;
            select.innerHTML = '<option value="">-- Select agent --</option>';
            agents.filter(a => a.status === "online" || a.status === "busy").forEach(a => {
                const opt = document.createElement("option");
                opt.value = a.agent_id;
                opt.textContent = a.name + (a.status === "busy" ? " (busy)" : "");
                select.appendChild(opt);
            });
            // Restore previous selection if still valid
            if (prev && select.querySelector(`option[value="${prev}"]`)) {
                select.value = prev;
            }
            updateCommandExecuteBtn();
        }

        function onCommandSelect() {
            const cmdName = document.getElementById("cmd-select").value;
            const descEl = document.getElementById("cmd-description");
            const paramsEl = document.getElementById("cmd-params");

            if (!cmdName) {
                descEl.textContent = "";
                paramsEl.innerHTML = "";
                updateCommandExecuteBtn();
                return;
            }

            const cmd = commandLibrary.find(c => c.name === cmdName);
            if (!cmd) return;

            descEl.textContent = cmd.description;

            // Render parameter inputs
            if (cmd.parameters && cmd.parameters.length > 0) {
                paramsEl.innerHTML = cmd.parameters.map(p => {
                    const placeholder = p.required ? "required" : (p.default || "optional");
                    return `
                        <div class="command-param-group">
                            <label>${escapeHtml(p.name)}:</label>
                            <input type="text"
                                data-param="${escapeHtml(p.name)}"
                                placeholder="${escapeHtml(placeholder)}"
                                value="${p.default && !p.required ? escapeHtml(p.default) : ''}">
                        </div>
                    `;
                }).join("");
            } else {
                paramsEl.innerHTML = "";
            }
            updateCommandExecuteBtn();
        }

        function updateCommandExecuteBtn() {
            const cmdName = document.getElementById("cmd-select").value;
            const agentId = document.getElementById("cmd-agent-select").value;
            const btn = document.getElementById("cmd-execute-btn");

            // Check required params are filled
            let paramsOk = true;
            if (cmdName) {
                const cmd = commandLibrary.find(c => c.name === cmdName);
                if (cmd && cmd.parameters) {
                    cmd.parameters.filter(p => p.required).forEach(p => {
                        const input = document.querySelector(`#cmd-params input[data-param="${p.name}"]`);
                        if (!input || !input.value.trim()) paramsOk = false;
                    });
                }
            }

            btn.disabled = !cmdName || !agentId || !paramsOk;
        }

        function executeCommand() {
            const cmdName = document.getElementById("cmd-select").value;
            const agentId = document.getElementById("cmd-agent-select").value;
            if (!cmdName || !agentId) return;

            // Gather params
            const params = {};
            document.querySelectorAll("#cmd-params input[data-param]").forEach(input => {
                const val = input.value.trim();
                if (val) params[input.dataset.param] = val;
            });

            // Show pending state in result panel
            const panel = document.getElementById("cmd-result-panel");
            panel.classList.add("visible");
            panel.innerHTML = `<div class="result-header">${escapeHtml(cmdName)} â†’ ${escapeHtml(agentId)}</div>`
                + `<div class="result-pending">Waiting for response...</div>`;

            // Track this as pending so we can route the response
            pendingCommand = { agent_id: agentId, command_name: cmdName };

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "command_execute",
                    command_name: cmdName,
                    agent_id: agentId,
                    params: params,
                }));
            }
        }

        function handleCommandExecuteResult(data) {
            if (!data.ok) {
                showCommandResult(data.error || "Command failed", true);
                pendingCommand = null;
            }
            // If ok, we wait for the command_response broadcast from the agent
        }

        function showCommandResult(text, isError) {
            const panel = document.getElementById("cmd-result-panel");
            const header = panel.querySelector(".result-header");
            const headerText = header ? header.textContent : "";
            panel.classList.add("visible");
            panel.innerHTML = `<div class="result-header">${escapeHtml(headerText)}</div>`
                + `<div class="${isError ? 'result-error' : ''}">${escapeHtml(text)}</div>`;
        }

        // Update agent dropdown whenever agents change
        const _origRenderAgents = renderAgents;
        renderAgents = function() {
            _origRenderAgents();
            renderAgentSelect();
        };

        // Also listen for param input changes to update execute button
        document.getElementById("cmd-params").addEventListener("input", updateCommandExecuteBtn);
        document.getElementById("cmd-agent-select").addEventListener("change", updateCommandExecuteBtn);

        // ---------------------------------------------------------------
        // Task Chains
        // ---------------------------------------------------------------
        let chains = [];
        let chainBuilderSteps = [];

        function handleChainStatus(data) {
            chains = data.chains || [];
            renderChains();
        }

        function renderChains() {
            const container = document.getElementById("chain-list");
            if (chains.length === 0) {
                container.innerHTML = '<div class="chain-empty">No chains yet. Build one above or click "Load Test Chain" to try it out.</div>';
                return;
            }

            container.innerHTML = chains.map(chain => {
                const status = chain.status;
                const current = chain.current_step;
                const total = chain.total_steps;
                const pct = total > 0 ? Math.round((countCompletedSteps(chain) / total) * 100) : 0;
                const progressClass = status === "failed" ? "failed" : (status === "completed" ? "completed" : "running");

                const stepsHtml = chain.steps.map((step, i) => {
                    let stepClass = "";
                    if (step.status === "completed") {
                        stepClass = "done";
                    } else if (step.status === "failed") {
                        stepClass = "failed";
                    } else if (step.status === "running") {
                        stepClass = "active";
                    }
                    const label = "Step " + (i + 1);
                    return `<div class="chain-step ${stepClass}" title="${escapeHtml(step.description.substring(0, 100))}">${label}</div>`;
                }).join("");

                return `
                    <div class="chain-card">
                        <div class="chain-card-header">
                            <div class="chain-card-left">
                                <span class="chain-card-name">${escapeHtml(chain.name)}</span>
                                <span class="chain-card-id">${escapeHtml(chain.short_id)}</span>
                            </div>
                            <span class="chain-status-badge ${status}">${status}</span>
                        </div>
                        <div class="chain-progress-bar">
                            <div class="chain-progress-fill ${progressClass}" style="width:${pct}%"></div>
                        </div>
                        <div class="chain-steps">${stepsHtml}</div>
                    </div>
                `;
            }).join("");
        }

        function countCompletedSteps(chain) {
            return chain.steps.filter(s => s.status === "completed").length;
        }

        function addChainStep() {
            chainBuilderSteps.push({ description: "", complexity: "low", capabilities: "" });
            renderChainBuilder();
        }

        function removeChainStep(i) {
            chainBuilderSteps.splice(i, 1);
            renderChainBuilder();
        }

        function renderChainBuilder() {
            const container = document.getElementById("chain-step-rows");
            if (chainBuilderSteps.length === 0) {
                container.innerHTML = "";
                return;
            }

            container.innerHTML = chainBuilderSteps.map((step, i) => `
                <div class="chain-step-row">
                    <span class="chain-step-num">${i + 1}</span>
                    <input type="text" placeholder="Step description..."
                        value="${escapeHtml(step.description)}"
                        oninput="chainBuilderSteps[${i}].description=this.value">
                    <select onchange="chainBuilderSteps[${i}].complexity=this.value">
                        <option value="low" ${step.complexity === "low" ? "selected" : ""}>LOW</option>
                        <option value="medium" ${step.complexity === "medium" ? "selected" : ""}>MEDIUM</option>
                        <option value="high" ${step.complexity === "high" ? "selected" : ""}>HIGH</option>
                    </select>
                    <input type="text" placeholder="Capabilities..."
                        value="${escapeHtml(step.capabilities || "")}"
                        oninput="chainBuilderSteps[${i}].capabilities=this.value"
                        style="max-width:140px">
                    <button class="chain-step-remove" onclick="removeChainStep(${i})" title="Remove step">&times;</button>
                </div>
            `).join("");
        }

        function submitChain() {
            const nameInput = document.getElementById("chain-name-input");
            const name = nameInput.value.trim();
            if (!name) { nameInput.focus(); return; }
            if (chainBuilderSteps.length === 0) return;

            // Validate steps have descriptions
            const validSteps = chainBuilderSteps.filter(s => s.description.trim());
            if (validSteps.length === 0) return;

            const steps = validSteps.map(s => ({
                description: s.description.trim(),
                complexity: s.complexity,
                required_capabilities: s.capabilities
                    ? s.capabilities.split(",").map(c => c.trim()).filter(c => c)
                    : [],
            }));

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "chain_submit",
                    name: name,
                    steps: steps,
                }));
            }

            // Clear builder
            nameInput.value = "";
            chainBuilderSteps = [];
            renderChainBuilder();
        }

        function loadTestChain() {
            document.getElementById("chain-name-input").value = "System Info â†’ Analyze â†’ Summarize";
            chainBuilderSteps = [
                {
                    description: "system_info",
                    complexity: "low",
                    capabilities: "system_info",
                },
                {
                    description: "Analyze the following system information and identify any potential issues, resource bottlenecks, or notable observations.",
                    complexity: "medium",
                    capabilities: "",
                },
                {
                    description: "Summarize the analysis into 3-5 concise bullet points suitable for a status report.",
                    complexity: "low",
                    capabilities: "",
                },
            ];
            renderChainBuilder();
        }

        // ---------------------------------------------------------------
        // Task Scheduler
        // ---------------------------------------------------------------
        let schedules = [];

        function handleScheduleStatus(data) {
            schedules = data.schedules || [];
            renderSchedules();
        }

        function onScheduleTypeChange() {
            const type = document.getElementById("sched-type").value;
            document.getElementById("sched-interval-group").style.display =
                type === "interval" ? "" : "none";
            document.getElementById("sched-time-group").style.display =
                type === "daily" ? "" : "none";
        }

        function createSchedule() {
            const nameInput = document.getElementById("sched-name");
            const descInput = document.getElementById("sched-desc");
            const name = nameInput.value.trim();
            const description = descInput.value.trim();
            if (!name) { nameInput.focus(); return; }
            if (!description) { descInput.focus(); return; }

            const schedule_type = document.getElementById("sched-type").value;
            const complexity = document.getElementById("sched-complexity").value;
            const interval_seconds = parseInt(document.getElementById("sched-interval").value) || 300;
            const run_at_time = document.getElementById("sched-time").value.trim() || "09:00";
            const capsStr = document.getElementById("sched-caps").value.trim();
            const required_capabilities = capsStr
                ? capsStr.split(",").map(c => c.trim()).filter(c => c)
                : [];

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "schedule_create",
                    name, description, complexity, schedule_type,
                    interval_seconds, run_at_time, required_capabilities,
                }));
            }

            // Clear form
            nameInput.value = "";
            descInput.value = "";
            document.getElementById("sched-caps").value = "";
        }

        function toggleSchedule(id) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "schedule_toggle", schedule_id: id }));
            }
        }

        function deleteSchedule(id) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "schedule_delete", schedule_id: id }));
            }
        }

        function formatScheduleTime(isoStr) {
            if (!isoStr) return "â€”";
            try {
                const d = new Date(isoStr);
                return d.toLocaleTimeString("en-US", {
                    hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit"
                }) + " " + d.toLocaleDateString("en-US", { month: "short", day: "numeric" });
            } catch (e) {
                return isoStr;
            }
        }

        function renderSchedules() {
            const container = document.getElementById("schedule-list");
            if (schedules.length === 0) {
                container.innerHTML = '<div class="schedule-empty">No scheduled tasks yet.</div>';
                return;
            }

            container.innerHTML = schedules.map(s => {
                const enabledClass = s.enabled ? "on" : "off";
                const enabledLabel = s.enabled ? "Enabled" : "Disabled";
                const cardClass = s.enabled ? "" : " disabled";
                const toggleLabel = s.enabled ? "Disable" : "Enable";
                const typeLabel = s.schedule_type.toUpperCase();

                let timingInfo = "";
                if (s.schedule_type === "interval") {
                    timingInfo = "Every " + s.interval_seconds + "s";
                } else if (s.schedule_type === "daily") {
                    timingInfo = "Daily at " + escapeHtml(s.run_at_time) + " UTC";
                } else {
                    timingInfo = "One-time";
                }

                return `
                    <div class="schedule-card${cardClass}">
                        <div class="schedule-card-header">
                            <div class="schedule-card-left">
                                <span class="schedule-card-name">${escapeHtml(s.name)}</span>
                                <span class="schedule-card-id">${escapeHtml(s.short_id)}</span>
                                <span class="schedule-enabled-badge ${enabledClass}">${enabledLabel}</span>
                                <span class="schedule-type-badge">${typeLabel}</span>
                            </div>
                            <div class="schedule-card-actions">
                                <button class="schedule-card-btn" onclick="toggleSchedule('${s.schedule_id}')">${toggleLabel}</button>
                                <button class="schedule-card-btn danger" onclick="deleteSchedule('${s.schedule_id}')">Delete</button>
                            </div>
                        </div>
                        <div class="schedule-card-meta">
                            <span>${timingInfo}</span>
                            <span>Runs: ${s.run_count}</span>
                            <span>Next: ${formatScheduleTime(s.next_run_at)}</span>
                            <span>Last: ${formatScheduleTime(s.last_run_at)}</span>
                        </div>
                    </div>
                `;
            }).join("");
        }

        // ---------------------------------------------------------------
        // Content Calendar
        // ---------------------------------------------------------------
        let contentEntries = [];

        const CONTENT_STATUS_ORDER = {
            idea: 0, planned: 1, in_progress: 2, review: 3, published: 4, archived: 5,
        };

        function handleContentCalendarStatus(data) {
            contentEntries = data.entries || [];
            renderContentCalendar();
        }

        function createContentEntry() {
            const titleInput = document.getElementById("content-title");
            const descInput = document.getElementById("content-desc");
            const title = titleInput.value.trim();
            const description = descInput.value.trim();
            if (!title) { titleInput.focus(); return; }

            const content_type = document.getElementById("content-type").value;
            const scheduled_date = document.getElementById("content-date").value || null;

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "content_entry_create",
                    title, description, content_type, scheduled_date,
                }));
            }

            // Clear form
            titleInput.value = "";
            descInput.value = "";
            document.getElementById("content-date").value = "";
        }

        function updateContentStatus(entryId, newStatus) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "content_entry_update",
                    entry_id: entryId,
                    status: newStatus,
                }));
            }
        }

        function deleteContentEntry(entryId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "content_entry_delete",
                    entry_id: entryId,
                }));
            }
        }

        function renderContentCalendar() {
            const container = document.getElementById("content-list");
            if (contentEntries.length === 0) {
                container.innerHTML = '<div class="content-empty">No content entries yet.</div>';
                return;
            }

            // Sort by status priority (active first), then by updated_at
            const sorted = [...contentEntries].sort((a, b) => {
                const sa = CONTENT_STATUS_ORDER[a.status] ?? 9;
                const sb = CONTENT_STATUS_ORDER[b.status] ?? 9;
                if (sa !== sb) return sa - sb;
                return (b.updated_at || "").localeCompare(a.updated_at || "");
            });

            const statuses = ["idea", "planned", "in_progress", "review", "published", "archived"];

            container.innerHTML = sorted.map(e => {
                const typeLabel = (e.content_type || "general").replace(/_/g, " ").toUpperCase();
                const statusClass = e.status || "idea";
                const statusLabel = (e.status || "idea").replace(/_/g, " ");

                let dateInfo = "";
                if (e.scheduled_date) {
                    dateInfo = `<span>Target: ${escapeHtml(e.scheduled_date)}</span>`;
                }

                const statusOptions = statuses.map(s => {
                    const sel = s === e.status ? " selected" : "";
                    const label = s.replace(/_/g, " ");
                    return `<option value="${s}"${sel}>${label}</option>`;
                }).join("");

                return `
                    <div class="content-card">
                        <div class="content-card-header">
                            <div class="content-card-left">
                                <span class="content-card-title">${escapeHtml(e.title)}</span>
                                <span class="content-card-id">${escapeHtml(e.short_id)}</span>
                                <span class="content-status-badge ${statusClass}">${statusLabel}</span>
                                <span class="content-type-badge">${typeLabel}</span>
                            </div>
                            <div class="content-card-actions">
                                <select onchange="updateContentStatus('${e.entry_id}', this.value)">
                                    ${statusOptions}
                                </select>
                                <button class="content-card-btn danger" onclick="deleteContentEntry('${e.entry_id}')">Delete</button>
                            </div>
                        </div>
                        <div class="content-card-meta">
                            ${e.description ? `<span>${escapeHtml(e.description.substring(0, 100))}</span>` : ""}
                            ${dateInfo}
                        </div>
                    </div>
                `;
            }).join("");
        }

        // ---------------------------------------------------------------
        // Settings Panel
        // ---------------------------------------------------------------
        let currentConfig = null;
        let configLastLoaded = "";

        function handleConfig(data) {
            currentConfig = data.config;
            configLastLoaded = data.last_loaded;
            renderSettings();
        }

        function renderSettings() {
            if (!currentConfig) return;

            // Update last-loaded timestamp
            const loadedEl = document.getElementById("settings-last-loaded");
            if (configLastLoaded) {
                const d = new Date(configLastLoaded);
                loadedEl.textContent = "Loaded: " + d.toLocaleTimeString("en-US", {
                    hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit"
                });
            }

            const grid = document.getElementById("settings-grid");
            grid.innerHTML = "";

            // Render each top-level section as a card
            for (const [section, values] of Object.entries(currentConfig)) {
                const card = document.createElement("div");
                card.className = "settings-card";

                let heading = `<h3>${escapeHtml(section)}</h3>`;
                let rows = renderConfigRows(values, "");

                card.innerHTML = heading + rows;
                grid.appendChild(card);
            }
        }

        function renderConfigRows(obj, prefix) {
            let html = "";
            for (const [key, value] of Object.entries(obj)) {
                const fullKey = prefix ? prefix + "." + key : key;
                if (value !== null && typeof value === "object" && !Array.isArray(value)) {
                    // Nested section â€” render inline with dotted keys
                    html += renderConfigRows(value, fullKey);
                } else {
                    html += `<div class="settings-row">
                        <span class="key">${escapeHtml(fullKey)}</span>
                        <span class="val">${escapeHtml(String(value))}</span>
                    </div>`;
                }
            }
            return html;
        }

        function reloadConfig() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "config_reload" }));
            }
        }

        // ---------------------------------------------------------------
        // Persona
        // ---------------------------------------------------------------
        let personaData = null;

        function handlePersona(data) {
            personaData = data.persona;
            renderPersona();
        }

        function renderPersona() {
            if (!personaData) return;
            const p = personaData;

            // Identity card
            const identityEl = document.getElementById("persona-identity");
            const toneTags = (p.tone || []).map(t =>
                `<span class="persona-tag tone">${t}</span>`
            ).join("");
            const domainTags = (p.knowledge_domains || []).map(d =>
                `<span class="persona-tag domain">${d}</span>`
            ).join("");

            identityEl.innerHTML = `
                <div class="persona-name">${p.name || "Cam"}</div>
                <div class="persona-tagline">${p.tagline || ""}</div>
                <div class="persona-role">${p.role || ""}</div>
                ${toneTags ? `<div class="persona-tags">${toneTags}</div>` : ""}
                ${domainTags ? `<div class="persona-tags">${domainTags}</div>` : ""}
            `;

            // Prompt preview card
            const promptCard = document.getElementById("persona-prompt-card");
            const promptText = document.getElementById("persona-prompt-text");
            const tokenEst = document.getElementById("persona-token-estimate");

            if (p.system_prompt) {
                promptCard.style.display = "block";
                promptText.textContent = p.system_prompt;
                tokenEst.textContent = `~${p.prompt_token_estimate || 0} tokens`;
            }
        }

        function reloadPersona() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "persona_reload" }));
            }
        }

        // ---------------------------------------------------------------
        // Notifications
        // ---------------------------------------------------------------
        function handleNewNotification(notif, count) {
            notifications.unshift(notif);
            // Cap local list
            if (notifications.length > 200) notifications = notifications.slice(0, 200);
            unreadCount = count;
            updateNotificationBadge();
            renderNotificationList();
            showToast(notif);
        }

        function handleNotificationHistory(notifs, count) {
            notifications = notifs || [];
            unreadCount = count;
            updateNotificationBadge();
            renderNotificationList();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById("notification-badge");
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? "99+" : String(unreadCount);
                badge.classList.remove("hidden");
            } else {
                badge.classList.add("hidden");
            }
        }

        function toggleNotificationDropdown() {
            const dd = document.getElementById("notification-dropdown");
            dd.classList.toggle("open");
        }

        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
            const wrapper = document.querySelector(".notification-wrapper");
            const dd = document.getElementById("notification-dropdown");
            if (dd.classList.contains("open") && !wrapper.contains(e.target)) {
                dd.classList.remove("open");
            }
        });

        function renderNotificationList() {
            const container = document.getElementById("notification-list");
            if (notifications.length === 0) {
                container.innerHTML = '<div class="notification-empty">No notifications yet.</div>';
                return;
            }

            container.innerHTML = notifications.map(n => {
                const readClass = n.read ? "read" : "unread";
                const time = formatEventTime(n.timestamp);
                return `
                    <div class="notification-item ${readClass}" onclick="dismissNotification('${n.id}')">
                        <div class="notification-item-header">
                            <span class="notification-item-title">
                                <span class="notification-severity-badge ${n.severity}">${n.severity}</span>
                                ${escapeHtml(n.title)}
                            </span>
                            <span class="notification-item-time">${time}</span>
                        </div>
                        <div class="notification-item-message">${escapeHtml(n.message)}</div>
                    </div>
                `;
            }).join("");
        }

        function dismissNotification(id) {
            // Optimistic local update
            const notif = notifications.find(n => n.id === id);
            if (notif && !notif.read) {
                notif.read = true;
                unreadCount = Math.max(0, unreadCount - 1);
                updateNotificationBadge();
                renderNotificationList();
            }
            // Tell server
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "notification_dismiss", id: id }));
            }
        }

        function dismissAllNotifications() {
            // Optimistic local update
            notifications.forEach(n => n.read = true);
            unreadCount = 0;
            updateNotificationBadge();
            renderNotificationList();
            // Tell server
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "notification_dismiss_all" }));
            }
        }

        function showToast(notif) {
            const container = document.getElementById("toast-container");
            const el = document.createElement("div");
            el.className = `toast severity-${notif.severity}`;
            el.innerHTML = `
                <div class="toast-title">
                    <span class="notification-severity-badge ${notif.severity}">${notif.severity}</span>
                    ${escapeHtml(notif.title)}
                </div>
                <div class="toast-message">${escapeHtml(notif.message)}</div>
            `;
            el.onclick = () => removeToast(el);
            container.appendChild(el);

            // Auto-dismiss: 15s for critical, 8s for everything else
            const timeout = notif.severity === "critical" ? 15000 : 8000;
            setTimeout(() => removeToast(el), timeout);
        }

        function removeToast(el) {
            if (!el || !el.parentNode) return;
            el.classList.add("toast-out");
            el.addEventListener("animationend", () => {
                if (el.parentNode) el.parentNode.removeChild(el);
            });
        }

        // ---------------------------------------------------------------
        // File Transfers
        // ---------------------------------------------------------------

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + " B";
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
            return (bytes / (1024 * 1024)).toFixed(1) + " MB";
        }

        function renderFtAgentSelects() {
            ["ft-send-agent", "ft-request-agent"].forEach(id => {
                const select = document.getElementById(id);
                const prev = select.value;
                select.innerHTML = '<option value="">-- Select agent --</option>';
                agents.filter(a => a.status === "online" || a.status === "busy").forEach(a => {
                    const opt = document.createElement("option");
                    opt.value = a.agent_id;
                    opt.textContent = a.name + (a.status === "busy" ? " (busy)" : "");
                    select.appendChild(opt);
                });
                if (prev && select.querySelector(`option[value="${prev}"]`)) {
                    select.value = prev;
                }
            });
        }

        function handleTransferProgress(data) {
            const idx = fileTransfers.findIndex(t => t.transfer_id === data.transfer_id);
            if (idx >= 0) {
                fileTransfers[idx] = data;
            } else {
                fileTransfers.unshift(data);
            }
            renderTransfers();
        }

        function handleTransferHistory(data) {
            fileTransfers = data.transfers || [];
            renderTransfers();
        }

        function renderTransfers() {
            const activeContainer = document.getElementById("ft-active-transfers");
            const historyContainer = document.getElementById("ft-history");

            const active = fileTransfers.filter(t => t.status === "active" || t.status === "pending");
            const done = fileTransfers.filter(t => t.status !== "active" && t.status !== "pending");

            if (active.length === 0 && done.length === 0) {
                activeContainer.innerHTML = "";
                historyContainer.innerHTML = '<div class="ft-empty">No file transfers yet.</div>';
                return;
            }

            activeContainer.innerHTML = active.map(t => renderTransferCard(t, true)).join("");
            historyContainer.innerHTML = done.length > 0
                ? done.map(t => renderTransferCard(t, false)).join("")
                : "";
        }

        function renderTransferCard(t, isActive) {
            const dirArrow = t.direction === "to_agent" ? "\u2191" : "\u2193";
            const dirClass = t.direction === "to_agent" ? "upload" : "download";
            const dirLabel = t.direction === "to_agent" ? "Send" : "Receive";
            const pct = Math.round((t.progress || 0) * 100);
            const fillClass = t.status === "completed" ? "completed" : (t.status === "failed" ? "failed" : "");
            const cancelBtn = isActive
                ? `<button class="ft-cancel-btn" onclick="cancelTransfer('${t.transfer_id}')">Cancel</button>`
                : "";
            const errorHtml = t.error ? `<div class="ft-error">${escapeHtml(t.error)}</div>` : "";
            const sizeStr = t.file_size > 0 ? formatFileSize(t.file_size) : "";
            const chunkStr = t.chunk_count > 0 ? `${t.chunks_done}/${t.chunk_count} chunks` : "";
            const metaParts = [t.agent_name, dirLabel, sizeStr, chunkStr].filter(Boolean);

            return `
                <div class="ft-transfer-card">
                    <div class="ft-transfer-header">
                        <div class="ft-transfer-left">
                            <span class="ft-direction ${dirClass}">${dirArrow}</span>
                            <span class="ft-filename">${escapeHtml(t.filename || "unknown")}</span>
                            <span class="ft-meta">${escapeHtml(metaParts.join(" \u00b7 "))}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <span class="ft-status-badge ${t.status}">${t.status}</span>
                            ${cancelBtn}
                        </div>
                    </div>
                    <div class="ft-progress-bar">
                        <div class="ft-progress-fill ${fillClass}" style="width:${pct}%"></div>
                    </div>
                    ${errorHtml}
                </div>
            `;
        }

        function sendFile() {
            const agentId = document.getElementById("ft-send-agent").value;
            const fileInput = document.getElementById("ft-send-file");
            const destPath = document.getElementById("ft-send-dest").value.trim();

            if (!agentId) { alert("Select an agent first."); return; }
            if (!fileInput.files || fileInput.files.length === 0) { alert("Select a file first."); return; }

            const file = fileInput.files[0];

            if (file.size > 50 * 1024 * 1024) {
                alert("File too large (max 50 MB).");
                return;
            }

            // For files < 1MB, send via WebSocket; for larger files, use HTTP upload
            if (file.size < 1024 * 1024) {
                const reader = new FileReader();
                reader.onload = function() {
                    const arrayBuf = reader.result;
                    const bytes = new Uint8Array(arrayBuf);
                    let binary = "";
                    for (let i = 0; i < bytes.length; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    const b64 = btoa(binary);

                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: "file_send",
                            agent_id: agentId,
                            filename: file.name,
                            dest_path: destPath,
                            data: b64,
                        }));
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // Use HTTP multipart upload
                const formData = new FormData();
                formData.append("file", file);
                formData.append("agent_id", agentId);
                formData.append("dest_path", destPath);

                fetch("/api/file/upload", { method: "POST", body: formData })
                    .then(r => r.json())
                    .then(data => {
                        if (!data.ok) {
                            alert("Upload failed: " + (data.error || "Unknown error"));
                        }
                    })
                    .catch(err => {
                        alert("Upload error: " + err.message);
                    });
            }

            // Clear file input
            fileInput.value = "";
        }

        function requestFile() {
            const agentId = document.getElementById("ft-request-agent").value;
            const filePath = document.getElementById("ft-request-path").value.trim();

            if (!agentId) { alert("Select an agent first."); return; }
            if (!filePath) { alert("Enter a remote file path."); return; }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "file_request_from_agent",
                    agent_id: agentId,
                    file_path: filePath,
                }));
            }
            document.getElementById("ft-request-path").value = "";
        }

        function cancelTransfer(transferId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "file_transfer_cancel",
                    transfer_id: transferId,
                }));
            }
        }

        // Hook into renderAgents to update file transfer agent selects
        const _origRenderAgents2 = renderAgents;
        renderAgents = function() {
            _origRenderAgents2();
            renderFtAgentSelects();
        };

        // ---------------------------------------------------------------
        // Start
        // ---------------------------------------------------------------
        connect();
    </script>
</body>
</html>
