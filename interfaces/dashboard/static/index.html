<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAM Dashboard</title>
    <script>
        // Apply saved theme before CSS loads to prevent flash of wrong theme
        (function() {
            try {
                var t = localStorage.getItem('cam-dashboard-prefs');
                if (t) { t = JSON.parse(t).theme; }
                if (t && t !== 'dark') document.documentElement.setAttribute('data-theme', t);
            } catch(e) {}
        })();
    </script>
    <style>
        /* --- Theme Variables --- */
        :root, [data-theme="dark"] {
            --bg-primary: #0f1923;
            --bg-secondary: #1a2332;
            --bg-tertiary: #2a3a4a;
            --text-primary: #e0e0e0;
            --text-secondary: #6a7a8a;
            --text-tertiary: #4a5a6a;
            --text-value: #c0c8d0;
            --border: #2a3a4a;
            --border-hover: #3a5a7a;
            --primary: #5b9bd5;
            --primary-dim: #3a5a7a;
            --primary-subtle: rgba(91, 155, 213, 0.15);
            --secondary: #8ab4d6;
            --card-bg: #1a2332;
            --success: #00d672;
            --danger: #e74c3c;
            --warning: #f59e0b;
            --info: #3b82f6;
            --shadow: rgba(0, 0, 0, 0.4);
            --btn-bg: #2a3a4a;
            --btn-hover: #3a5a7a;
            --input-bg: #0f1923;
            --accent-purple: #a78bfa;
        }

        [data-theme="light"] {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e4e7eb;
            --text-primary: #1a1a2e;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --text-value: #374151;
            --border: #d1d5db;
            --border-hover: #93c5fd;
            --primary: #2563eb;
            --primary-dim: #3b82f6;
            --primary-subtle: rgba(37, 99, 235, 0.1);
            --secondary: #1d4ed8;
            --card-bg: #ffffff;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #d97706;
            --info: #2563eb;
            --shadow: rgba(0, 0, 0, 0.1);
            --btn-bg: #e5e7eb;
            --btn-hover: #d1d5db;
            --input-bg: #f9fafb;
            --accent-purple: #7c3aed;
        }

        [data-theme="doppler"] {
            --bg-primary: #121218;
            --bg-secondary: #1c1c24;
            --bg-tertiary: #2a2a35;
            --text-primary: #d4d4dc;
            --text-secondary: #7a7a8a;
            --text-tertiary: #55556a;
            --text-value: #c0c0cc;
            --border: #333340;
            --border-hover: #e8731a;
            --primary: #f08c2e;
            --primary-dim: #c06a1a;
            --primary-subtle: rgba(240, 140, 46, 0.15);
            --secondary: #c8c8d0;
            --card-bg: #1c1c24;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #f08c2e;
            --shadow: rgba(0, 0, 0, 0.5);
            --btn-bg: #2a2a35;
            --btn-hover: #3a3a48;
            --input-bg: #121218;
            --accent-purple: #c084fc;
        }

        /* --- Reset & Base --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* --- Header --- */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .logo span {
            color: var(--primary);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #888;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger);
        }

        .status-dot.connected {
            background: var(--success);
        }

        .lock-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            padding: 0.35rem 0.5rem;
            display: flex;
            align-items: center;
            transition: color 0.15s, border-color 0.15s;
        }
        .lock-btn:hover { color: var(--primary); border-color: var(--primary); }

        .telegram-status { display:flex; align-items:center; gap:0.4rem; font-size:0.8rem; color:#888; margin-right:0.5rem; }
        .telegram-status .tg-dot { width:8px; height:8px; border-radius:50%; background:var(--danger); }
        .telegram-status .tg-dot.connected { background:var(--success); }

        /* --- Kill Switch â€” Constitution: "Prominent, always visible" --- */
        .kill-switch-bar {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kill-switch-btn {
            background: #c0392b;
            color: #fff;
            border: 2px solid var(--danger);
            border-radius: 6px;
            padding: 0.6rem 1.5rem;
            font-size: 0.95rem;
            font-weight: 700;
            font-family: inherit;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            cursor: pointer;
            transition: background 0.15s, box-shadow 0.15s;
        }

        .kill-switch-btn:hover {
            background: var(--danger);
            box-shadow: 0 0 12px rgba(231, 76, 60, 0.5);
        }

        .kill-switch-btn:active {
            background: #a93226;
        }

        .kill-switch-btn.activated {
            background: #7f1d1d;
            border-color: #991b1b;
            cursor: default;
            box-shadow: none;
        }

        .kill-switch-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .kill-switch-status {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--danger);
            display: none;
        }

        .kill-switch-status.active {
            display: inline;
        }

        /* --- Main Content --- */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
        }

        h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* --- Agent Grid --- */
        .agent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        /* --- Agent Card --- */
        .agent-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
            transition: border-color 0.2s;
        }

        .agent-card:hover {
            border-color: var(--border-hover);
        }

        .agent-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .agent-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .agent-status-badge {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
        }

        .agent-status-badge.online {
            background: rgba(0, 214, 114, 0.15);
            color: var(--success);
        }

        .agent-status-badge.offline {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }

        .agent-status-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .agent-status-badge.online .dot {
            background: var(--success);
        }

        .agent-status-badge.offline .dot {
            background: var(--danger);
        }

        .agent-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .agent-detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-detail .label {
            color: var(--text-secondary);
        }

        .agent-detail .value {
            color: var(--text-value);
            font-family: monospace;
        }

        /* --- Agent Capabilities --- */
        .agent-capabilities {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-top: 0.5rem;
        }

        .capability-badge {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            background: rgba(91, 155, 213, 0.15);
            color: var(--primary);
        }

        /* --- Agent Chat Log --- */
        .agent-chat {
            margin-top: 0.75rem;
            border-top: 1px solid var(--border);
            padding-top: 0.75rem;
        }

        .chat-log {
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
            font-family: monospace;
            margin-bottom: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .chat-msg {
            padding: 0.25rem 0.4rem;
            border-radius: 4px;
            line-height: 1.4;
            word-break: break-word;
        }

        .chat-msg.sent {
            color: var(--primary);
        }

        .chat-msg.received {
            color: var(--success);
        }

        .chat-msg.error {
            color: var(--danger);
        }

        .chat-msg .chat-prefix {
            font-weight: 600;
            margin-right: 0.3rem;
        }

        .chat-input-row {
            display: flex;
            gap: 0.4rem;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
            outline: none;
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .chat-input::placeholder {
            color: var(--text-tertiary);
        }

        .chat-send-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 4px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .chat-send-btn:hover {
            background: var(--btn-hover);
        }

        .chat-send-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }

        /* --- Task Queue Section --- */
        .task-section {
            margin-bottom: 2rem;
        }

        .task-submit-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .task-submit-form input[type="text"] {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            outline: none;
        }

        .task-submit-form input[type="text"]:focus {
            border-color: var(--primary);
        }

        .task-submit-form input[type="text"]::placeholder {
            color: var(--text-tertiary);
        }

        .task-submit-form select {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.5rem 0.5rem;
            outline: none;
            cursor: pointer;
        }

        .task-submit-btn {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1.2rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .task-submit-btn:hover {
            background: #3b82f6;
        }

        .task-submit-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }

        /* Stats bar */
        .task-stats {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
        }

        .task-stat {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .task-stat .label {
            color: var(--text-secondary);
        }

        .task-stat .value {
            font-weight: 600;
            font-family: monospace;
        }

        .task-stat .value.pending { color: var(--warning); }
        .task-stat .value.running { color: #3b82f6; }
        .task-stat .value.completed { color: var(--success); }
        .task-stat .value.failed { color: var(--danger); }

        /* Active task with OATI phase indicator */
        .task-active-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .task-active-panel.hidden {
            display: none;
        }

        .task-active-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .task-active-title {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .task-active-id {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .oati-phases {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .oati-phase {
            flex: 1;
            text-align: center;
            padding: 0.4rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            background: var(--bg-primary);
            color: #3a4a5a;
            border: 1px solid #1a2a3a;
            transition: all 0.3s;
        }

        .oati-phase.active {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-color: #3b82f6;
            animation: oati-pulse 1.5s ease-in-out infinite;
        }

        .oati-phase.done {
            background: rgba(0, 214, 114, 0.15);
            color: var(--success);
            border-color: var(--success);
            animation: none;
        }

        .oati-phase.failed {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
            border-color: var(--danger);
            animation: none;
        }

        @keyframes oati-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .task-active-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.4rem;
        }

        /* Task history list */
        .task-history {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .task-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
        }

        .task-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .task-item-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .task-id {
            font-size: 0.75rem;
            font-family: monospace;
            color: var(--primary);
        }

        .task-status-badge {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
        }

        .task-status-badge.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .task-status-badge.running {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .task-status-badge.completed {
            background: rgba(0, 214, 114, 0.15);
            color: var(--success);
        }

        .task-status-badge.failed {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }

        .task-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .task-description {
            font-size: 0.85rem;
            color: var(--text-value);
            line-height: 1.4;
        }

        .task-result {
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--bg-primary);
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: monospace;
            color: #a0b0c0;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.4;
        }

        .task-empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-tertiary);
            font-size: 0.9rem;
        }

        /* --- Empty State --- */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-tertiary);
        }

        .empty-state h3 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .empty-state p {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .empty-state code {
            background: var(--bg-secondary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        /* --- Agent Health --- */
        .agent-health {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            font-size: 0.8rem;
        }

        .health-indicator {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .health-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .health-dot.green { background: var(--success); }
        .health-dot.yellow { background: var(--warning); }
        .health-dot.red { background: var(--danger); }

        .health-label {
            font-weight: 600;
            font-size: 0.8rem;
        }

        .health-label.green { color: var(--success); }
        .health-label.yellow { color: var(--warning); }
        .health-label.red { color: var(--danger); }

        .health-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .health-row .label {
            color: var(--text-secondary);
        }

        .health-row .value {
            color: var(--text-value);
            font-family: monospace;
        }

        .health-row .value.warn {
            color: var(--warning);
        }

        .health-bar-container {
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.2rem;
        }

        .health-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        .health-bar-fill.green { background: var(--success); }
        .health-bar-fill.yellow { background: var(--warning); }
        .health-bar-fill.red { background: var(--danger); }

        .ping-row {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 0.2rem;
        }

        .ping-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 4px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .ping-btn:hover {
            background: var(--btn-hover);
        }

        .ping-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .ping-result {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--text-value);
        }

        .agent-status-badge.busy {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .agent-status-badge.busy .dot {
            background: var(--warning);
        }

        /* --- Event Log --- */
        .event-log-section {
            margin-bottom: 2rem;
        }

        .event-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .event-log-header h2 {
            margin-bottom: 0;
        }

        .event-log-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .event-log-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 4px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .event-log-btn:hover {
            background: var(--btn-hover);
        }

        .event-log-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.78rem;
            line-height: 1.5;
        }

        .event-entry {
            padding: 0.3rem 0.75rem;
            border-bottom: 1px solid #1f2d3d;
            display: flex;
            gap: 0.5rem;
            align-items: baseline;
        }

        .event-entry:last-child {
            border-bottom: none;
        }

        .event-time {
            color: var(--text-tertiary);
            flex-shrink: 0;
            font-size: 0.72rem;
        }

        .event-severity {
            font-weight: 700;
            font-size: 0.7rem;
            padding: 0.05rem 0.3rem;
            border-radius: 3px;
            flex-shrink: 0;
            text-transform: uppercase;
        }

        .event-severity.info {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .event-severity.warn {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .event-severity.error {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }

        .event-category {
            color: var(--primary);
            flex-shrink: 0;
            font-size: 0.72rem;
        }

        .event-message {
            color: var(--text-value);
            word-break: break-word;
        }

        .event-message.warn {
            color: var(--warning);
        }

        .event-message.error {
            color: var(--danger);
        }

        .event-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
        }

        /* --- Analytics Section --- */
        .analytics-section {
            margin-bottom: 2rem;
        }

        .analytics-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .analytics-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .analytics-card .card-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .analytics-card .card-value {
            font-size: 1.4rem;
            font-weight: 700;
            font-family: monospace;
            color: var(--text-primary);
        }

        .analytics-card .card-value.accent {
            color: var(--primary);
        }

        .analytics-card .card-value.success {
            color: var(--success);
        }

        .analytics-card .card-value.cost {
            color: var(--warning);
        }

        .analytics-bar-chart {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
        }

        .analytics-bar-chart h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 0.75rem;
        }

        .bar-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .bar-label {
            flex: 0 0 140px;
            font-size: 0.8rem;
            color: var(--text-value);
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bar-track {
            flex: 1;
            height: 20px;
            background: var(--bg-primary);
            border-radius: 4px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.4s ease;
            min-width: 2px;
        }

        .bar-count {
            flex: 0 0 40px;
            font-size: 0.8rem;
            font-family: monospace;
            color: var(--secondary);
        }

        .analytics-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Backup & Recovery Section --- */
        .backup-section {
            margin-bottom: 2rem;
        }

        .backup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .backup-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .backup-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }

        .backup-card .card-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .backup-card .card-value {
            display: block;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .backup-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .backup-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.8rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
        }

        .backup-row .backup-filename {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .backup-row .backup-size {
            color: var(--text-secondary);
            min-width: 60px;
            text-align: right;
        }

        .backup-row .backup-date {
            color: var(--text-secondary);
            min-width: 140px;
            text-align: right;
        }

        .backup-btn {
            padding: 0.3rem 0.7rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: background 0.2s;
        }

        .backup-btn-primary {
            background: var(--primary);
            color: var(--bg-primary);
        }

        .backup-btn-primary:hover {
            background: var(--primary-dim);
        }

        .backup-btn-restore {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .backup-btn-restore:hover {
            background: var(--border);
            color: var(--text-primary);
        }

        /* --- Message Bus Section --- */
        .msgbus-section {
            margin-bottom: 2rem;
        }

        .msgbus-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .msgbus-header h2 {
            margin: 0;
        }

        .msgbus-header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .msgbus-total {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .msgbus-filter {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .msgbus-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .msgbus-stat-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .msgbus-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .msgbus-stat-count {
            font-weight: 600;
            font-size: 1rem;
        }

        .msgbus-ch-task_updates { border-left: 3px solid #3b82f6; }
        .msgbus-ch-content_pipeline { border-left: 3px solid #a855f7; }
        .msgbus-ch-research_results { border-left: 3px solid #22c55e; }
        .msgbus-ch-alerts { border-left: 3px solid #ef4444; }
        .msgbus-ch-system { border-left: 3px solid #6b7280; }

        .msgbus-matrix {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }

        .msgbus-matrix-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        .msgbus-matrix-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0;
            font-size: 0.8rem;
        }

        .msgbus-matrix-sender {
            min-width: 100px;
            font-weight: 500;
        }

        .msgbus-matrix-channels {
            display: flex;
            gap: 0.35rem;
            flex-wrap: wrap;
        }

        .msgbus-matrix-badge {
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .msgbus-badge-task_updates { background: rgba(59,130,246,0.15); color: #60a5fa; }
        .msgbus-badge-content_pipeline { background: rgba(168,85,247,0.15); color: #c084fc; }
        .msgbus-badge-research_results { background: rgba(34,197,94,0.15); color: #4ade80; }
        .msgbus-badge-alerts { background: rgba(239,68,68,0.15); color: #f87171; }
        .msgbus-badge-system { background: rgba(107,114,128,0.15); color: #9ca3af; }

        .msgbus-log {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 6px;
        }

        .msgbus-log-entry {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
        }

        .msgbus-log-entry:last-child {
            border-bottom: none;
        }

        .msgbus-log-time {
            color: var(--text-secondary);
            font-size: 0.7rem;
            min-width: 55px;
            flex-shrink: 0;
        }

        .msgbus-log-sender {
            font-weight: 500;
            min-width: 90px;
            flex-shrink: 0;
        }

        .msgbus-log-channel {
            padding: 0.05rem 0.35rem;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .msgbus-log-payload {
            color: var(--text-secondary);
            font-size: 0.75rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .msgbus-empty {
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding: 1rem;
            text-align: center;
        }

        /* --- Memory Status Section --- */
        .memory-section {
            margin-bottom: 2rem;
        }

        .memory-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .memory-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .memory-card .card-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .memory-card .card-value {
            font-size: 1.4rem;
            font-weight: 700;
            font-family: monospace;
            color: var(--text-primary);
        }

        .memory-card .card-value.memory-accent {
            color: #a78bfa;
        }

        .memory-card .card-value.memory-working {
            color: #34d399;
        }

        .memory-usage-bar {
            height: 6px;
            background: var(--btn-bg);
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .memory-usage-fill {
            height: 100%;
            border-radius: 3px;
            background: #a78bfa;
            transition: width 0.3s ease;
        }

        .memory-usage-fill.warning {
            background: var(--warning);
        }

        .memory-usage-fill.critical {
            background: var(--danger);
        }

        /* --- Context Window Section --- */
        .context-section {
            margin-bottom: 2rem;
        }

        .context-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .context-rotation-info {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            color: #8a9aaa;
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .context-rotation-info span {
            white-space: nowrap;
        }

        .context-rotation-info .rotation-label {
            color: var(--text-secondary);
            margin-right: 0.3rem;
        }

        .memory-working-list {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
        }

        .memory-working-list h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 0.75rem;
        }

        .memory-working-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px solid #1f2d3d;
            font-size: 0.8rem;
        }

        .memory-working-entry:last-child {
            border-bottom: none;
        }

        .memory-working-entry .entry-desc {
            color: var(--text-value);
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 0.75rem;
        }

        .memory-working-entry .entry-phase {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            background: rgba(167, 139, 250, 0.15);
            color: #a78bfa;
        }

        /* --- Long-Term Memory --- */
        .memory-ltm-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-top: 1rem;
        }

        .memory-ltm-section h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ltm-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.1rem 0.5rem;
            border-radius: 10px;
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
        }

        .ltm-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .ltm-card {
            background: #141e2a;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            text-align: center;
        }

        .ltm-card .ltm-card-label {
            font-size: 0.7rem;
            color: #6b7b8d;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .ltm-card .ltm-card-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #60a5fa;
        }

        .ltm-status {
            font-size: 0.7rem;
            color: #6b7b8d;
            margin-top: 0.4rem;
        }

        .ltm-status.error {
            color: #f87171;
        }

        /* --- Episodic Memory --- */
        .memory-episodic-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-top: 1rem;
        }

        .memory-episodic-section h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #d4a054;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .episodic-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.1rem 0.5rem;
            border-radius: 10px;
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .episodic-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .episodic-card {
            background: #141e2a;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.6rem 0.8rem;
            text-align: center;
        }

        .episodic-card .episodic-card-label {
            font-size: 0.7rem;
            color: #6b7b8d;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .episodic-card .episodic-card-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--warning);
        }

        .episodic-search {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .episodic-search input {
            flex: 1;
            background: #141e2a;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.8rem;
        }

        .episodic-search input:focus {
            outline: none;
            border-color: var(--warning);
        }

        .episodic-search button {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.15s;
        }

        .episodic-search button:hover {
            background: rgba(245, 158, 11, 0.25);
        }

        .episodic-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .episodic-entry {
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #1e2d3d;
        }

        .episodic-entry:last-child {
            border-bottom: none;
        }

        .episodic-participant {
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.1rem 0.4rem;
            border-radius: 4px;
            text-transform: uppercase;
            white-space: nowrap;
            min-width: 55px;
            text-align: center;
        }

        .episodic-participant.user {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
        }

        .episodic-participant.assistant {
            background: rgba(52, 211, 153, 0.15);
            color: #34d399;
        }

        .episodic-participant.system {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .episodic-content {
            flex: 1;
            font-size: 0.75rem;
            color: var(--text-value);
            line-height: 1.4;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .episodic-time {
            font-size: 0.65rem;
            color: #6b7b8d;
            white-space: nowrap;
        }

        .episodic-status {
            font-size: 0.7rem;
            color: #6b7b8d;
            margin-top: 0.4rem;
        }

        /* --- Command Palette --- */
        .command-palette-section {
            margin-bottom: 2rem;
        }

        .command-palette-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .command-palette-form select {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.5rem 0.5rem;
            outline: none;
            cursor: pointer;
        }

        .command-palette-form select:focus {
            border-color: var(--primary);
        }

        .command-params {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .command-param-group {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .command-param-group label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .command-param-group input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
            outline: none;
            width: 160px;
        }

        .command-param-group input:focus {
            border-color: var(--primary);
        }

        .command-param-group input::placeholder {
            color: var(--text-tertiary);
        }

        .command-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .command-execute-btn {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1.2rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .command-execute-btn:hover {
            background: #3b82f6;
        }

        .command-execute-btn:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .command-result-panel {
            margin-top: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: monospace;
            color: #a0b0c0;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.4;
            display: none;
        }

        .command-result-panel.visible {
            display: block;
        }

        .command-result-panel .result-header {
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .command-result-panel .result-error {
            color: var(--danger);
        }

        .command-result-panel .result-pending {
            color: var(--warning);
        }

        /* --- Task Chains --- */
        .chain-section {
            margin-bottom: 2rem;
        }

        .chain-builder {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .chain-builder-header {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .chain-builder-header input[type="text"] {
            flex: 1;
            min-width: 200px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            outline: none;
        }

        .chain-builder-header input[type="text"]:focus {
            border-color: var(--primary);
        }

        .chain-builder-header input[type="text"]::placeholder {
            color: var(--text-tertiary);
        }

        .chain-builder-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 6px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .chain-builder-btn:hover {
            background: var(--btn-hover);
        }

        .chain-builder-btn.primary {
            background: #2563eb;
            border-color: #3b82f6;
            color: #fff;
        }

        .chain-builder-btn.primary:hover {
            background: #3b82f6;
        }

        .chain-builder-btn.primary:disabled {
            opacity: 0.4;
            cursor: default;
        }

        .chain-step-rows {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .chain-step-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            background: var(--bg-primary);
            border: 1px solid #1a2a3a;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
        }

        .chain-step-num {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            flex-shrink: 0;
            width: 1.5rem;
            text-align: center;
        }

        .chain-step-row input[type="text"] {
            flex: 1;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.35rem 0.5rem;
            outline: none;
        }

        .chain-step-row input[type="text"]:focus {
            border-color: var(--primary);
        }

        .chain-step-row input[type="text"]::placeholder {
            color: var(--text-tertiary);
        }

        .chain-step-row select {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.8rem;
            padding: 0.35rem 0.3rem;
            outline: none;
            cursor: pointer;
        }

        .chain-step-remove {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            transition: background 0.15s;
            flex-shrink: 0;
        }

        .chain-step-remove:hover {
            background: rgba(231, 76, 60, 0.15);
        }

        /* Chain cards */
        .chain-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chain-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
        }

        .chain-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .chain-card-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chain-card-name {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .chain-card-id {
            font-size: 0.75rem;
            font-family: monospace;
            color: var(--text-secondary);
        }

        .chain-status-badge {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
        }

        .chain-status-badge.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .chain-status-badge.running {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .chain-status-badge.completed {
            background: rgba(0, 214, 114, 0.15);
            color: var(--success);
        }

        .chain-status-badge.failed {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }

        .chain-progress-bar {
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .chain-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s ease, background 0.3s;
        }

        .chain-progress-fill.running {
            background: #3b82f6;
        }

        .chain-progress-fill.completed {
            background: var(--success);
        }

        .chain-progress-fill.failed {
            background: var(--danger);
        }

        .chain-steps {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .chain-step {
            flex: 1;
            min-width: 60px;
            text-align: center;
            padding: 0.35rem 0.4rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--bg-primary);
            color: #3a4a5a;
            border: 1px solid #1a2a3a;
            transition: all 0.3s;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chain-step.active {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-color: #3b82f6;
            animation: oati-pulse 1.5s ease-in-out infinite;
        }

        .chain-step.done {
            background: rgba(0, 214, 114, 0.15);
            color: var(--success);
            border-color: var(--success);
            animation: none;
        }

        .chain-step.failed {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
            border-color: var(--danger);
            animation: none;
        }

        .chain-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Agent Swarm --- */
        .swarm-section {
            margin-bottom: 2rem;
        }
        .swarm-builder {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .swarm-builder-header {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .swarm-builder-header input {
            flex: 1;
            min-width: 140px;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        .swarm-objective {
            width: 100%;
            min-height: 48px;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
            resize: vertical;
            margin-bottom: 0.75rem;
            font-family: inherit;
        }
        .swarm-subtask-row {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            margin-bottom: 0.4rem;
        }
        .swarm-subtask-row input {
            flex: 1;
            padding: 0.35rem 0.5rem;
            border-radius: 6px;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.8rem;
        }
        .swarm-subtask-row select {
            width: 90px;
            padding: 0.35rem 0.3rem;
            border-radius: 6px;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.8rem;
        }
        .swarm-subtask-row .swarm-caps-input {
            width: 120px;
        }
        .swarm-subtask-row button {
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
        }
        .swarm-subtask-row button:hover {
            color: #ef4444;
            border-color: #ef4444;
        }
        .swarm-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        .swarm-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .swarm-card-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }
        .swarm-card-id {
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-left: 0.5rem;
        }
        .swarm-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .swarm-badge.pending { background: rgba(100,100,100,0.2); color: #999; }
        .swarm-badge.running { background: rgba(59,130,246,0.15); color: #60a5fa; }
        .swarm-badge.assembling { background: rgba(124,58,237,0.15); color: #a78bfa; }
        .swarm-badge.completed { background: rgba(34,197,94,0.15); color: #4ade80; }
        .swarm-badge.failed { background: rgba(239,68,68,0.15); color: #f87171; }
        .swarm-progress {
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        .swarm-progress-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
            background: #7c3aed;
        }
        .swarm-progress-bar.completed { background: #22c55e; }
        .swarm-progress-bar.failed { background: #ef4444; }
        .swarm-progress-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
        }
        .swarm-hub {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .swarm-objective-pill {
            background: rgba(124,58,237,0.12);
            color: #a78bfa;
            padding: 0.3rem 0.8rem;
            border-radius: 16px;
            font-size: 0.8rem;
            max-width: 100%;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .swarm-spokes {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .swarm-spoke {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            min-width: 80px;
        }
        .swarm-spoke-line {
            width: 2px;
            height: 16px;
            background: var(--border-primary);
        }
        .swarm-spoke-node {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        .swarm-spoke-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .swarm-spoke-dot.pending { background: #666; }
        .swarm-spoke-dot.running { background: #60a5fa; }
        .swarm-spoke-dot.completed { background: #4ade80; }
        .swarm-spoke-dot.failed { background: #f87171; }
        .swarm-spoke-agent {
            font-size: 0.65rem;
            color: var(--text-tertiary);
        }
        .swarm-result-preview {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            max-height: 120px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .swarm-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Task Scheduler --- */
        .schedule-section {
            margin-bottom: 2rem;
        }

        .schedule-builder {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .schedule-builder-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .schedule-builder-row input[type="text"],
        .schedule-builder-row input[type="number"] {
            flex: 1;
            min-width: 120px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            outline: none;
        }

        .schedule-builder-row input:focus {
            border-color: var(--primary);
        }

        .schedule-builder-row input::placeholder {
            color: var(--text-tertiary);
        }

        .schedule-builder-row select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
            outline: none;
            cursor: pointer;
        }

        .schedule-builder-row select:focus {
            border-color: var(--primary);
        }

        .schedule-builder-row label {
            font-size: 0.8rem;
            color: #7a8a9a;
            white-space: nowrap;
        }

        .schedule-builder-row .schedule-builder-btn {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .schedule-builder-row .schedule-builder-btn:hover {
            background: #3b82f6;
        }

        .schedule-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.85rem 1rem;
            margin-bottom: 0.5rem;
            transition: opacity 0.3s;
        }

        .schedule-card.disabled {
            opacity: 0.5;
        }

        .schedule-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .schedule-card-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .schedule-card-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .schedule-card-id {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
        }

        .schedule-enabled-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .schedule-enabled-badge.on {
            background: rgba(0, 214, 114, 0.15);
            color: var(--success);
        }

        .schedule-enabled-badge.off {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }

        .schedule-type-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .schedule-card-meta {
            font-size: 0.8rem;
            color: #5a6a7a;
            margin-bottom: 0.4rem;
        }

        .schedule-card-meta span {
            margin-right: 1rem;
        }

        .schedule-card-actions {
            display: flex;
            gap: 0.4rem;
        }

        .schedule-card-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 6px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.3rem 0.7rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .schedule-card-btn:hover {
            background: var(--btn-hover);
        }

        .schedule-card-btn.danger {
            color: var(--danger);
            border-color: var(--danger);
        }

        .schedule-card-btn.danger:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        .schedule-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        .schedule-interval-input {
            max-width: 100px;
        }

        .schedule-time-input {
            max-width: 100px;
        }

        /* --- Security & Audit --- */
        .security-section {
            margin-bottom: 2rem;
        }

        .approval-queue {
            background: #2a2400;
            border: 2px solid #b8860b;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }

        .approval-queue h3 {
            color: #f0c040;
            font-size: 0.95rem;
            margin: 0 0 0.5rem;
        }

        .approval-request {
            background: var(--bg-secondary);
            border: 1px solid var(--border-hover);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .approval-request:last-child {
            margin-bottom: 0;
        }

        .approval-info {
            flex: 1;
            min-width: 0;
        }

        .approval-desc {
            color: #c9d1d9;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .approval-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            gap: 0.75rem;
        }

        .approval-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .approval-btn {
            border: none;
            border-radius: 4px;
            padding: 0.35rem 0.8rem;
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .approval-btn:hover {
            opacity: 0.85;
        }

        .approval-btn.approve {
            background: #238636;
            color: #ffffff;
        }

        .approval-btn.reject {
            background: #da3633;
            color: #ffffff;
        }

        .audit-filter-bar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .audit-filter-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 4px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .audit-filter-btn:hover {
            background: var(--btn-hover);
        }

        .audit-filter-btn.active {
            background: var(--btn-hover);
            color: #ffffff;
        }

        .audit-filter-select {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 4px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.75rem;
            padding: 0.25rem 0.4rem;
            cursor: pointer;
        }

        .audit-log-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.78rem;
            line-height: 1.5;
        }

        .audit-entry {
            padding: 0.3rem 0.75rem;
            border-bottom: 1px solid #1f2d3d;
            display: flex;
            gap: 0.5rem;
            align-items: baseline;
        }

        .audit-entry:last-child {
            border-bottom: none;
        }

        .audit-time {
            color: var(--text-tertiary);
            flex-shrink: 0;
            font-size: 0.72rem;
        }

        .audit-risk {
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
            flex-shrink: 0;
            min-width: 55px;
        }

        .audit-risk.low { color: #3fb950; }
        .audit-risk.medium { color: #d29922; }
        .audit-risk.high { color: #f85149; }
        .audit-risk.critical { color: #ff0040; }

        .audit-actor {
            color: #8b949e;
            flex-shrink: 0;
            font-size: 0.75rem;
        }

        .audit-action {
            color: #c9d1d9;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .audit-result {
            font-weight: 700;
            font-size: 0.7rem;
            text-transform: uppercase;
            flex-shrink: 0;
            min-width: 60px;
            text-align: right;
        }

        .audit-result.executed { color: #3fb950; }
        .audit-result.approved { color: #58a6ff; }
        .audit-result.rejected { color: #f85149; }
        .audit-result.blocked { color: #ff0040; }
        .audit-result.timeout { color: #d29922; }
        .audit-result.pending { color: #8b949e; }

        .audit-empty {
            padding: 1.5rem;
            text-align: center;
            color: var(--text-tertiary);
        }

        /* --- Content Calendar --- */
        .content-section {
            margin-bottom: 2rem;
        }

        .content-builder {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .content-builder-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .content-builder-row input[type="text"],
        .content-builder-row input[type="date"] {
            flex: 1;
            min-width: 120px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            outline: none;
        }

        .content-builder-row input:focus {
            border-color: var(--primary);
        }

        .content-builder-row input::placeholder {
            color: var(--text-tertiary);
        }

        .content-builder-row select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
            outline: none;
            cursor: pointer;
        }

        .content-builder-row select:focus {
            border-color: var(--primary);
        }

        .content-builder-row label {
            font-size: 0.8rem;
            color: #7a8a9a;
            white-space: nowrap;
        }

        .content-builder-row .content-builder-btn {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .content-builder-row .content-builder-btn:hover {
            background: #3b82f6;
        }

        .content-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.85rem 1rem;
            margin-bottom: 0.5rem;
        }

        .content-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .content-card-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .content-card-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .content-card-id {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
        }

        .content-status-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .content-status-badge.idea        { background: rgba(74, 90, 106, 0.25); color: #7a8a9a; }
        .content-status-badge.planned      { background: rgba(37, 99, 235, 0.2); color: #60a5fa; }
        .content-status-badge.in_progress  { background: rgba(217, 119, 6, 0.2); color: #fbbf24; }
        .content-status-badge.review       { background: rgba(234, 88, 12, 0.2); color: #fb923c; }
        .content-status-badge.published    { background: rgba(22, 163, 74, 0.2); color: #4ade80; }
        .content-status-badge.archived     { background: rgba(107, 114, 128, 0.2); color: #6b7280; }

        .content-type-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .content-card-meta {
            font-size: 0.8rem;
            color: #5a6a7a;
            margin-bottom: 0.4rem;
        }

        .content-card-meta span {
            margin-right: 1rem;
        }

        .content-card-actions {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        .content-card-actions select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.75rem;
            padding: 0.25rem 0.4rem;
            outline: none;
            cursor: pointer;
        }

        .content-card-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 6px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.3rem 0.7rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .content-card-btn:hover {
            background: var(--btn-hover);
        }

        .content-card-btn.danger {
            color: var(--danger);
            border-color: var(--danger);
        }

        .content-card-btn.danger:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        .content-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Content Pipeline (Kanban) --- */
        .pipeline-stats-bar {
            display: flex;
            gap: 1.5rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            flex-wrap: wrap;
        }
        .pipeline-stats-bar .stat-label { color: var(--text-tertiary); }
        .pipeline-stats-bar .stat-value { color: var(--text-primary); font-weight: 600; margin-left: 0.3rem; }

        .pipeline-create-bar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }
        .pipeline-create-bar input {
            flex: 1;
            min-width: 120px;
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        .pipeline-create-bar input:focus { border-color: var(--accent-primary); outline: none; }
        .pipeline-create-btn {
            padding: 0.5rem 1rem;
            background: var(--accent-primary);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .pipeline-create-btn:hover { opacity: 0.9; }

        .pipeline-kanban {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
            min-height: 180px;
        }
        .pipeline-column {
            flex: 1;
            min-width: 130px;
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
        }
        .pipeline-col-header {
            text-align: center;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.35rem 0;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            color: #fff;
        }
        .pipeline-col-header.research  { background: #3b82f6; }
        .pipeline-col-header.outline   { background: #6366f1; }
        .pipeline-col-header.script    { background: #8b5cf6; }
        .pipeline-col-header.review    { background: #f59e0b; }
        .pipeline-col-header.tts       { background: #06b6d4; }
        .pipeline-col-header.package   { background: #10b981; }
        .pipeline-col-header.done      { background: #22c55e; }

        .pipeline-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.4rem;
            font-size: 0.8rem;
        }
        .pipeline-card-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
            word-break: break-word;
        }
        .pipeline-card-topic {
            color: var(--text-tertiary);
            font-size: 0.75rem;
            margin-bottom: 0.3rem;
            word-break: break-word;
        }
        .pipeline-card-status {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }
        .pipeline-card-status.paused { color: #f59e0b; }
        .pipeline-card-status.failed { color: #ef4444; }
        .pipeline-card-status.cancelled { color: #6b7280; }

        .pipeline-card-actions {
            display: flex;
            gap: 0.3rem;
            flex-wrap: wrap;
        }
        .pipeline-card-actions button {
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            color: #fff;
        }
        .pipeline-btn-approve { background: #22c55e; }
        .pipeline-btn-approve:hover { background: #16a34a; }
        .pipeline-btn-reject { background: #ef4444; }
        .pipeline-btn-reject:hover { background: #dc2626; }
        .pipeline-btn-cancel { background: #6b7280; }
        .pipeline-btn-cancel:hover { background: #4b5563; }

        .pipeline-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Voice Synthesis (TTS) --- */
        .tts-section {
            margin-bottom: 2rem;
        }

        .tts-status-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #7a8a9a;
        }

        .tts-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .tts-status-dot.ok { background: #4ade80; }
        .tts-status-dot.error { background: var(--danger); }

        .tts-compose {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .tts-compose textarea {
            width: 100%;
            min-height: 80px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.75rem;
            outline: none;
            resize: vertical;
            box-sizing: border-box;
            margin-bottom: 0.5rem;
        }

        .tts-compose textarea:focus {
            border-color: var(--primary);
        }

        .tts-compose textarea::placeholder {
            color: var(--text-tertiary);
        }

        .tts-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .tts-controls select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.5rem 0.75rem;
            outline: none;
            cursor: pointer;
        }

        .tts-controls select:focus {
            border-color: var(--primary);
        }

        .tts-synthesize-btn {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .tts-synthesize-btn:hover {
            background: #3b82f6;
        }

        .tts-synthesize-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tts-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
        }

        .tts-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .tts-item-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.8rem;
            color: #5a6a7a;
        }

        .tts-item-meta .tts-voice-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            text-transform: uppercase;
        }

        .tts-item-text {
            font-size: 0.85rem;
            color: #8a9aaa;
            margin-bottom: 0.5rem;
            max-height: 3em;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tts-item audio {
            width: 100%;
            height: 36px;
        }

        .tts-item-actions {
            display: flex;
            gap: 0.4rem;
        }

        .tts-delete-btn {
            background: var(--btn-bg);
            border: 1px solid var(--danger);
            border-radius: 6px;
            color: var(--danger);
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .tts-delete-btn:hover {
            background: rgba(231, 76, 60, 0.2);
        }

        .tts-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Research Results --- */
        .research-section {
            margin-bottom: 2rem;
        }

        .research-search-bar {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .research-search-bar input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
            outline: none;
        }

        .research-search-bar input:focus {
            border-color: var(--primary);
        }

        .research-search-bar input::placeholder {
            color: var(--text-tertiary);
        }

        .research-search-bar button {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .research-search-bar button:hover {
            background: #3b82f6;
        }

        .research-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.85rem 1rem;
            margin-bottom: 0.5rem;
        }

        .research-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .research-card-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            flex: 1;
            min-width: 0;
        }

        .research-card-query {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 500px;
        }

        .research-card-id {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-family: 'JetBrains Mono', monospace;
        }

        .research-status-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .research-status-badge.in_progress { background: rgba(217, 119, 6, 0.2); color: #fbbf24; }
        .research-status-badge.completed    { background: rgba(22, 163, 74, 0.2); color: #4ade80; }
        .research-status-badge.failed       { background: rgba(231, 76, 60, 0.2); color: var(--danger); }
        .research-status-badge.stale        { background: rgba(107, 114, 128, 0.2); color: #6b7280; }

        .research-card-meta {
            font-size: 0.8rem;
            color: #5a6a7a;
            margin-bottom: 0.4rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .research-card-summary {
            font-size: 0.85rem;
            color: #8a9aaa;
            line-height: 1.4;
            max-height: 4.2em;
            overflow: hidden;
            margin-bottom: 0.3rem;
        }

        .research-card-actions {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        .research-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Scout Panel --- */
        /* ---- Business Operations ---- */
        .business-section {
            margin-bottom: 2rem;
        }

        .biz-filter-bar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .biz-filter-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 4px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.35rem 0.75rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .biz-filter-btn:hover {
            background: var(--btn-hover);
        }

        .biz-filter-btn.active {
            background: var(--btn-hover);
            color: #ffffff;
        }

        .biz-stats {
            font-size: 0.8rem;
            color: #5a6a7a;
            margin-left: auto;
        }

        .biz-tab-content {
            display: none;
        }

        .biz-tab-content.active {
            display: block;
        }

        .biz-add-form {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
        }

        .biz-form-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 0.4rem;
        }

        .biz-form-row:last-child {
            margin-bottom: 0;
        }

        .biz-form-row input,
        .biz-form-row select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.82rem;
            padding: 0.35rem 0.5rem;
            outline: none;
            flex: 1;
            min-width: 100px;
        }

        .biz-form-row input:focus,
        .biz-form-row select:focus {
            border-color: var(--primary);
        }

        .biz-form-row button {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 4px;
            color: #ffffff;
            font-family: inherit;
            font-size: 0.82rem;
            font-weight: 600;
            padding: 0.35rem 0.75rem;
            cursor: pointer;
        }

        .biz-form-row button:hover {
            background: #1d4ed8;
        }

        .biz-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.7rem 0.85rem;
            margin-bottom: 0.4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
        }

        .biz-card-info {
            flex: 1;
            min-width: 0;
        }

        .biz-card-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .biz-card-meta {
            font-size: 0.78rem;
            color: #5a6a7a;
            margin-top: 0.15rem;
        }

        .biz-card-actions {
            display: flex;
            gap: 0.3rem;
            flex-shrink: 0;
        }

        .biz-card-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 4px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.72rem;
            padding: 0.2rem 0.45rem;
            cursor: pointer;
        }

        .biz-card-btn:hover {
            background: var(--btn-hover);
            color: #fff;
        }

        .biz-card-btn.danger {
            border-color: #7f1d1d;
            color: #f87171;
        }

        .biz-card-btn.danger:hover {
            background: #7f1d1d;
            color: #fff;
        }

        .biz-status-badge {
            display: inline-block;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .biz-status-badge.scheduled   { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .biz-status-badge.confirmed   { background: rgba(16,185,129,0.2); color: #34d399; }
        .biz-status-badge.in_progress { background: rgba(245,158,11,0.2); color: #fbbf24; }
        .biz-status-badge.completed   { background: rgba(0,214,114,0.2);  color: var(--success); }
        .biz-status-badge.cancelled   { background: rgba(107,114,128,0.2); color: #9ca3af; }
        .biz-status-badge.no_show     { background: rgba(239,68,68,0.2);  color: #f87171; }
        .biz-status-badge.draft       { background: rgba(107,114,128,0.2); color: #9ca3af; }
        .biz-status-badge.sent        { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .biz-status-badge.paid        { background: rgba(0,214,114,0.2);  color: var(--success); }
        .biz-status-badge.overdue     { background: rgba(239,68,68,0.2);  color: #f87171; }

        .biz-reorder-alert {
            color: var(--warning);
            font-size: 0.72rem;
            font-weight: 600;
        }

        .biz-empty {
            color: var(--text-tertiary);
            font-size: 0.85rem;
            padding: 1rem;
            text-align: center;
        }

        /* Service Records */
        .svc-section {
            margin-bottom: 2rem;
        }
        .svc-stats-bar {
            display: flex;
            gap: 1.5rem;
            padding: 0.5rem 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }
        .svc-stats-bar span {
            font-weight: 600;
            color: var(--text-primary);
        }
        .svc-sub-panel {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .svc-sub-panel h3 {
            margin: 0 0 0.75rem 0;
            font-size: 1rem;
            color: var(--text-primary);
        }
        .svc-form-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.5rem;
        }
        .svc-form-row input, .svc-form-row select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .svc-form-row input:focus, .svc-form-row select:focus {
            outline: none;
            border-color: var(--accent);
        }
        .svc-form-row button {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.4rem 0.8rem;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .svc-form-row button:hover {
            opacity: 0.85;
        }
        .svc-vehicle-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .svc-vehicle-card .svc-v-info {
            flex: 1;
        }
        .svc-vehicle-card .svc-v-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        .svc-vehicle-card .svc-v-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .svc-vehicle-card .svc-v-actions {
            display: flex;
            gap: 0.4rem;
        }
        .svc-vehicle-card .svc-v-actions button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.78rem;
        }
        .svc-vehicle-card .svc-v-actions button:hover {
            color: var(--text-primary);
            border-color: var(--accent);
        }
        .svc-vehicle-card .svc-v-actions button.danger:hover {
            border-color: var(--error);
            color: var(--error);
        }
        .svc-record-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
        }
        .svc-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .svc-record-header .svc-r-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        .svc-record-header .svc-r-type {
            font-size: 0.75rem;
            background: var(--accent);
            color: #fff;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            text-transform: capitalize;
        }
        .svc-record-body {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .svc-record-body .svc-r-services {
            margin: 0.3rem 0;
        }
        .svc-record-body .svc-r-parts {
            margin: 0.3rem 0;
        }
        .svc-record-body .svc-r-cost {
            margin-top: 0.4rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .svc-record-body .svc-r-notes {
            margin-top: 0.3rem;
            font-style: italic;
            font-size: 0.8rem;
        }
        .svc-record-actions {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.5rem;
        }
        .svc-record-actions button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.78rem;
        }
        .svc-record-actions button:hover {
            color: var(--text-primary);
            border-color: var(--accent);
        }
        .svc-record-actions button.danger:hover {
            border-color: var(--error);
            color: var(--error);
        }
        .svc-empty {
            color: var(--text-tertiary);
            font-size: 0.85rem;
            padding: 1rem;
            text-align: center;
        }
        .svc-history-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
        }
        .svc-add-record-form {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
            display: none;
        }
        .svc-add-record-form.visible {
            display: block;
        }
        .svc-add-record-form h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            color: var(--text-primary);
        }
        .svc-parts-row {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            margin-bottom: 0.3rem;
        }
        .svc-parts-row input {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.3rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .svc-parts-row button {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.78rem;
        }

        /* Knowledge Ingestion */
        .ki-stats-bar {
            display: flex;
            gap: 1.5rem;
            padding: 0.5rem 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }
        .ki-stats-bar span {
            font-weight: 600;
            color: var(--text-primary);
        }
        .ki-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem 1rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin-bottom: 1rem;
        }
        .ki-upload-area:hover, .ki-upload-area.dragover {
            border-color: var(--accent);
            background: rgba(37, 99, 235, 0.05);
        }
        .ki-upload-area input[type="file"] {
            display: none;
        }
        .ki-upload-area .ki-browse {
            color: var(--accent);
            text-decoration: underline;
            cursor: pointer;
        }
        .ki-upload-area .ki-supported {
            font-size: 0.78rem;
            color: var(--text-tertiary);
            margin-top: 0.5rem;
        }
        .ki-history-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 1rem 0 0.5rem;
        }
        .ki-doc-card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.6rem 1rem;
            margin-bottom: 0.4rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ki-doc-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.88rem;
        }
        .ki-doc-meta {
            font-size: 0.78rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .ki-doc-badge {
            font-size: 0.72rem;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-weight: 600;
            text-transform: capitalize;
        }
        .ki-doc-badge.completed { background: var(--success); color: #fff; }
        .ki-doc-badge.failed { background: var(--error); color: #fff; }
        .ki-doc-badge.processing { background: var(--warning); color: #000; }
        .ki-empty {
            color: var(--text-tertiary);
            font-size: 0.85rem;
            padding: 1rem;
            text-align: center;
        }

        /* --- Diagnostic Decision Trees --- */
        .diag-section { margin-bottom: 2rem; }
        .diag-toolbar {
            display: flex; align-items: center; gap: 0.75rem;
            margin-bottom: 1rem; flex-wrap: wrap;
        }
        .diag-stat { font-size: 0.85rem; color: var(--text-secondary); }
        .diag-stat b { color: var(--text-primary); }
        .diag-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.75rem; margin-bottom: 1.5rem;
        }
        .diag-tree-card {
            background: var(--bg-secondary); border: 1px solid var(--border-primary);
            border-radius: 8px; padding: 1rem; cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
        }
        .diag-tree-card:hover {
            border-color: #3b82f6; background: rgba(59,130,246,0.06);
        }
        .diag-tree-card h4 { margin: 0 0 0.25rem 0; font-size: 0.95rem; color: var(--text-primary); }
        .diag-tree-card .diag-cat {
            display: inline-block; font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 0.05em; padding: 2px 6px; border-radius: 4px;
            font-weight: 600; margin-bottom: 0.4rem;
        }
        .diag-cat-electrical { background: rgba(234,179,8,0.15); color: #eab308; }
        .diag-cat-engine { background: rgba(239,68,68,0.15); color: #ef4444; }
        .diag-cat-suspension { background: rgba(59,130,246,0.15); color: #3b82f6; }
        .diag-tree-card .diag-desc {
            font-size: 0.8rem; color: var(--text-secondary);
            margin-bottom: 0.4rem; line-height: 1.3;
        }
        .diag-tree-card .diag-nodes { font-size: 0.75rem; color: var(--text-tertiary); }

        .diag-walker {
            background: var(--bg-secondary); border: 1px solid var(--border-primary);
            border-radius: 8px; padding: 1.25rem;
        }
        .diag-walker-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 0.75rem; flex-wrap: wrap; gap: 0.5rem;
        }
        .diag-walker-header h3 { margin: 0; font-size: 1rem; }
        .diag-walker-header .diag-vehicle { font-size: 0.85rem; color: var(--text-secondary); }
        .diag-breadcrumbs {
            font-size: 0.75rem; color: var(--text-tertiary);
            margin-bottom: 1rem; word-break: break-all;
        }
        .diag-breadcrumbs span { color: var(--text-secondary); }
        .diag-safety {
            background: rgba(234,179,8,0.1); border: 1px solid rgba(234,179,8,0.3);
            border-radius: 6px; padding: 0.6rem 0.8rem; margin-bottom: 1rem;
            font-size: 0.85rem; color: #eab308;
        }
        .diag-question { font-size: 1rem; color: var(--text-primary); margin-bottom: 0.3rem; font-weight: 600; }
        .diag-context { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.4; }
        .diag-answer-btn {
            display: block; width: 100%; text-align: left;
            background: var(--bg-tertiary); border: 1px solid var(--border-primary);
            border-radius: 6px; padding: 0.7rem 1rem; margin-bottom: 0.5rem;
            color: var(--text-primary); font-family: inherit; font-size: 0.9rem;
            cursor: pointer; transition: border-color 0.15s, background 0.15s;
        }
        .diag-answer-btn:hover { border-color: #3b82f6; background: rgba(59,130,246,0.08); }

        .diag-finding {
            background: var(--bg-tertiary); border-radius: 6px;
            padding: 0.8rem 1rem; margin-bottom: 0.75rem;
            border-left: 3px solid #6b7280;
        }
        .diag-finding.sev-low { border-left-color: #22c55e; }
        .diag-finding.sev-medium { border-left-color: #eab308; }
        .diag-finding.sev-high { border-left-color: #f97316; }
        .diag-finding.sev-critical { border-left-color: #ef4444; }
        .diag-finding h5 { margin: 0 0 0.3rem 0; font-size: 0.9rem; }
        .diag-finding .diag-sev {
            font-size: 0.7rem; text-transform: uppercase; font-weight: 700;
            letter-spacing: 0.05em; margin-left: 0.5rem;
        }
        .diag-finding p { font-size: 0.8rem; color: var(--text-secondary); margin: 0 0 0.4rem 0; }
        .diag-finding ul { margin: 0.3rem 0 0 1.2rem; padding: 0; }
        .diag-finding li { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.15rem; }

        .diag-actions {
            display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;
        }
        .diag-actions button {
            border-radius: 6px; padding: 0.5rem 1rem;
            font-family: inherit; font-size: 0.85rem; font-weight: 600;
            cursor: pointer; border: 1px solid var(--border-primary);
            background: var(--bg-tertiary); color: var(--text-primary);
        }
        .diag-actions .diag-btn-primary { background: #2563eb; border-color: #3b82f6; color: #fff; }
        .diag-actions .diag-btn-danger { background: #dc2626; border-color: #ef4444; color: #fff; }
        .diag-actions .diag-btn-success { background: #16a34a; border-color: #22c55e; color: #fff; }

        .diag-notes-area {
            width: 100%; min-height: 60px; background: var(--bg-tertiary);
            border: 1px solid var(--border-primary); border-radius: 6px;
            padding: 0.6rem; color: var(--text-primary); font-family: inherit;
            font-size: 0.85rem; resize: vertical; margin-top: 0.75rem;
        }

        .diag-ai-box {
            background: rgba(59,130,246,0.08); border: 1px solid rgba(59,130,246,0.2);
            border-radius: 6px; padding: 0.8rem; margin-top: 0.75rem;
            font-size: 0.85rem; color: var(--text-secondary); white-space: pre-wrap;
        }

        .diag-history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem 0.75rem; background: var(--bg-secondary);
            border: 1px solid var(--border-primary); border-radius: 6px;
            margin-bottom: 0.4rem; font-size: 0.85rem;
        }
        .diag-history-item .diag-hist-name { color: var(--text-primary); font-weight: 500; }
        .diag-history-item .diag-hist-meta { color: var(--text-tertiary); font-size: 0.75rem; }
        .diag-status-badge {
            font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;
            font-weight: 600; text-transform: uppercase;
        }
        .diag-status-completed { background: rgba(34,197,94,0.15); color: #22c55e; }
        .diag-status-abandoned { background: rgba(107,114,128,0.15); color: #6b7280; }
        .diag-status-active { background: rgba(59,130,246,0.15); color: #3b82f6; }

        .scout-section {
            margin-bottom: 2rem;
        }

        .scout-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .scout-toolbar-left {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .scout-toolbar select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
            outline: none;
        }

        .scout-toolbar select:focus {
            border-color: var(--primary);
        }

        .scout-stats {
            font-size: 0.8rem;
            color: #5a6a7a;
            display: flex;
            gap: 1rem;
        }

        .scout-stats .hot {
            color: #ef4444;
            font-weight: 600;
        }

        .scout-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.85rem 1rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid transparent;
        }

        .scout-card.hot-deal {
            border-left-color: #ef4444;
        }

        .scout-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .scout-card-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            min-width: 0;
        }

        .scout-deal-score {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            min-width: 2.5em;
            text-align: center;
        }

        .scout-deal-score.hot  { background: rgba(239, 68, 68, 0.25); color: #ef4444; }
        .scout-deal-score.warm { background: rgba(245, 158, 11, 0.25); color: var(--warning); }
        .scout-deal-score.cool { background: rgba(107, 114, 128, 0.25); color: #6b7280; }

        .scout-card-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 500px;
        }

        .scout-card-title a {
            color: var(--primary);
            text-decoration: none;
        }

        .scout-card-title a:hover {
            text-decoration: underline;
        }

        .scout-status-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .scout-status-badge.new       { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .scout-status-badge.reviewed   { background: rgba(22, 163, 74, 0.2); color: #4ade80; }
        .scout-status-badge.flagged    { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .scout-status-badge.dismissed  { background: rgba(107, 114, 128, 0.2); color: #6b7280; }

        .scout-card-meta {
            font-size: 0.8rem;
            color: #5a6a7a;
            margin-bottom: 0.4rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .scout-card-meta .price {
            color: #4ade80;
            font-weight: 600;
        }

        .scout-card-reason {
            font-size: 0.82rem;
            color: #8a9aaa;
            line-height: 1.4;
            font-style: italic;
            margin-bottom: 0.3rem;
        }

        .scout-card-actions {
            display: flex;
            gap: 0.3rem;
            align-items: center;
        }

        .scout-card-btn {
            background: var(--btn-bg);
            border: 1px solid #3a4a5a;
            border-radius: 4px;
            color: #8a9aaa;
            font-family: inherit;
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .scout-card-btn:hover { background: #3a4a5a; color: var(--text-primary); }
        .scout-card-btn.flag  { color: #ef4444; }
        .scout-card-btn.flag:hover { background: rgba(239, 68, 68, 0.2); }
        .scout-card-btn.ok    { color: #4ade80; }
        .scout-card-btn.ok:hover { background: rgba(22, 163, 74, 0.2); }

        .scout-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Market Analytics Panel --- */
        .market-toolbar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .market-toolbar button {
            padding: 0.4rem 0.8rem;
            background: var(--btn-bg);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .market-toolbar button:hover { background: var(--btn-hover); }
        .market-toolbar button:disabled { opacity: 0.5; cursor: not-allowed; }

        .market-stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }
        .market-stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
        }
        .market-stat-card .stat-value {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .market-stat-card .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
        }

        .market-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin: 1rem 0 0.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.25rem;
        }

        .market-trend-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.6rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.15s;
        }
        .market-trend-row:hover { background: var(--bg-secondary); }
        .market-trend-name {
            flex: 1;
            font-weight: 500;
            font-size: 0.85rem;
            text-transform: capitalize;
        }
        .market-trend-arrow {
            font-size: 1.1rem;
            width: 1.5rem;
            text-align: center;
        }
        .market-trend-arrow.rising { color: #ef4444; }
        .market-trend-arrow.falling { color: #22c55e; }
        .market-trend-arrow.stable { color: var(--text-tertiary); }
        .market-trend-pct {
            width: 5rem;
            text-align: right;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .market-trend-pct.rising { color: #ef4444; }
        .market-trend-pct.falling { color: #22c55e; }
        .market-trend-pct.stable { color: var(--text-tertiary); }
        .market-trend-price {
            width: 5rem;
            text-align: right;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .market-trend-pts {
            width: 3.5rem;
            text-align: right;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        .market-sparkline {
            width: 60px;
            height: 20px;
            display: flex;
            align-items: flex-end;
            gap: 1px;
        }
        .market-sparkline-bar {
            flex: 1;
            background: #a78bfa;
            border-radius: 1px;
            min-height: 2px;
        }

        .market-deal-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0.6rem;
            border-bottom: 1px solid var(--border);
        }
        .market-deal-discount {
            font-weight: 700;
            font-size: 0.85rem;
            color: #22c55e;
            width: 3.5rem;
        }
        .market-deal-title {
            flex: 1;
            font-size: 0.85rem;
        }
        .market-deal-price {
            font-weight: 600;
            font-size: 0.85rem;
        }
        .market-deal-avg {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .market-heat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.6rem;
            margin-top: 0.5rem;
        }
        .market-heat-cell {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.6rem;
            text-align: center;
            transition: transform 0.15s;
        }
        .market-heat-cell:hover { transform: scale(1.03); }
        .market-heat-cell .heat-location {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        .market-heat-cell .heat-count {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .market-heat-cell .heat-avg {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        .market-heat-cold { background: rgba(96, 165, 250, 0.1); }
        .market-heat-warm { background: rgba(250, 204, 21, 0.1); }
        .market-heat-hot  { background: rgba(239, 68, 68, 0.15); }

        .market-detail-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .market-detail-overlay.active { display: flex; }
        .market-detail-panel {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .market-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .market-detail-header h3 { margin: 0; font-size: 1.1rem; }
        .market-detail-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
        }
        .market-detail-sparkline {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 60px;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        .market-detail-sparkline .bar {
            flex: 1;
            background: #a78bfa;
            border-radius: 2px;
            min-height: 3px;
            position: relative;
        }
        .market-detail-sparkline .bar:hover { background: #c4b5fd; }
        .market-detail-table {
            width: 100%;
            font-size: 0.8rem;
            border-collapse: collapse;
        }
        .market-detail-table th {
            text-align: left;
            color: var(--text-secondary);
            padding: 0.3rem 0.5rem;
            border-bottom: 1px solid var(--border);
        }
        .market-detail-table td {
            padding: 0.3rem 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .market-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Webhook Panel --- */
        .webhook-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .webhook-stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            min-width: 100px;
            text-align: center;
        }
        .webhook-stat-card .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-primary);
        }
        .webhook-stat-card .stat-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }
        .webhook-register-form {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: none;
        }
        .webhook-register-form.active { display: block; }
        .webhook-register-form .form-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        .webhook-register-form input,
        .webhook-register-form select {
            background: var(--bg-primary);
            border: 1px solid var(--border-primary);
            color: var(--text-primary);
            padding: 0.4rem 0.6rem;
            border-radius: 4px;
            font-size: 0.85rem;
            flex: 1;
            min-width: 120px;
        }
        .webhook-endpoint-row {
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
        }
        .webhook-endpoint-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .webhook-endpoint-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        .webhook-endpoint-url {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            word-break: break-all;
            margin-top: 0.25rem;
        }
        .webhook-endpoint-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        .webhook-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .webhook-badge.outbound { background: #1a3a5c; color: #4db8ff; }
        .webhook-badge.inbound { background: #1a4a3a; color: #4dffc0; }
        .webhook-badge.enabled { background: #1a4a2a; color: #4dff7c; }
        .webhook-badge.disabled { background: #4a3a1a; color: #ffaa4d; }
        .webhook-endpoint-actions {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }
        .webhook-endpoint-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 4px;
            border: 1px solid var(--border-primary);
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: pointer;
        }
        .webhook-endpoint-actions button:hover { background: var(--bg-tertiary); }
        .webhook-endpoint-actions button.danger { color: var(--status-error); }
        .webhook-delivery-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--border-primary);
            font-size: 0.85rem;
        }
        .webhook-delivery-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .webhook-delivery-dot.success { background: var(--status-healthy); }
        .webhook-delivery-dot.failed { background: var(--status-error); }
        .webhook-delivery-dot.retrying { background: var(--status-warning); }
        .webhook-delivery-dot.pending { background: var(--text-tertiary); }
        .webhook-delivery-category {
            font-weight: 600;
            color: var(--accent-primary);
            min-width: 60px;
        }
        .webhook-delivery-message {
            flex: 1;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .webhook-delivery-status {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            white-space: nowrap;
        }

        /* --- Self-Test Panel --- */
        .self-test-section {
            margin-bottom: 2rem;
        }

        .self-test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .self-test-header h2 {
            margin: 0;
        }

        .self-test-btn {
            background: transparent;
            border: 1px solid #58a6ff;
            color: #58a6ff;
            padding: 0.35rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .self-test-btn:hover {
            background: rgba(88, 166, 255, 0.15);
        }

        .self-test-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .self-test-summary {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            padding: 0.6rem 1rem;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .self-test-summary.all-pass {
            border-color: #238636;
        }

        .self-test-summary.has-fail {
            border-color: var(--danger);
        }

        .st-pass-count { color: var(--success); font-weight: 600; }
        .st-fail-count { color: var(--danger); font-weight: 600; }
        .st-duration { color: #8b949e; }

        .self-test-category {
            margin-bottom: 0.5rem;
        }

        .self-test-category-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #8b949e;
            margin-bottom: 0.25rem;
            padding-left: 0.25rem;
        }

        .self-test-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.35rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .self-test-item:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .st-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .st-dot.st-pass { background: var(--success); }
        .st-dot.st-fail { background: var(--danger); }

        .st-name {
            flex: 1;
            color: #c9d1d9;
        }

        .st-message {
            flex: 2;
            color: #8b949e;
            font-size: 0.8rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .st-time {
            color: #484f58;
            font-size: 0.75rem;
            min-width: 50px;
            text-align: right;
        }

        .self-test-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Launch Readiness Panel --- */
        .lr-section {
            margin-bottom: 2rem;
        }

        .lr-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .lr-header h2 {
            margin: 0;
        }

        .lr-btn {
            background: transparent;
            border: 1px solid #d29922;
            color: #d29922;
            padding: 0.35rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .lr-btn:hover {
            background: rgba(210, 153, 34, 0.15);
        }

        .lr-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .lr-progress-container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 0.5rem;
            margin-bottom: 0.75rem;
            display: none;
        }

        .lr-progress-bar {
            height: 6px;
            background: #d29922;
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .lr-progress-text {
            text-align: center;
            font-size: 0.8rem;
            color: #8b949e;
            margin-top: 0.35rem;
        }

        .lr-summary {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            padding: 0.6rem 1rem;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .lr-summary.all-pass {
            border-color: #238636;
        }

        .lr-summary.has-fail {
            border-color: var(--danger);
        }

        .lr-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Persona Panel --- */
        .persona-section {
            margin-bottom: 2rem;
        }

        .persona-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .persona-header h2 {
            margin: 0;
        }

        .persona-reload-btn {
            background: transparent;
            border: 1px solid #a78bfa;
            color: #a78bfa;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .persona-reload-btn:hover {
            background: rgba(167, 139, 250, 0.15);
        }

        .persona-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .persona-name {
            font-size: 1.4rem;
            font-weight: 700;
            color: #a78bfa;
            margin-bottom: 0.15rem;
        }

        .persona-tagline {
            font-style: italic;
            color: #8892a4;
            margin-bottom: 0.75rem;
        }

        .persona-role {
            color: #c9d1d9;
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }

        .persona-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            margin-bottom: 0.5rem;
        }

        .persona-tag {
            display: inline-block;
            padding: 0.15rem 0.55rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .persona-tag.tone {
            border: 1px solid #a78bfa;
            color: #a78bfa;
        }

        .persona-tag.domain {
            border: 1px solid #34d399;
            color: #34d399;
        }

        .persona-prompt-preview {
            background: #0d1520;
            border-radius: 6px;
            padding: 0.85rem 1rem;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.8rem;
            color: #8892a4;
            line-height: 1.5;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .persona-token-estimate {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.75rem;
            color: #586e75;
            margin-top: 0.4rem;
            text-align: right;
        }

        /* --- Settings Panel --- */
        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .settings-header h2 {
            margin-bottom: 0;
        }

        .settings-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .settings-last-loaded {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .settings-reload-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 4px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.6rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .settings-reload-btn:hover {
            background: var(--btn-hover);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
        }

        .settings-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
        }

        .settings-card h3 {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: 0.5rem;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.2rem 0;
            font-size: 0.78rem;
        }

        .settings-row .key {
            color: var(--text-secondary);
        }

        .settings-row .val {
            color: var(--text-value);
            font-family: monospace;
        }

        /* --- Notification Bell --- */
        .notification-bell {
            position: relative;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-bell svg {
            width: 22px;
            height: 22px;
            fill: var(--secondary);
            transition: fill 0.15s;
        }

        .notification-bell:hover svg {
            fill: #b0d0ee;
        }

        .notification-bell .badge {
            position: absolute;
            top: 0;
            right: -2px;
            background: var(--danger);
            color: #fff;
            font-size: 0.65rem;
            font-weight: 700;
            min-width: 16px;
            height: 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            line-height: 1;
        }

        .notification-bell .badge.hidden {
            display: none;
        }

        /* --- Notification Dropdown --- */
        .notification-wrapper {
            position: relative;
        }

        .notification-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            width: 360px;
            max-height: 420px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 1000;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .notification-dropdown.open {
            display: flex;
            flex-direction: column;
        }

        .notification-dropdown-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }

        .notification-dropdown-header h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .notification-mark-all {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
        }

        .notification-mark-all:hover {
            background: rgba(91, 155, 213, 0.15);
        }

        .notification-list {
            overflow-y: auto;
            flex: 1;
        }

        .notification-item {
            padding: 0.6rem 1rem;
            border-bottom: 1px solid #1f2d3d;
            cursor: pointer;
            transition: background 0.1s;
            border-left: 3px solid transparent;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-item:hover {
            background: rgba(255,255,255,0.03);
        }

        .notification-item.unread {
            border-left-color: var(--primary);
            background: rgba(91, 155, 213, 0.05);
        }

        .notification-item.read {
            opacity: 0.6;
        }

        .notification-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.2rem;
        }

        .notification-item-title {
            font-size: 0.82rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .notification-severity-badge {
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.05rem 0.35rem;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .notification-severity-badge.info {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .notification-severity-badge.warn {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .notification-severity-badge.error {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }

        .notification-severity-badge.critical {
            background: rgba(220, 38, 38, 0.25);
            color: #f87171;
        }

        .notification-item-time {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .notification-item-message {
            font-size: 0.78rem;
            color: #a0b0c0;
            line-height: 1.3;
        }

        .notification-empty {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        /* --- Toast Container --- */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
            max-width: 380px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            pointer-events: auto;
            cursor: pointer;
            animation: toast-in 0.3s ease-out;
            border-left: 4px solid var(--primary);
        }

        .toast.toast-out {
            animation: toast-out 0.3s ease-in forwards;
        }

        .toast.severity-info { border-left-color: #60a5fa; }
        .toast.severity-warn { border-left-color: var(--warning); }
        .toast.severity-error { border-left-color: var(--danger); }
        .toast.severity-critical {
            border-left-color: #dc2626;
            animation: toast-in 0.3s ease-out, critical-pulse 2s ease-in-out infinite;
        }
        .toast.severity-critical.toast-out {
            animation: toast-out 0.3s ease-in forwards;
        }

        .toast-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.2rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .toast-message {
            font-size: 0.78rem;
            color: #a0b0c0;
            line-height: 1.3;
        }

        @keyframes toast-in {
            from {
                opacity: 0;
                transform: translateX(40px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toast-out {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(40px);
            }
        }

        @keyframes critical-pulse {
            0%, 100% { box-shadow: 0 4px 16px rgba(0,0,0,0.4); }
            50% { box-shadow: 0 4px 16px rgba(220, 38, 38, 0.4), 0 0 8px rgba(220, 38, 38, 0.2); }
        }

        /* --- File Transfer Section --- */
        .file-transfer-section {
            margin-bottom: 2rem;
        }

        .ft-forms {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .ft-form {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem 1.25rem;
        }

        .ft-form h3 {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 0.75rem;
        }

        .ft-form-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .ft-form select,
        .ft-form input[type="text"] {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
            outline: none;
        }

        .ft-form select:focus,
        .ft-form input[type="text"]:focus {
            border-color: var(--primary);
        }

        .ft-form input[type="text"]::placeholder {
            color: var(--text-tertiary);
        }

        .ft-form select {
            cursor: pointer;
        }

        .ft-form input[type="file"] {
            font-size: 0.8rem;
            color: #a0b0c0;
        }

        .ft-form input[type="file"]::file-selector-button {
            background: var(--btn-bg);
            border: 1px solid var(--border-hover);
            border-radius: 4px;
            color: var(--secondary);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            margin-right: 0.5rem;
        }

        .ft-form input[type="file"]::file-selector-button:hover {
            background: var(--btn-hover);
        }

        .ft-btn {
            background: #2563eb;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            color: #fff;
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.4rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
            white-space: nowrap;
        }

        .ft-btn:hover { background: #3b82f6; }
        .ft-btn:disabled { opacity: 0.4; cursor: default; }

        .ft-btn.secondary {
            background: var(--btn-bg);
            border-color: var(--border-hover);
            color: var(--secondary);
        }

        .ft-btn.secondary:hover { background: var(--btn-hover); }

        .ft-active-transfers {
            margin-bottom: 1rem;
        }

        .ft-transfer-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
        }

        .ft-transfer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .ft-transfer-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ft-direction {
            font-size: 0.85rem;
        }

        .ft-direction.upload { color: var(--primary); }
        .ft-direction.download { color: var(--warning); }

        .ft-filename {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .ft-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        .ft-status-badge {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
        }

        .ft-status-badge.active {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
        }

        .ft-status-badge.completed {
            background: rgba(0, 214, 114, 0.15);
            color: var(--success);
        }

        .ft-status-badge.failed {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }

        .ft-status-badge.cancelled {
            background: rgba(106, 122, 138, 0.15);
            color: var(--text-secondary);
        }

        .ft-progress-bar {
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.4rem;
        }

        .ft-progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
            background: #3b82f6;
        }

        .ft-progress-fill.completed { background: var(--success); }
        .ft-progress-fill.failed { background: var(--danger); }

        .ft-error {
            font-size: 0.75rem;
            color: var(--danger);
            margin-top: 0.3rem;
        }

        .ft-cancel-btn {
            background: none;
            border: 1px solid var(--text-tertiary);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            cursor: pointer;
        }

        .ft-cancel-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .ft-history {
            max-height: 300px;
            overflow-y: auto;
        }

        .ft-empty {
            text-align: center;
            padding: 1.5rem;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        @media (max-width: 640px) {
            .ft-forms {
                grid-template-columns: 1fr;
            }
        }

        /* --- Responsive --- */
        @media (max-width: 640px) {
            header {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .kill-switch-bar {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .agent-grid {
                grid-template-columns: 1fr;
            }
        }

        /* --- Deploy Section --- */
        .deploy-section {
            margin-bottom: 2rem;
        }

        .deploy-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .deploy-local-ver {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .deploy-local-ver code {
            background: var(--bg-tertiary);
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--primary);
        }

        .deploy-agent-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .deploy-agent-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.6rem 0.8rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .deploy-agent-row .agent-name {
            font-weight: 600;
            min-width: 120px;
        }

        .deploy-agent-row .agent-ip {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            min-width: 110px;
        }

        .deploy-ver-badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            min-width: 100px;
            text-align: center;
        }

        .deploy-ver-badge.match {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .deploy-ver-badge.mismatch {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
        }

        .deploy-ver-badge.unknown {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .deploy-agent-row .deploy-actions {
            margin-left: auto;
            display: flex;
            gap: 0.4rem;
        }

        .deploy-btn {
            padding: 0.3rem 0.7rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.78rem;
            transition: background 0.15s;
        }

        .deploy-btn:hover {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
        }

        .deploy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .deploy-btn.deploy-btn-primary {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
            font-weight: 600;
        }

        .deploy-btn.deploy-btn-primary:hover {
            background: var(--secondary);
            border-color: var(--secondary);
        }

        .deploy-history-section {
            margin-top: 1rem;
        }

        .deploy-history-toggle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            margin-bottom: 0.5rem;
        }

        .deploy-history-toggle:hover {
            color: var(--text-primary);
        }

        .deploy-history-list {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .deploy-history-item {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.4rem 0.6rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 0.8rem;
            border: 1px solid var(--border);
        }

        .deploy-history-item .deploy-ok {
            color: #22c55e;
        }

        .deploy-history-item .deploy-fail {
            color: #ef4444;
        }

        .deploy-history-item .deploy-time {
            color: var(--text-secondary);
            margin-left: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
        }
        /* --- Panel Fullscreen Mode --- */
        .panel-fullscreen {
            position: fixed !important;
            inset: 0;
            z-index: 900;
            overflow-y: auto;
            background: var(--bg-primary);
            padding: 1.5rem;
            margin: 0 !important;
            border-radius: 0 !important;
        }

        .panel-fullscreen .scrollable,
        .panel-fullscreen .event-log-entries,
        .panel-fullscreen .msgbus-log,
        .panel-fullscreen .security-log {
            max-height: none !important;
        }

        /* --- Panel Size Presets --- */
        [data-panel-size="compact"] > *:not(h2):not(.settings-header):not(.deploy-header):not(.msgbus-header):not(.self-test-header):not(.lr-header) {
            display: none !important;
        }

        [data-panel-size="compact"] h2 {
            margin-bottom: 0;
            cursor: pointer;
        }

        [data-panel-size="expanded"] .scrollable,
        [data-panel-size="expanded"] .event-log-entries,
        [data-panel-size="expanded"] .msgbus-log,
        [data-panel-size="expanded"] .security-log {
            max-height: none !important;
        }

        /* --- Panel Header Flex (for fullscreen button) --- */
        [data-panel-id] > h2,
        [data-panel-id] > .settings-header > h2,
        [data-panel-id] > .deploy-header > h2,
        [data-panel-id] > div > h2 {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-expand-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0.2rem 0.35rem;
            font-size: 0.75rem;
            line-height: 1;
            transition: color 0.15s, border-color 0.15s;
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        .panel-expand-btn:hover {
            color: var(--primary);
            border-color: var(--primary);
        }

        /* --- Settings Tabs --- */
        .settings-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .settings-tab {
            padding: 0.5rem 1rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-family: inherit;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.15s, border-color 0.15s;
        }

        .settings-tab:hover {
            color: var(--text-primary);
        }

        .settings-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
        }

        /* --- Layout Editor --- */
        .layout-editor {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }

        .layout-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.6rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.82rem;
        }

        .layout-row .panel-name {
            flex: 1;
            color: var(--text-primary);
        }

        .layout-toggle {
            position: relative;
            width: 32px;
            height: 18px;
            background: var(--bg-tertiary);
            border-radius: 9px;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .layout-toggle::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: transform 0.2s, background 0.2s;
        }

        .layout-toggle.on {
            background: var(--primary);
        }

        .layout-toggle.on::after {
            transform: translateX(14px);
            background: #fff;
        }

        .layout-arrow {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0.15rem 0.35rem;
            font-size: 0.7rem;
            line-height: 1;
            transition: color 0.15s, border-color 0.15s;
        }

        .layout-arrow:hover {
            color: var(--primary);
            border-color: var(--primary);
        }

        .layout-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .layout-size-select {
            background: var(--bg-primary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.15rem 0.3rem;
            font-size: 0.7rem;
            font-family: inherit;
            cursor: pointer;
        }

        /* --- Theme Cards --- */
        .theme-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 0.75rem;
        }

        .theme-card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 0.75rem;
            cursor: pointer;
            text-align: center;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .theme-card:hover {
            border-color: var(--border-hover);
        }

        .theme-card.active {
            border-color: var(--primary);
            box-shadow: 0 0 8px var(--primary-subtle);
        }

        .theme-card .theme-preview {
            height: 48px;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .theme-card .theme-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .theme-card .theme-desc {
            font-size: 0.72rem;
            color: var(--text-secondary);
            margin-top: 0.2rem;
        }

        /* --- Notification Prefs --- */
        .notif-pref-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .notif-pref-row:last-child {
            border-bottom: none;
        }

        .notif-pref-label {
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .notif-pref-label small {
            display: block;
            font-size: 0.72rem;
            color: var(--text-secondary);
            font-weight: normal;
        }

    </style>
</head>
<body>
    <header>
        <div class="logo"><span>CAM</span> Dashboard</div>
        <div style="display:flex;align-items:center;gap:1rem;">
            <div class="notification-wrapper">
                <button class="notification-bell" id="notification-bell" onclick="toggleNotificationDropdown()" title="Notifications">
                    <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                    <span class="badge hidden" id="notification-badge">0</span>
                </button>
                <div class="notification-dropdown" id="notification-dropdown">
                    <div class="notification-dropdown-header">
                        <h3>Notifications</h3>
                        <button class="notification-mark-all" onclick="dismissAllNotifications()">Mark all read</button>
                    </div>
                    <div class="notification-list" id="notification-list">
                        <div class="notification-empty">No notifications yet.</div>
                    </div>
                </div>
            </div>
            <button class="lock-btn" id="lock-btn" onclick="lockSession()" title="Lock Dashboard">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
            </button>
            <div class="telegram-status" id="telegram-status" title="Telegram Bot">
                <div class="tg-dot" id="tg-status-dot"></div>
                <span>Telegram</span>
            </div>
            <div class="connection-status">
                <div class="status-dot" id="ws-status-dot"></div>
                <span id="ws-status-text">Connecting...</span>
            </div>
        </div>
    </header>

    <div class="kill-switch-bar">
        <div>
            <button class="kill-switch-btn" id="kill-switch-btn" onclick="killSwitch()">
                Kill Switch
            </button>
            <span class="kill-switch-label"> â€” halt all agents</span>
        </div>
        <span class="kill-switch-status" id="kill-switch-status">ALL AGENTS HALTED</span>
    </div>

    <main>
        <section class="task-section" data-panel-id="tasks">
            <h2>Task Queue</h2>

            <div class="task-submit-form">
                <input type="text" id="task-input" placeholder="Describe a task..." autocomplete="off"
                    onkeydown="if(event.key==='Enter')submitTask()">
                <select id="task-complexity">
                    <option value="low">LOW</option>
                    <option value="medium">MEDIUM</option>
                    <option value="high">HIGH</option>
                </select>
                <input type="text" id="task-capabilities" placeholder="Capabilities (comma-separated)" autocomplete="off"
                    style="max-width:220px" onkeydown="if(event.key==='Enter')submitTask()">
                <button class="task-submit-btn" onclick="submitTask()">Submit</button>
            </div>

            <div class="task-stats" id="task-stats">
                <div class="task-stat"><span class="label">Pending</span> <span class="value pending" id="stat-pending">0</span></div>
                <div class="task-stat"><span class="label">Running</span> <span class="value running" id="stat-running">0</span></div>
                <div class="task-stat"><span class="label">Completed</span> <span class="value completed" id="stat-completed">0</span></div>
                <div class="task-stat"><span class="label">Failed</span> <span class="value failed" id="stat-failed">0</span></div>
            </div>

            <div class="task-active-panel hidden" id="task-active-panel">
                <div class="task-active-header">
                    <span class="task-active-title" id="task-active-title"></span>
                    <span class="task-active-id" id="task-active-id"></span>
                </div>
                <div class="oati-phases" id="oati-phases">
                    <div class="oati-phase" data-phase="OBSERVE">Observe</div>
                    <div class="oati-phase" data-phase="THINK">Think</div>
                    <div class="oati-phase" data-phase="ACT">Act</div>
                    <div class="oati-phase" data-phase="ITERATE">Iterate</div>
                </div>
                <div class="task-active-detail" id="task-active-detail"></div>
            </div>

            <div class="task-history" id="task-history">
                <div class="task-empty-state">No tasks yet. Submit one above.</div>
            </div>
        </section>

        <section class="chain-section" data-panel-id="chains">
            <h2>Task Chains</h2>

            <div class="chain-builder">
                <div class="chain-builder-header">
                    <input type="text" id="chain-name-input" placeholder="Chain name..." autocomplete="off">
                    <button class="chain-builder-btn" onclick="addChainStep()">+ Add Step</button>
                    <button class="chain-builder-btn" onclick="loadTestChain()">Load Test Chain</button>
                    <button class="chain-builder-btn primary" id="chain-submit-btn" onclick="submitChain()">Submit Chain</button>
                </div>
                <div class="chain-step-rows" id="chain-step-rows">
                    <!-- Dynamic step rows rendered here -->
                </div>
            </div>

            <div class="chain-list" id="chain-list">
                <div class="chain-empty">No chains yet. Build one above or click "Load Test Chain" to try it out.</div>
            </div>
        </section>

        <section class="swarm-section" data-panel-id="swarms">
            <h2>Agent Swarm</h2>

            <div class="swarm-builder">
                <div class="swarm-builder-header">
                    <input type="text" id="swarm-name-input" placeholder="Swarm name..." autocomplete="off">
                    <button class="chain-builder-btn" onclick="addSwarmSubtask()">+ Add Subtask</button>
                    <button class="chain-builder-btn" onclick="loadTestSwarm()">Load Test Swarm</button>
                    <button class="chain-builder-btn primary" id="swarm-submit-btn" onclick="submitSwarm()">Submit Swarm</button>
                </div>
                <textarea class="swarm-objective" id="swarm-objective-input" placeholder="High-level objective... (what should the combined results achieve?)"></textarea>
                <div id="swarm-subtask-rows">
                    <!-- Dynamic subtask rows rendered here -->
                </div>
            </div>

            <div class="swarm-list" id="swarm-list">
                <div class="swarm-empty">No swarms yet. Build one above or click "Load Test Swarm" to try it out.</div>
            </div>
        </section>

        <section class="schedule-section" data-panel-id="scheduler">
            <h2>Task Scheduler</h2>

            <div class="schedule-builder">
                <div class="schedule-builder-row">
                    <input type="text" id="sched-name" placeholder="Schedule name..." autocomplete="off">
                    <input type="text" id="sched-desc" placeholder="Task description (command)..." autocomplete="off">
                </div>
                <div class="schedule-builder-row">
                    <label>Type:</label>
                    <select id="sched-type" onchange="onScheduleTypeChange()">
                        <option value="interval">Interval</option>
                        <option value="once">Once</option>
                        <option value="daily">Daily</option>
                    </select>
                    <label>Complexity:</label>
                    <select id="sched-complexity">
                        <option value="low">LOW</option>
                        <option value="medium">MEDIUM</option>
                        <option value="high">HIGH</option>
                    </select>
                    <span id="sched-interval-group">
                        <label>Every:</label>
                        <input type="number" id="sched-interval" class="schedule-interval-input" value="300" min="10" step="10"> <label>sec</label>
                    </span>
                    <span id="sched-time-group" style="display:none;">
                        <label>At (UTC):</label>
                        <input type="text" id="sched-time" class="schedule-time-input" value="09:00" placeholder="HH:MM">
                    </span>
                    <input type="text" id="sched-caps" placeholder="Capabilities (comma-sep)..." style="max-width:180px" autocomplete="off">
                    <button class="schedule-builder-btn" onclick="createSchedule()">Create</button>
                </div>
            </div>

            <div id="schedule-list">
                <div class="schedule-empty">No scheduled tasks yet.</div>
            </div>
        </section>

        <section class="content-section" data-panel-id="content">
            <h2>Content Calendar</h2>

            <div class="content-builder">
                <div class="content-builder-row">
                    <input type="text" id="content-title" placeholder="Content title..." autocomplete="off">
                    <input type="text" id="content-desc" placeholder="Description (optional)..." autocomplete="off">
                </div>
                <div class="content-builder-row">
                    <label>Type:</label>
                    <select id="content-type">
                        <option value="general">General</option>
                        <option value="script_outline">Script Outline</option>
                        <option value="video">Video</option>
                        <option value="episode_description">Episode Description</option>
                        <option value="research">Research</option>
                    </select>
                    <label>Date:</label>
                    <input type="date" id="content-date">
                    <button class="content-builder-btn" onclick="createContentEntry()">Add</button>
                </div>
            </div>

            <div id="content-list">
                <div class="content-empty">No content entries yet.</div>
            </div>
        </section>

        <section data-panel-id="pipeline">
            <h2>Content Pipeline</h2>

            <div class="pipeline-stats-bar" id="pipeline-stats">
                <span><span class="stat-label">Active:</span><span class="stat-value" id="pl-stat-active">0</span></span>
                <span><span class="stat-label">Review:</span><span class="stat-value" id="pl-stat-review">0</span></span>
                <span><span class="stat-label">Completed:</span><span class="stat-value" id="pl-stat-completed">0</span></span>
                <span><span class="stat-label">Failed:</span><span class="stat-value" id="pl-stat-failed">0</span></span>
            </div>

            <div class="pipeline-create-bar">
                <input type="text" id="pipeline-title" placeholder="Title">
                <input type="text" id="pipeline-topic" placeholder="Topic (what should the video be about?)">
                <button class="pipeline-create-btn" onclick="createPipeline()">Start New Content</button>
            </div>

            <div class="pipeline-kanban" id="pipeline-kanban">
                <div class="pipeline-empty">No pipelines yet. Enter a title and topic above to start.</div>
            </div>
        </section>

        <section class="tts-section" data-panel-id="tts">
            <h2>Voice Synthesis</h2>

            <div class="tts-status-bar" id="tts-status">
                <span class="tts-status-dot error"></span>
                <span>Checking TTS status...</span>
            </div>

            <div class="tts-compose">
                <textarea id="tts-text" placeholder="Enter text to synthesize..." maxlength="5000"></textarea>
                <div class="tts-controls">
                    <select id="tts-voice">
                        <option value="">Default voice</option>
                    </select>
                    <button class="tts-synthesize-btn" id="tts-synthesize-btn" onclick="ttsSynthesize()">Synthesize</button>
                </div>
            </div>

            <div id="tts-audio-list">
                <div class="tts-empty">No audio files yet.</div>
            </div>
        </section>

        <section class="research-section" data-panel-id="research">
            <h2>Research Results</h2>

            <div class="research-search-bar">
                <input type="text" id="research-search-input" placeholder="Search past research..." autocomplete="off"
                       onkeydown="if(event.key==='Enter') searchResearch()">
                <button onclick="searchResearch()">Search</button>
            </div>

            <div id="research-list">
                <div class="research-empty">No research results yet.</div>
            </div>
        </section>

        <section class="business-section" data-panel-id="business">
            <h2>Business Operations</h2>

            <div class="biz-filter-bar">
                <button class="biz-filter-btn active" onclick="switchBizTab('appointments', this)">Appointments</button>
                <button class="biz-filter-btn" onclick="switchBizTab('customers', this)">Customers</button>
                <button class="biz-filter-btn" onclick="switchBizTab('invoices', this)">Invoices</button>
                <button class="biz-filter-btn" onclick="switchBizTab('inventory', this)">Inventory</button>
                <span class="biz-stats" id="biz-stats"></span>
            </div>

            <!-- Appointments Tab -->
            <div class="biz-tab-content active" id="biz-tab-appointments">
                <div class="biz-add-form">
                    <div class="biz-form-row">
                        <select id="biz-appt-customer">
                            <option value="">-- Customer --</option>
                        </select>
                        <input type="date" id="biz-appt-date">
                        <input type="time" id="biz-appt-time">
                    </div>
                    <div class="biz-form-row">
                        <input type="text" id="biz-appt-bike" placeholder="Bike">
                        <input type="text" id="biz-appt-service" placeholder="Service type">
                        <input type="text" id="biz-appt-location" placeholder="Location">
                        <input type="number" id="biz-appt-cost" placeholder="Est. cost" step="0.01">
                        <button onclick="createAppointment()">Add</button>
                    </div>
                </div>
                <div id="biz-appointment-list">
                    <div class="biz-empty">No appointments yet.</div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div class="biz-tab-content" id="biz-tab-customers">
                <div class="biz-add-form">
                    <div class="biz-form-row">
                        <input type="text" id="biz-cust-name" placeholder="Name">
                        <input type="text" id="biz-cust-phone" placeholder="Phone">
                        <input type="text" id="biz-cust-email" placeholder="Email">
                    </div>
                    <div class="biz-form-row">
                        <input type="text" id="biz-cust-bike" placeholder="Bike info">
                        <input type="text" id="biz-cust-notes" placeholder="Notes">
                        <button onclick="createCustomer()">Add</button>
                    </div>
                </div>
                <div id="biz-customer-list">
                    <div class="biz-empty">No customers yet.</div>
                </div>
            </div>

            <!-- Invoices Tab -->
            <div class="biz-tab-content" id="biz-tab-invoices">
                <div class="biz-add-form">
                    <div class="biz-form-row">
                        <select id="biz-inv-customer">
                            <option value="">-- Customer --</option>
                        </select>
                        <input type="number" id="biz-inv-labor-hours" placeholder="Labor hrs" step="0.5" style="max-width:100px;">
                        <input type="number" id="biz-inv-labor-rate" placeholder="Rate" value="75" step="0.01" style="max-width:80px;">
                        <input type="text" id="biz-inv-notes" placeholder="Notes">
                        <button onclick="createInvoice()">Add</button>
                    </div>
                </div>
                <div id="biz-invoice-list">
                    <div class="biz-empty">No invoices yet.</div>
                </div>
            </div>

            <!-- Inventory Tab -->
            <div class="biz-tab-content" id="biz-tab-inventory">
                <div class="biz-add-form">
                    <div class="biz-form-row">
                        <input type="text" id="biz-inv-item-name" placeholder="Item name">
                        <select id="biz-inv-item-category">
                            <option value="parts">Parts</option>
                            <option value="tools">Tools</option>
                            <option value="consumables">Consumables</option>
                        </select>
                        <input type="number" id="biz-inv-item-qty" placeholder="Qty" style="max-width:60px;">
                        <input type="number" id="biz-inv-item-cost" placeholder="Unit cost" step="0.01" style="max-width:90px;">
                        <input type="number" id="biz-inv-item-reorder" placeholder="Reorder at" style="max-width:80px;">
                        <button onclick="createInventoryItem()">Add</button>
                    </div>
                </div>
                <div id="biz-inventory-list">
                    <div class="biz-empty">No inventory items yet.</div>
                </div>
            </div>
        </section>

        <section class="svc-section" data-panel-id="service-records">
            <h2>Service Records</h2>

            <div class="svc-stats-bar" id="svc-stats-bar">
                Vehicles: <span id="svc-stat-vehicles">0</span> &middot;
                Records: <span id="svc-stat-records">0</span> &middot;
                This Month: <span id="svc-stat-month">0</span> &middot;
                Revenue: <span id="svc-stat-revenue">$0.00</span>
            </div>

            <!-- Vehicles Sub-Panel -->
            <div class="svc-sub-panel">
                <h3>Vehicles</h3>
                <div class="svc-form-row">
                    <input type="text" id="svc-v-year" placeholder="Year" style="max-width:70px;">
                    <input type="text" id="svc-v-make" placeholder="Make">
                    <input type="text" id="svc-v-model" placeholder="Model">
                    <input type="text" id="svc-v-vin" placeholder="VIN">
                    <select id="svc-v-owner">
                        <option value="">-- Owner --</option>
                    </select>
                    <button onclick="svcCreateVehicle()">Add Vehicle</button>
                </div>
                <div class="svc-form-row">
                    <input type="text" id="svc-v-color" placeholder="Color" style="max-width:100px;">
                    <input type="number" id="svc-v-mileage" placeholder="Mileage" style="max-width:100px;">
                </div>
                <div id="svc-vehicle-list">
                    <div class="svc-empty">No vehicles yet.</div>
                </div>
            </div>

            <!-- Service History Sub-Panel -->
            <div class="svc-sub-panel">
                <h3>Service History</h3>
                <div class="svc-history-title" id="svc-history-title">Select a vehicle to view service history</div>
                <div id="svc-record-list">
                    <div class="svc-empty">No service records.</div>
                </div>

                <button class="svc-form-row" style="display:none;" id="svc-add-record-btn"
                    onclick="svcToggleRecordForm()">Add Service Record</button>

                <div class="svc-add-record-form" id="svc-add-record-form">
                    <h4>New Service Record</h4>
                    <div class="svc-form-row">
                        <input type="date" id="svc-r-date">
                        <select id="svc-r-type">
                            <option value="diagnostic">Diagnostic</option>
                            <option value="maintenance">Maintenance</option>
                            <option value="repair">Repair</option>
                            <option value="inspection">Inspection</option>
                        </select>
                        <input type="number" id="svc-r-labor-hours" placeholder="Labor hrs" step="0.5" style="max-width:90px;">
                        <input type="number" id="svc-r-labor-rate" placeholder="Rate" value="75" step="0.01" style="max-width:80px;">
                    </div>
                    <div class="svc-form-row">
                        <input type="text" id="svc-r-services" placeholder="Services (comma-separated)" style="flex:1;">
                    </div>
                    <div class="svc-form-row">
                        <input type="text" id="svc-r-notes" placeholder="Notes" style="flex:1;">
                    </div>
                    <div class="svc-form-row">
                        <input type="text" id="svc-r-recommendations" placeholder="Recommendations" style="flex:1;">
                    </div>
                    <div id="svc-parts-list">
                        <!-- Dynamic parts rows -->
                    </div>
                    <div class="svc-form-row">
                        <button onclick="svcAddPartRow()" style="background:var(--bg-tertiary);color:var(--text-secondary);border:1px solid var(--border);">+ Part</button>
                        <button onclick="svcSubmitRecord()">Save Record</button>
                    </div>
                </div>
            </div>
        </section>

        <section data-panel-id="knowledge-ingest" style="display:none;">
            <h2>Knowledge Ingestion</h2>

            <div class="ki-stats-bar" id="ki-stats-bar">
                Documents: <span id="ki-stat-docs">0</span> &middot;
                Chunks: <span id="ki-stat-chunks">0</span> &middot;
                Failed: <span id="ki-stat-failed">0</span> &middot;
                Inbox: <span id="ki-stat-inbox">0</span>
            </div>

            <div class="ki-upload-area" id="ki-upload-area">
                <div>Drag and drop files here, or <label class="ki-browse" for="ki-file-input">browse</label></div>
                <div class="ki-supported">Supported: .md, .txt, .pdf, .csv (max 10 MB)</div>
                <input type="file" id="ki-file-input" multiple accept=".md,.txt,.pdf,.csv">
            </div>

            <button style="background:#2563eb;border:1px solid #3b82f6;border-radius:6px;color:#fff;font-family:inherit;font-size:0.85rem;font-weight:600;padding:0.5rem 1rem;cursor:pointer;margin-bottom:1rem;" onclick="kiScanInbox()">Scan Inbox</button>

            <div class="ki-history-title">Ingestion History</div>
            <div id="ki-history-list">
                <div class="ki-empty">No documents ingested yet.</div>
            </div>
        </section>

        <section class="diag-section" data-panel-id="diagnostics">
            <h2>Diagnostic Decision Trees</h2>
            <div class="diag-toolbar">
                <span class="diag-stat">Trees: <b id="diag-tree-count">0</b></span>
                <span class="diag-stat">Active: <b id="diag-active-count">0</b></span>
                <span class="diag-stat">Completed: <b id="diag-completed-count">0</b></span>
                <select id="diag-cat-filter" style="background:var(--bg-tertiary);border:1px solid var(--border-primary);border-radius:6px;color:var(--text-primary);padding:0.35rem 0.6rem;font-size:0.85rem;">
                    <option value="">All Categories</option>
                    <option value="electrical">Electrical</option>
                    <option value="engine">Engine</option>
                    <option value="suspension">Suspension</option>
                </select>
                <button style="background:var(--bg-tertiary);border:1px solid var(--border-primary);border-radius:6px;color:var(--text-primary);font-family:inherit;font-size:0.85rem;padding:0.4rem 0.8rem;cursor:pointer;" onclick="diagReloadTrees()">Reload Trees</button>
            </div>
            <div id="diag-tree-grid" class="diag-grid"></div>
            <div id="diag-walker" style="display:none;"></div>
            <div id="diag-findings-section" style="display:none;margin-top:1rem;">
                <h4 style="margin:0 0 0.5rem 0;font-size:0.9rem;">Findings</h4>
                <div id="diag-findings-list"></div>
            </div>
            <div id="diag-ai-section" style="display:none;"></div>
            <h4 style="margin:1.5rem 0 0.5rem 0;font-size:0.9rem;">Recent Sessions</h4>
            <div id="diag-history-list">
                <div class="ki-empty">No diagnostic sessions yet.</div>
            </div>
        </section>

        <section class="scout-section" data-panel-id="scout">
            <h2>Motorcycle Scout</h2>

            <div class="scout-toolbar">
                <div class="scout-toolbar-left">
                    <button class="research-search-bar button" style="background:#2563eb;border:1px solid #3b82f6;border-radius:6px;color:#fff;font-family:inherit;font-size:0.85rem;font-weight:600;padding:0.5rem 1rem;cursor:pointer;" onclick="triggerScoutScan()">Scan Now</button>
                    <select id="scout-status-filter" onchange="filterScoutListings()">
                        <option value="">All Statuses</option>
                        <option value="new">New</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="flagged">Flagged</option>
                        <option value="dismissed">Dismissed</option>
                    </select>
                </div>
                <div class="scout-stats" id="scout-stats">
                    <span>Total: 0</span>
                </div>
            </div>

            <div id="scout-list">
                <div class="scout-empty">No scout results yet. Click "Scan Now" to search.</div>
            </div>
        </section>

        <section data-panel-id="market-analytics" style="display:none;">
            <h2>Market Analytics</h2>

            <div class="market-toolbar">
                <button onclick="triggerMarketSnapshot()" id="market-snapshot-btn">Take Snapshot</button>
                <button onclick="triggerMarketReport()" id="market-report-btn">Generate Report</button>
                <button onclick="downloadLatestReport()" id="market-download-btn" disabled>Download Report</button>
            </div>

            <div class="market-stat-cards" id="market-stat-cards">
                <div class="market-stat-card">
                    <div class="stat-value" id="market-stat-makes">0</div>
                    <div class="stat-label">Tracked Makes</div>
                </div>
                <div class="market-stat-card">
                    <div class="stat-value" id="market-stat-snapshots">0</div>
                    <div class="stat-label">Total Snapshots</div>
                </div>
                <div class="market-stat-card">
                    <div class="stat-value" id="market-stat-date">â€”</div>
                    <div class="stat-label">Latest Snapshot</div>
                </div>
                <div class="market-stat-card">
                    <div class="stat-value" id="market-stat-reports">0</div>
                    <div class="stat-label">Reports Generated</div>
                </div>
            </div>

            <div class="market-section-title">Price Trends by Make/Model</div>
            <div id="market-trends">
                <div class="market-empty">No trend data yet. Take snapshots to build price history.</div>
            </div>

            <div class="market-section-title">Undervalued Listings</div>
            <div id="market-deals">
                <div class="market-empty">No undervalued listings detected.</div>
            </div>

            <div class="market-section-title">Listings by Location</div>
            <div id="market-heatgrid" class="market-heat-grid">
                <div class="market-empty">No location data available.</div>
            </div>

            <div class="market-detail-overlay" id="market-detail-overlay" onclick="closeMarketDetail(event)">
                <div class="market-detail-panel" onclick="event.stopPropagation()">
                    <div class="market-detail-header">
                        <h3 id="market-detail-title">Price History</h3>
                        <button class="market-detail-close" onclick="closeMarketDetail()">&times;</button>
                    </div>
                    <div class="market-detail-sparkline" id="market-detail-chart"></div>
                    <table class="market-detail-table">
                        <thead>
                            <tr><th>Date</th><th>Avg Price</th><th>Min</th><th>Max</th><th>Count</th></tr>
                        </thead>
                        <tbody id="market-detail-tbody"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section data-panel-id="webhooks" style="display:none;">
            <h2>Webhooks</h2>

            <div class="webhook-stats" id="webhook-stats"></div>

            <button class="btn" onclick="toggleWebhookForm()" style="margin-bottom:1rem;">+ Register Endpoint</button>

            <div class="webhook-register-form" id="webhook-register-form">
                <div class="form-row">
                    <input type="text" id="wh-name" placeholder="Endpoint name" />
                    <input type="text" id="wh-url" placeholder="https://hooks.example.com/..." />
                </div>
                <div class="form-row">
                    <select id="wh-direction">
                        <option value="outbound">Outbound</option>
                        <option value="inbound">Inbound</option>
                    </select>
                    <input type="text" id="wh-secret" placeholder="HMAC secret (optional)" />
                </div>
                <div class="form-row">
                    <select id="wh-severity">
                        <option value="all">All severities</option>
                        <option value="info">Info only</option>
                        <option value="warn">Warn only</option>
                        <option value="error">Error only</option>
                    </select>
                    <input type="text" id="wh-filters" placeholder="Event filters (comma-separated, e.g. task,agent)" />
                </div>
                <div class="form-row">
                    <button class="btn" onclick="registerWebhook()">Register</button>
                    <button class="btn" onclick="toggleWebhookForm()" style="background:var(--bg-primary);">Cancel</button>
                </div>
            </div>

            <h3 style="margin-top:1rem;">Registered Endpoints</h3>
            <div id="webhook-endpoints-list">
                <div class="empty-state">No webhook endpoints registered</div>
            </div>

            <h3 style="margin-top:1.5rem;">Recent Deliveries</h3>
            <div id="webhook-deliveries-list">
                <div class="empty-state">No deliveries yet</div>
            </div>
        </section>

        <section class="command-palette-section" data-panel-id="command-palette">
            <h2>Command Palette</h2>

            <div class="command-palette-form">
                <select id="cmd-select" onchange="onCommandSelect()">
                    <option value="">-- Select command --</option>
                </select>
                <select id="cmd-agent-select">
                    <option value="">-- Select agent --</option>
                </select>
                <button class="command-execute-btn" id="cmd-execute-btn" onclick="executeCommand()" disabled>Execute</button>
            </div>
            <div class="command-description" id="cmd-description"></div>
            <div class="command-params" id="cmd-params"></div>
            <div class="command-result-panel" id="cmd-result-panel"></div>
        </section>

        <section class="file-transfer-section" data-panel-id="file-transfer">
            <h2>File Transfer</h2>

            <div class="ft-forms">
                <div class="ft-form">
                    <h3>Send File to Agent</h3>
                    <div class="ft-form-row">
                        <select id="ft-send-agent">
                            <option value="">-- Select agent --</option>
                        </select>
                    </div>
                    <div class="ft-form-row">
                        <input type="file" id="ft-send-file">
                    </div>
                    <div class="ft-form-row">
                        <input type="text" id="ft-send-dest" placeholder="Dest path (optional, e.g. ~/receive/file.txt)" style="flex:1;">
                    </div>
                    <div class="ft-form-row">
                        <button class="ft-btn" onclick="sendFile()" id="ft-send-btn">Send</button>
                    </div>
                </div>

                <div class="ft-form">
                    <h3>Request File from Agent</h3>
                    <div class="ft-form-row">
                        <select id="ft-request-agent">
                            <option value="">-- Select agent --</option>
                        </select>
                    </div>
                    <div class="ft-form-row">
                        <input type="text" id="ft-request-path" placeholder="Remote file path (e.g. ~/logs/cam.log)" style="flex:1;">
                    </div>
                    <div class="ft-form-row">
                        <button class="ft-btn secondary" onclick="requestFile()" id="ft-request-btn">Request</button>
                    </div>
                </div>
            </div>

            <div class="ft-active-transfers" id="ft-active-transfers"></div>
            <div class="ft-history" id="ft-history"></div>
        </section>

        <section class="deploy-section" data-panel-id="deploy">
            <div class="deploy-header">
                <h2>Connector Deploy</h2>
                <div class="deploy-local-ver">
                    Local: <code id="deploy-local-hash">--</code>
                    <button class="deploy-btn deploy-btn-primary" onclick="deployAll()" id="deploy-all-btn">Deploy All</button>
                </div>
            </div>
            <div class="deploy-agent-list" id="deploy-agent-list">
                <div style="color: var(--text-secondary); font-size: 0.85rem;">No agents connected</div>
            </div>
            <div class="deploy-history-section">
                <div class="deploy-history-toggle" onclick="toggleDeployHistory()">
                    <span id="deploy-history-arrow">&#9654;</span> Recent Deploys
                </div>
                <div class="deploy-history-list" id="deploy-history-list" style="display: none;"></div>
            </div>
        </section>

        <section class="backup-section" data-panel-id="backup">
            <h2>Backup & Recovery</h2>
            <div class="backup-header">
                <div class="backup-cards">
                    <div class="backup-card">
                        <span class="card-label">Last Backup</span>
                        <span class="card-value" id="backup-last-time">Never</span>
                    </div>
                    <div class="backup-card">
                        <span class="card-label">Backups</span>
                        <span class="card-value" id="backup-count">0</span>
                    </div>
                    <div class="backup-card">
                        <span class="card-label">Total Size</span>
                        <span class="card-value" id="backup-total-size">0 B</span>
                    </div>
                </div>
                <button class="backup-btn backup-btn-primary" onclick="triggerBackup()" id="backup-now-btn">Backup Now</button>
            </div>
            <div class="backup-list" id="backup-list">
                <div style="color: var(--text-secondary); font-size: 0.85rem;">No backups yet</div>
            </div>
        </section>

        <section class="msgbus-section" data-panel-id="msgbus">
            <div class="msgbus-header">
                <h2>Message Bus</h2>
                <div class="msgbus-header-right">
                    <span class="msgbus-total" id="msgbus-total">0 messages</span>
                    <select class="msgbus-filter" id="msgbus-filter" onchange="filterBusMessages()">
                        <option value="">All Channels</option>
                        <option value="task_updates">task_updates</option>
                        <option value="content_pipeline">content_pipeline</option>
                        <option value="research_results">research_results</option>
                        <option value="alerts">alerts</option>
                        <option value="system">system</option>
                    </select>
                </div>
            </div>
            <div class="msgbus-stats" id="msgbus-stats"></div>
            <div class="msgbus-matrix" id="msgbus-matrix">
                <div class="msgbus-matrix-title">Agent Communication Flow</div>
                <div id="msgbus-matrix-rows"><span class="msgbus-empty">No agent activity yet</span></div>
            </div>
            <div class="msgbus-log" id="msgbus-log">
                <div class="msgbus-empty">No messages yet</div>
            </div>
        </section>

        <section class="context-section" data-panel-id="context">
            <h2>Context Window</h2>
            <div class="context-cards">
                <div class="memory-card">
                    <span class="card-label">Usage</span>
                    <span class="card-value memory-accent" id="ctx-usage-pct">0%</span>
                    <div class="memory-usage-bar">
                        <div class="memory-usage-fill" id="ctx-usage-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="memory-card">
                    <span class="card-label">Session Tokens</span>
                    <span class="card-value memory-accent" id="ctx-total-tokens">0</span>
                </div>
                <div class="memory-card">
                    <span class="card-label">Prompt Tokens</span>
                    <span class="card-value" id="ctx-prompt-tokens">0</span>
                </div>
                <div class="memory-card">
                    <span class="card-label">Response Tokens</span>
                    <span class="card-value" id="ctx-response-tokens">0</span>
                </div>
                <div class="memory-card">
                    <span class="card-label">Current Model</span>
                    <span class="card-value memory-working" id="ctx-model">--</span>
                </div>
                <div class="memory-card">
                    <span class="card-label">Context Limit</span>
                    <span class="card-value" id="ctx-limit">0</span>
                </div>
            </div>
            <div class="context-rotation-info">
                <span><span class="rotation-label">Rotations:</span> <span id="ctx-rotation-count">0</span></span>
                <span><span class="rotation-label">Threshold:</span> <span id="ctx-threshold">90%</span></span>
                <span><span class="rotation-label">Session Start:</span> <span id="ctx-session-start">--</span></span>
                <span><span class="rotation-label">Last Rotation:</span> <span id="ctx-last-rotation">--</span></span>
            </div>
        </section>

        <section class="memory-section" data-panel-id="memory">
            <h2>Memory Status</h2>
            <div class="memory-cards">
                <div class="memory-card">
                    <span class="card-label">Short-Term Messages</span>
                    <span class="card-value memory-accent" id="mem-stm-count">0</span>
                    <div class="memory-usage-bar">
                        <div class="memory-usage-fill" id="mem-stm-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="memory-card">
                    <span class="card-label">STM Capacity</span>
                    <span class="card-value" id="mem-stm-max">0</span>
                </div>
                <div class="memory-card">
                    <span class="card-label">Summaries</span>
                    <span class="card-value" id="mem-stm-summaries">0</span>
                </div>
                <div class="memory-card">
                    <span class="card-label">Working Memory Tasks</span>
                    <span class="card-value memory-working" id="mem-wm-count">0</span>
                </div>
            </div>
            <div class="memory-working-list" id="mem-working-list">
                <h3>Active Working Memory Entries</h3>
                <div id="mem-working-entries">
                    <div class="analytics-empty">No active tasks in working memory.</div>
                </div>
            </div>
            <div class="memory-ltm-section" id="mem-ltm-section">
                <h3>Long-Term Memory <span class="ltm-badge" id="mem-ltm-total">0</span></h3>
                <div class="ltm-cards">
                    <div class="ltm-card">
                        <div class="ltm-card-label">Knowledge</div>
                        <div class="ltm-card-value" id="mem-ltm-knowledge">0</div>
                    </div>
                    <div class="ltm-card">
                        <div class="ltm-card-label">Task Results</div>
                        <div class="ltm-card-value" id="mem-ltm-task-result">0</div>
                    </div>
                    <div class="ltm-card">
                        <div class="ltm-card-label">Preferences</div>
                        <div class="ltm-card-value" id="mem-ltm-preference">0</div>
                    </div>
                    <div class="ltm-card">
                        <div class="ltm-card-label">Learnings</div>
                        <div class="ltm-card-value" id="mem-ltm-learning">0</div>
                    </div>
                </div>
                <div class="ltm-status" id="mem-ltm-status"></div>
            </div>
            <div class="memory-episodic-section" id="mem-episodic-section">
                <h3>Episodic Memory <span class="episodic-badge" id="mem-episodic-total">0</span></h3>
                <div class="episodic-cards">
                    <div class="episodic-card">
                        <div class="episodic-card-label">Today</div>
                        <div class="episodic-card-value" id="mem-episodic-today">0</div>
                    </div>
                    <div class="episodic-card">
                        <div class="episodic-card-label">Oldest</div>
                        <div class="episodic-card-value" id="mem-episodic-oldest">--</div>
                    </div>
                    <div class="episodic-card">
                        <div class="episodic-card-label">Newest</div>
                        <div class="episodic-card-value" id="mem-episodic-newest">--</div>
                    </div>
                </div>
                <div class="episodic-search">
                    <input type="text" id="episodic-search-input" placeholder="Search conversation history..." />
                    <button onclick="searchEpisodes()">Search</button>
                </div>
                <div class="episodic-results" id="episodic-results"></div>
                <div class="episodic-status" id="mem-episodic-status"></div>
            </div>
        </section>

        <section class="analytics-section" data-panel-id="analytics">
            <h2>Analytics</h2>
            <div class="analytics-stats" id="analytics-stats">
                <div class="analytics-card">
                    <span class="card-label">Total Tasks</span>
                    <span class="card-value" id="an-total-tasks">0</span>
                </div>
                <div class="analytics-card">
                    <span class="card-label">Success Rate</span>
                    <span class="card-value success" id="an-success-rate">--</span>
                </div>
                <div class="analytics-card">
                    <span class="card-label">Avg Completion</span>
                    <span class="card-value" id="an-avg-completion">--</span>
                </div>
                <div class="analytics-card">
                    <span class="card-label">Total Model Cost</span>
                    <span class="card-value cost" id="an-model-cost">$0.00</span>
                </div>
                <div class="analytics-card">
                    <span class="card-label">Model Calls</span>
                    <span class="card-value accent" id="an-model-calls">0</span>
                </div>
                <div class="analytics-card">
                    <span class="card-label">Total Tokens</span>
                    <span class="card-value" id="an-total-tokens">0</span>
                </div>
            </div>
            <div class="analytics-bar-chart" id="analytics-bar-chart">
                <h3>Tasks per Agent</h3>
                <div id="agent-bar-chart">
                    <div class="analytics-empty">No task data yet.</div>
                </div>
            </div>
        </section>

        <section class="event-log-section" data-panel-id="event-log">
            <div class="event-log-header">
                <h2>Activity Log</h2>
                <div class="event-log-actions">
                    <button class="event-log-btn" onclick="clearEventLog()">Clear</button>
                    <button class="event-log-btn" onclick="exportEventLog()">Export</button>
                </div>
            </div>
            <div class="event-log-container" id="event-log">
                <div class="event-empty">No events yet. Activity will appear here.</div>
            </div>
        </section>

        <section class="security-section" data-panel-id="security">
            <h2>Security & Audit</h2>

            <div id="approval-queue" style="display:none;">
                <h3>Pending Approvals</h3>
                <div id="approval-list"></div>
            </div>

            <div class="audit-filter-bar">
                <button class="audit-filter-btn active" data-filter="all" onclick="filterAuditLog('all', this)">All</button>
                <button class="audit-filter-btn" data-filter="low" onclick="filterAuditLog('low', this)">Low</button>
                <button class="audit-filter-btn" data-filter="medium" onclick="filterAuditLog('medium', this)">Medium</button>
                <button class="audit-filter-btn" data-filter="critical" onclick="filterAuditLog('critical', this)">Critical</button>
                <select class="audit-filter-select" id="audit-actor-filter" onchange="filterAuditByActor(this.value)">
                    <option value="">All actors</option>
                </select>
            </div>

            <div class="audit-log-container" id="audit-log-container">
                <div class="audit-empty">No audit entries yet. Actions will appear here as tasks are processed.</div>
            </div>
        </section>

        <section class="self-test-section" data-panel-id="self-test">
            <div class="self-test-header">
                <h2>System Self-Test</h2>
                <button class="self-test-btn" id="self-test-btn" onclick="runSelfTest()">Run System Test</button>
            </div>
            <div class="self-test-summary" id="self-test-summary" style="display:none;"></div>
            <div id="self-test-results">
                <div class="self-test-empty">Click "Run System Test" to check all subsystems.</div>
            </div>
        </section>

        <section class="lr-section" data-panel-id="launch-readiness">
            <div class="lr-header">
                <h2>Launch Readiness</h2>
                <button class="lr-btn" id="lr-btn" onclick="runLaunchReadiness()">Run Launch Check</button>
            </div>
            <div class="lr-progress-container" id="lr-progress-container">
                <div class="lr-progress-bar" id="lr-progress-bar"></div>
                <div class="lr-progress-text" id="lr-progress-text">0 / 12</div>
            </div>
            <div class="lr-summary" id="lr-summary" style="display:none;"></div>
            <div id="lr-results">
                <div class="lr-empty">Click "Run Launch Check" to validate all subsystems end-to-end.</div>
            </div>
        </section>

        <section class="persona-section" id="persona-section" data-panel-id="persona">
            <div class="persona-header">
                <h2>Persona</h2>
                <button class="persona-reload-btn" onclick="reloadPersona()">Reload persona.yaml</button>
            </div>
            <div id="persona-identity" class="persona-card">
                <div class="analytics-empty">Waiting for persona data...</div>
            </div>
            <div id="persona-prompt-card" class="persona-card" style="display:none;">
                <h3 style="margin:0 0 0.5rem;font-size:0.95rem;color:#c9d1d9;">System Prompt Preview</h3>
                <div class="persona-prompt-preview" id="persona-prompt-text"></div>
                <div class="persona-token-estimate" id="persona-token-estimate"></div>
            </div>
        </section>

        <section class="settings-section" data-panel-id="settings">
            <div class="settings-header">
                <h2>Settings</h2>
                <div class="settings-actions">
                    <span class="settings-last-loaded" id="settings-last-loaded"></span>
                    <button class="settings-reload-btn" onclick="reloadConfig()">Reload Config</button>
                </div>
            </div>
            <div class="settings-tabs">
                <button class="settings-tab active" onclick="switchSettingsTab('config', this)">Config</button>
                <button class="settings-tab" onclick="switchSettingsTab('layout', this)">Layout</button>
                <button class="settings-tab" onclick="switchSettingsTab('theme', this)">Theme</button>
                <button class="settings-tab" onclick="switchSettingsTab('notifications', this)">Notifications</button>
            </div>
            <div class="settings-tab-content active" id="settings-tab-config">
                <div class="settings-grid" id="settings-grid">
                    <div class="analytics-empty">Waiting for config...</div>
                </div>
            </div>
            <div class="settings-tab-content" id="settings-tab-layout">
                <div class="layout-editor" id="layout-editor"></div>
            </div>
            <div class="settings-tab-content" id="settings-tab-theme">
                <div class="theme-cards" id="theme-cards"></div>
            </div>
            <div class="settings-tab-content" id="settings-tab-notifications">
                <div id="notif-prefs"></div>
            </div>
        </section>

        <section class="agent-board-section" data-panel-id="agents">
            <h2>Agent Status Board</h2>
            <div id="agent-board">
                <!-- Agent cards rendered here by JS -->
            </div>
        </section>
    </main>

    <div class="toast-container" id="toast-container"></div>

    <script>
        // ---------------------------------------------------------------
        // State
        // ---------------------------------------------------------------
        let agents = [];
        let ws = null;
        let reconnectTimer = null;

        // Per-agent chat logs: { agent_id: [{type, text}, ...] }
        const chatLogs = {};

        // Notification state
        let notifications = [];
        let unreadCount = 0;

        // Per-agent health metrics: { agent_id: {...metrics} }
        let agentHealth = {};

        // Command library from server
        let commandLibrary = [];
        // Track pending command palette execution: { agent_id, command_name }
        let pendingCommand = null;

        // File transfer state
        let fileTransfers = [];  // all transfers (active + history)

        const board = document.getElementById("agent-board");
        const statusDot = document.getElementById("ws-status-dot");
        const statusText = document.getElementById("ws-status-text");

        // ---------------------------------------------------------------
        // Dashboard Preferences (localStorage)
        // ---------------------------------------------------------------
        const PREFS_KEY = 'cam-dashboard-prefs';

        const PANEL_REGISTRY = [
            { id: 'tasks', name: 'Task Queue' },
            { id: 'chains', name: 'Task Chains' },
            { id: 'swarms', name: 'Agent Swarm' },
            { id: 'scheduler', name: 'Task Scheduler' },
            { id: 'content', name: 'Content Calendar' },
            { id: 'pipeline', name: 'Content Pipeline' },
            { id: 'tts', name: 'Voice Synthesis' },
            { id: 'research', name: 'Research Results' },
            { id: 'business', name: 'Business Operations' },
            { id: 'service-records', name: 'Service Records' },
            { id: 'knowledge-ingest', name: 'Knowledge Ingestion' },
            { id: 'diagnostics', name: 'Diagnostic Trees' },
            { id: 'scout', name: 'Motorcycle Scout' },
            { id: 'market-analytics', name: 'Market Analytics' },
            { id: 'webhooks', name: 'Webhooks' },
            { id: 'command-palette', name: 'Command Palette' },
            { id: 'file-transfer', name: 'File Transfer' },
            { id: 'deploy', name: 'Connector Deploy' },
            { id: 'backup', name: 'Backup & Recovery' },
            { id: 'msgbus', name: 'Message Bus' },
            { id: 'context', name: 'Context Window' },
            { id: 'memory', name: 'Memory Status' },
            { id: 'analytics', name: 'Analytics' },
            { id: 'event-log', name: 'Activity Log' },
            { id: 'security', name: 'Security & Audit' },
            { id: 'self-test', name: 'System Self-Test' },
            { id: 'launch-readiness', name: 'Launch Readiness' },
            { id: 'persona', name: 'Persona' },
            { id: 'settings', name: 'Settings' },
            { id: 'agents', name: 'Agent Status Board' },
        ];

        function loadPrefs() {
            try {
                const raw = localStorage.getItem(PREFS_KEY);
                return raw ? JSON.parse(raw) : {};
            } catch (e) { return {}; }
        }

        function savePrefs(prefs) {
            try { localStorage.setItem(PREFS_KEY, JSON.stringify(prefs)); } catch (e) {}
        }

        function getPref(key, def) {
            return loadPrefs()[key] !== undefined ? loadPrefs()[key] : def;
        }

        function setPref(key, value) {
            const p = loadPrefs();
            p[key] = value;
            savePrefs(p);
        }

        function applyTheme(theme) {
            if (theme && theme !== 'dark') {
                document.documentElement.setAttribute('data-theme', theme);
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            setPref('theme', theme || 'dark');
        }

        function applyPanelVisibility() {
            const hidden = getPref('hiddenPanels', []);
            document.querySelectorAll('[data-panel-id]').forEach(el => {
                el.style.display = hidden.includes(el.dataset.panelId) ? 'none' : '';
            });
        }

        function applyPanelOrder() {
            const order = getPref('panelOrder', null);
            if (!order) return;
            document.querySelectorAll('[data-panel-id]').forEach(el => {
                const idx = order.indexOf(el.dataset.panelId);
                el.style.order = idx >= 0 ? idx : 999;
            });
        }

        function applyPanelSizes() {
            const sizes = getPref('panelSizes', {});
            document.querySelectorAll('[data-panel-id]').forEach(el => {
                const sz = sizes[el.dataset.panelId];
                if (sz && sz !== 'normal') {
                    el.setAttribute('data-panel-size', sz);
                } else {
                    el.removeAttribute('data-panel-size');
                }
            });
        }

        // Apply all saved preferences on load
        applyPanelVisibility();
        applyPanelOrder();
        applyPanelSizes();

        // Inject fullscreen buttons into all panel headers
        function injectPanelControls() {
            document.querySelectorAll('[data-panel-id]').forEach(panel => {
                const h2 = panel.querySelector('h2');
                if (!h2 || h2.querySelector('.panel-expand-btn')) return;
                const btn = document.createElement('button');
                btn.className = 'panel-expand-btn';
                btn.title = 'Toggle fullscreen';
                btn.innerHTML = '&#x26F6;';
                btn.onclick = function(e) {
                    e.stopPropagation();
                    togglePanelFullscreen(panel);
                };
                h2.appendChild(btn);
            });
        }

        function togglePanelFullscreen(panel) {
            const isFs = panel.classList.contains('panel-fullscreen');
            // Exit any existing fullscreen first
            document.querySelectorAll('.panel-fullscreen').forEach(p => p.classList.remove('panel-fullscreen'));
            if (!isFs) {
                panel.classList.add('panel-fullscreen');
                panel.scrollTop = 0;
            }
        }

        // Escape exits fullscreen
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.panel-fullscreen').forEach(p => p.classList.remove('panel-fullscreen'));
            }
        });

        // Run after a short delay to ensure DOM is ready
        setTimeout(injectPanelControls, 100);

        // ---------------------------------------------------------------
        // Auth: lock session + session expiry check
        // ---------------------------------------------------------------
        async function lockSession() {
            try {
                await fetch('/auth/lock', { method: 'POST' });
            } catch (e) {
                // ignore â€” reload will redirect anyway
            }
            window.location.reload();
        }

        async function checkAuthStatus() {
            // Returns true if still authenticated (or auth is disabled)
            try {
                const resp = await fetch('/auth/status');
                const data = await resp.json();
                return data.authenticated;
            } catch (e) {
                return true; // network error â€” don't force logout
            }
        }

        // ---------------------------------------------------------------
        // WebSocket connection
        // ---------------------------------------------------------------
        function connect() {
            const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/dashboard`);

            ws.onopen = () => {
                statusDot.classList.add("connected");
                statusText.textContent = "Connected";
                // Clear any pending reconnect
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === "agent_status") {
                    agents = data.agents;
                    renderAgents();
                } else if (data.type === "kill_switch") {
                    setKillSwitchState(data.active);
                } else if (data.type === "command_response") {
                    addChatMessage(data.agent_id, "received", data.response);
                    // Also route to command palette result if this is our pending command
                    if (pendingCommand && data.agent_id === pendingCommand.agent_id) {
                        showCommandResult(data.response, false);
                        pendingCommand = null;
                    }
                } else if (data.type === "task_status") {
                    handleTaskStatus(data);
                } else if (data.type === "task_phase") {
                    handleTaskPhase(data);
                } else if (data.type === "task_submitted") {
                    // Confirmation â€” could show a toast, for now just log
                    if (!data.ok) console.warn("Task submit failed:", data.error);
                } else if (data.type === "health_status") {
                    agentHealth = data.health || {};
                    renderAgents();
                } else if (data.type === "ping_result") {
                    handlePingResult(data);
                } else if (data.type === "event_log") {
                    handleEventLog(data.events || []);
                } else if (data.type === "event") {
                    handleNewEvent(data.event);
                } else if (data.type === "analytics") {
                    handleAnalytics(data.data);
                } else if (data.type === "command_library") {
                    commandLibrary = data.commands || [];
                    renderCommandSelect();
                } else if (data.type === "command_execute_result") {
                    handleCommandExecuteResult(data);
                } else if (data.type === "config") {
                    handleConfig(data);
                } else if (data.type === "chain_status") {
                    handleChainStatus(data);
                } else if (data.type === "chain_submitted") {
                    if (!data.ok) console.warn("Chain submit failed:", data.error);
                } else if (data.type === "swarm_status") {
                    handleSwarmStatus(data);
                } else if (data.type === "swarm_submitted") {
                    if (!data.ok) console.warn("Swarm submit failed:", data.error);
                } else if (data.type === "notification") {
                    handleNewNotification(data.notification, data.unread_count);
                } else if (data.type === "notification_history") {
                    handleNotificationHistory(data.notifications, data.unread_count);
                } else if (data.type === "notification_count") {
                    unreadCount = data.unread_count;
                    updateNotificationBadge();
                } else if (data.type === "content_calendar_status") {
                    handleContentCalendarStatus(data);
                } else if (data.type === "content_entry_created") {
                    if (!data.ok) console.warn("Content entry create failed:", data.error);
                } else if (data.type === "content_entry_deleted") {
                    if (!data.ok) console.warn("Content entry delete failed:", data.error);
                } else if (data.type === "content_entry_updated") {
                    if (!data.ok) console.warn("Content entry update failed:", data.error);
                } else if (data.type === "pipeline_status") {
                    handlePipelineStatus(data);
                } else if (data.type === "pipeline_created") {
                    if (!data.ok) console.warn("Pipeline create failed:", data.error);
                } else if (data.type === "pipeline_approved") {
                    if (!data.ok) console.warn("Pipeline approve failed:", data.error);
                } else if (data.type === "pipeline_rejected") {
                    if (!data.ok) console.warn("Pipeline reject failed:", data.error);
                } else if (data.type === "pipeline_cancelled") {
                    if (!data.ok) console.warn("Pipeline cancel failed:", data.error);
                } else if (data.type === "tts_status") {
                    handleTTSStatus(data);
                } else if (data.type === "tts_result") {
                    handleTTSResult(data);
                } else if (data.type === "tts_audio_list") {
                    handleTTSAudioList(data);
                } else if (data.type === "tts_voices") {
                    handleTTSVoices(data);
                } else if (data.type === "tts_deleted") {
                    if (!data.ok) console.warn("TTS delete failed:", data.error);
                } else if (data.type === "tts_queue_result") {
                    handleTTSQueueResult(data);
                } else if (data.type === "research_status") {
                    handleResearchStatus(data);
                } else if (data.type === "research_result_deleted") {
                    if (!data.ok) console.warn("Research entry delete failed:", data.error);
                } else if (data.type === "research_search_results") {
                    handleResearchSearchResults(data);
                } else if (data.type === "business_status") {
                    handleBusinessStatus(data);
                } else if (data.type === "business_customer_deleted") {
                    if (!data.ok) console.warn("Business customer delete failed");
                } else if (data.type === "business_appointment_deleted") {
                    if (!data.ok) console.warn("Business appointment delete failed");
                } else if (data.type === "business_invoice_deleted") {
                    if (!data.ok) console.warn("Business invoice delete failed");
                } else if (data.type === "business_inventory_deleted") {
                    if (!data.ok) console.warn("Business inventory delete failed");
                } else if (data.type === "service_records_status") {
                    handleServiceRecordsStatus(data);
                } else if (data.type === "service_vehicle_deleted") {
                    if (!data.ok) console.warn("Service vehicle delete failed");
                } else if (data.type === "service_record_deleted") {
                    if (!data.ok) console.warn("Service record delete failed");
                } else if (data.type === "service_record_pdf_result") {
                    handleServiceRecordPdf(data);
                } else if (data.type === "knowledge_status") {
                    handleKnowledgeStatus(data);
                } else if (data.type === "knowledge_scan_result") {
                    if (!data.ok) console.warn("Knowledge inbox scan failed");
                } else if (data.type === "diagnostics_status") {
                    handleDiagnosticsStatus(data);
                } else if (data.type === "diag_session_started") {
                    handleDiagSessionStarted(data);
                } else if (data.type === "diag_answer_result") {
                    handleDiagAnswerResult(data);
                } else if (data.type === "diag_go_back_result") {
                    handleDiagGoBackResult(data);
                } else if (data.type === "diag_ai_suggest_result") {
                    handleDiagAiSuggestResult(data);
                } else if (data.type === "diag_complete_result") {
                    handleDiagCompleteResult(data);
                } else if (data.type === "diag_abandon_result") {
                    handleDiagAbandonResult(data);
                } else if (data.type === "diag_reload_result") {
                    if (data.ok) console.log("Diagnostic trees reloaded:", data.trees_loaded);
                } else if (data.type === "diag_notes_result") {
                    // Notes saved silently
                } else if (data.type === "scout_status") {
                    handleScoutStatus(data);
                } else if (data.type === "scout_scan_result") {
                    if (!data.ok) console.warn("Scout scan failed:", data.error);
                } else if (data.type === "scout_deleted") {
                    if (!data.ok) console.warn("Scout delete failed:", data.error);
                } else if (data.type === "scout_rescored") {
                    if (!data.ok) console.warn("Scout rescore failed:", data.error);
                } else if (data.type === "market_analytics_status") {
                    handleMarketAnalytics(data);
                } else if (data.type === "market_snapshot_result") {
                    if (data.ok) {
                        const btn = document.getElementById("market-snapshot-btn");
                        if (btn) { btn.disabled = false; btn.textContent = "Take Snapshot"; }
                    } else {
                        console.warn("Market snapshot failed:", data.error);
                        const btn = document.getElementById("market-snapshot-btn");
                        if (btn) { btn.disabled = false; btn.textContent = "Take Snapshot"; }
                    }
                } else if (data.type === "market_report_result") {
                    const btn = document.getElementById("market-report-btn");
                    if (btn) { btn.disabled = false; btn.textContent = "Generate Report"; }
                    if (!data.ok) console.warn("Market report failed:", data.error);
                } else if (data.type === "market_history_result") {
                    handleMarketHistoryResult(data);
                } else if (data.type === "webhook_status") {
                    handleWebhookStatus(data);
                } else if (data.type === "webhook_registered") {
                    if (data.ok) handleWebhookStatus(); // refresh via stored state
                } else if (data.type === "webhook_updated") {
                    if (data.ok) handleWebhookStatus();
                } else if (data.type === "webhook_deleted") {
                    if (data.ok) handleWebhookStatus();
                } else if (data.type === "webhook_toggled") {
                    if (data.ok) handleWebhookStatus();
                } else if (data.type === "webhook_test_result") {
                    if (!data.ok) console.warn("Webhook test failed:", data.error);
                } else if (data.type === "webhook_delivery_history_result") {
                    if (data.deliveries) {
                        webhookData.recent_deliveries = data.deliveries;
                        renderWebhookDeliveries();
                    }
                } else if (data.type === "approval_request") {
                    handleApprovalRequest(data);
                } else if (data.type === "security_audit_status") {
                    handleSecurityAuditStatus(data);
                } else if (data.type === "security_audit_filtered") {
                    handleSecurityAuditFiltered(data);
                } else if (data.type === "self_test_results") {
                    renderSelfTestResults(data);
                } else if (data.type === "launch_readiness_progress") {
                    handleLRProgress(data);
                } else if (data.type === "launch_readiness_results") {
                    renderLRResults(data);
                } else if (data.type === "schedule_status") {
                    handleScheduleStatus(data);
                } else if (data.type === "schedule_created") {
                    if (!data.ok) console.warn("Schedule create failed:", data.error);
                } else if (data.type === "schedule_deleted") {
                    if (!data.ok) console.warn("Schedule delete failed:", data.error);
                } else if (data.type === "schedule_toggled") {
                    if (!data.ok) console.warn("Schedule toggle failed:", data.error);
                } else if (data.type === "schedule_updated") {
                    if (!data.ok) console.warn("Schedule update failed:", data.error);
                } else if (data.type === "file_transfer_progress") {
                    handleTransferProgress(data);
                } else if (data.type === "file_transfer_history") {
                    handleTransferHistory(data);
                } else if (data.type === "deploy_status") {
                    handleDeployStatus(data);
                } else if (data.type === "deploy_version_result") {
                    handleDeployVersionResult(data);
                } else if (data.type === "deploy_result") {
                    handleDeployResult(data);
                } else if (data.type === "deploy_progress") {
                    handleDeployProgress(data);
                } else if (data.type === "backup_status") {
                    handleBackupStatus(data);
                } else if (data.type === "backup_result") {
                    handleBackupResult(data);
                } else if (data.type === "backup_restore_result") {
                    handleBackupRestoreResult(data);
                } else if (data.type === "bus_status") {
                    handleBusStatus(data);
                } else if (data.type === "bus_message") {
                    handleBusMessage(data);
                } else if (data.type === "bus_publish_result") {
                    if (data.ok === false) console.warn("Bus publish failed");
                } else if (data.type === "bus_history_result") {
                    handleBusStatus(data);
                } else if (data.type === "context_status") {
                    handleContextStatus(data);
                } else if (data.type === "memory_status") {
                    handleMemoryStatus(data);
                } else if (data.type === "episodic_search_results") {
                    handleEpisodicSearchResults(data);
                } else if (data.type === "persona") {
                    handlePersona(data);
                } else if (data.type === "telegram_status") {
                    const dot = document.getElementById("tg-status-dot");
                    if (dot) {
                        data.connected ? dot.classList.add("connected") : dot.classList.remove("connected");
                    }
                }
            };

            ws.onclose = async (event) => {
                statusDot.classList.remove("connected");
                statusText.textContent = "Disconnected â€” retrying...";

                // If server rejected with 4401 (not authenticated), redirect to login
                if (event.code === 4401) {
                    window.location.reload();
                    return;
                }

                // Check if session expired before attempting reconnect
                const authed = await checkAuthStatus();
                if (!authed) {
                    window.location.reload();
                    return;
                }

                // Auto-reconnect after 3 seconds
                reconnectTimer = setTimeout(connect, 3000);
            };

            ws.onerror = () => {
                // onclose will fire after this, which handles reconnect
                ws.close();
            };
        }

        // ---------------------------------------------------------------
        // Render agent cards
        // ---------------------------------------------------------------
        function renderAgents() {
            if (agents.length === 0) {
                board.innerHTML = `
                    <div class="empty-state">
                        <h3>No agents connected</h3>
                        <p>Agents will appear here when they connect via WebSocket.<br>
                        Endpoint: <code>ws://&lt;dashboard-ip&gt;:8080/ws/agent/&lt;agent-id&gt;</code></p>
                    </div>
                `;
                return;
            }

            // Save any in-progress input text before re-render
            const savedInputs = {};
            document.querySelectorAll(".chat-input").forEach(input => {
                if (input.value) {
                    savedInputs[input.dataset.agentId] = input.value;
                }
            });

            // Sort: online agents first, then alphabetical by name
            const sorted = [...agents].sort((a, b) => {
                if (a.status !== b.status) return a.status === "online" ? -1 : 1;
                return a.name.localeCompare(b.name);
            });

            board.innerHTML = '<div class="agent-grid">' +
                sorted.map(agent => agentCard(agent)).join("") +
                '</div>';

            // Restore saved input text
            for (const [agentId, value] of Object.entries(savedInputs)) {
                const input = document.querySelector(`.chat-input[data-agent-id="${agentId}"]`);
                if (input) input.value = value;
            }

            // Auto-scroll chat logs to bottom
            document.querySelectorAll(".chat-log").forEach(log => {
                log.scrollTop = log.scrollHeight;
            });
        }

        function agentCard(agent) {
            const isOnline = agent.status === "online" || agent.status === "busy";
            const statusClass = agent.status === "busy" ? "busy" : (isOnline ? "online" : "offline");
            const agentId = agent.agent_id;
            const messages = chatLogs[agentId] || [];

            // Render chat message history
            const chatHtml = messages.map(m => {
                const prefix = m.type === "sent" ? "you>" : "agent>";
                const cssClass = m.type === "error" ? "error" : m.type;
                return `<div class="chat-msg ${cssClass}"><span class="chat-prefix">${prefix}</span>${escapeHtml(m.text)}</div>`;
            }).join("");

            return `
                <div class="agent-card">
                    <div class="agent-card-header">
                        <div class="agent-name">${escapeHtml(agent.name)}</div>
                        <div class="agent-status-badge ${statusClass}">
                            <div class="dot"></div>
                            ${agent.status}
                        </div>
                    </div>
                    <div class="agent-details">
                        <div class="agent-detail">
                            <span class="label">IP Address</span>
                            <span class="value">${escapeHtml(agent.ip_address)}</span>
                        </div>
                        <div class="agent-detail">
                            <span class="label">Uptime</span>
                            <span class="value">${formatUptime(agent.connected_at, isOnline)}</span>
                        </div>
                        <div class="agent-detail">
                            <span class="label">Heartbeats</span>
                            <span class="value">${agent.heartbeat_count ?? 0}</span>
                        </div>
                        <div class="agent-detail">
                            <span class="label">Last Seen</span>
                            <span class="value">${formatTime(agent.last_heartbeat)}</span>
                        </div>
                    </div>
                    ${renderHealthSection(agentId, isOnline)}
                    ${renderCapabilities(agent.capabilities)}
                    <div class="agent-chat">
                        <div class="chat-log" id="chat-log-${agentId}">${chatHtml}</div>
                        <div class="chat-input-row">
                            <input type="text"
                                class="chat-input"
                                data-agent-id="${agentId}"
                                placeholder="Send command..."
                                onkeydown="if(event.key==='Enter')sendCommand('${agentId}')"
                                ${isOnline ? "" : "disabled"}>
                            <button class="chat-send-btn"
                                onclick="sendCommand('${agentId}')"
                                ${isOnline ? "" : "disabled"}>Send</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ---------------------------------------------------------------
        // Kill switch
        // ---------------------------------------------------------------
        let killSwitchActive = false;

        function killSwitch() {
            if (killSwitchActive) return;
            // Confirmation â€” this is a big red button, make sure they mean it
            if (!confirm("KILL SWITCH: This will shut down ALL connected agents immediately.\n\nAre you sure?")) {
                return;
            }
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "kill_switch" }));
            }
        }

        function setKillSwitchState(active) {
            killSwitchActive = active;
            const btn = document.getElementById("kill-switch-btn");
            const status = document.getElementById("kill-switch-status");
            if (active) {
                btn.classList.add("activated");
                btn.textContent = "Kill Switch Active";
                status.classList.add("active");
            } else {
                btn.classList.remove("activated");
                btn.textContent = "Kill Switch";
                status.classList.remove("active");
            }
        }

        // ---------------------------------------------------------------
        // Agent commands
        // ---------------------------------------------------------------
        function sendCommand(agentId) {
            const input = document.querySelector(`.chat-input[data-agent-id="${agentId}"]`);
            if (!input) return;
            const text = input.value.trim();
            if (!text) return;

            // Show the sent message in the chat log
            addChatMessage(agentId, "sent", text);

            // Send to server for routing to the agent
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "command",
                    agent_id: agentId,
                    command: text,
                }));
            }

            input.value = "";
            input.focus();
        }

        function addChatMessage(agentId, type, text) {
            // type: "sent", "received", or "error"
            if (!chatLogs[agentId]) chatLogs[agentId] = [];
            chatLogs[agentId].push({ type, text });

            // Keep last 50 messages per agent to avoid unbounded growth
            if (chatLogs[agentId].length > 50) {
                chatLogs[agentId] = chatLogs[agentId].slice(-50);
            }

            // Update the chat log in the DOM directly (avoid full re-render)
            const logEl = document.getElementById(`chat-log-${agentId}`);
            if (logEl) {
                const prefix = type === "sent" ? "you>" : "agent>";
                const cssClass = type === "error" ? "error" : type;
                const msgEl = document.createElement("div");
                msgEl.className = `chat-msg ${cssClass}`;
                msgEl.innerHTML = `<span class="chat-prefix">${prefix}</span>${escapeHtml(text)}`;
                logEl.appendChild(msgEl);
                logEl.scrollTop = logEl.scrollHeight;
            }
        }

        // ---------------------------------------------------------------
        // Agent health
        // ---------------------------------------------------------------
        function renderHealthSection(agentId, isOnline) {
            const h = agentHealth[agentId];
            if (!h) return "";

            const level = h.health_level || "green";
            const levelLabels = { green: "Healthy", yellow: "Degraded", red: "Unhealthy" };
            const missed = h.missed_heartbeats || 0;
            const latency = h.heartbeat_latency_ms != null ? `${h.heartbeat_latency_ms}ms` : "\u2014";
            const completed = h.tasks_completed || 0;
            const failed = h.tasks_failed || 0;
            const active = h.active_tasks || 0;
            const rate = h.success_rate != null ? h.success_rate : 100;
            const rtt = h.last_ping_rtt_ms != null ? `${h.last_ping_rtt_ms}ms` : "\u2014";

            const barColor = rate >= 75 ? "green" : (rate >= 50 ? "yellow" : "red");

            return `
                <div class="agent-health">
                    <div class="health-indicator">
                        <div class="health-dot ${level}"></div>
                        <span class="health-label ${level}">${levelLabels[level]}</span>
                    </div>
                    <div class="health-row">
                        <span class="label">HB Latency</span>
                        <span class="value">${latency}</span>
                    </div>
                    <div class="health-row">
                        <span class="label">Missed HBs</span>
                        <span class="value${missed > 0 ? ' warn' : ''}">${missed}</span>
                    </div>
                    <div class="health-row">
                        <span class="label">Tasks</span>
                        <span class="value">${completed} ok / ${failed} fail</span>
                    </div>
                    <div class="health-row">
                        <span class="label">Load</span>
                        <span class="value">${active} active</span>
                    </div>
                    <div class="health-row">
                        <span class="label">Success Rate</span>
                        <span class="value">${rate.toFixed(0)}%</span>
                    </div>
                    <div class="health-bar-container">
                        <div class="health-bar-fill ${barColor}" style="width:${rate}%"></div>
                    </div>
                    <div class="ping-row">
                        <button class="ping-btn"
                            onclick="pingAgent('${agentId}')"
                            ${isOnline ? '' : 'disabled'}
                            id="ping-btn-${agentId}">Ping</button>
                        <span class="ping-result" id="ping-result-${agentId}">${rtt !== "\u2014" ? rtt : ""}</span>
                    </div>
                </div>
            `;
        }

        function pingAgent(agentId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: "ping_agent", agent_id: agentId }));

            // Show pinging state
            const resultEl = document.getElementById(`ping-result-${agentId}`);
            if (resultEl) resultEl.textContent = "pinging...";
            const btn = document.getElementById(`ping-btn-${agentId}`);
            if (btn) btn.disabled = true;

            // Re-enable after 5s timeout
            setTimeout(() => {
                if (btn) btn.disabled = false;
                if (resultEl && resultEl.textContent === "pinging...") {
                    resultEl.textContent = "timeout";
                }
            }, 5000);
        }

        function handlePingResult(data) {
            const agentId = data.agent_id;
            const resultEl = document.getElementById(`ping-result-${agentId}`);
            const btn = document.getElementById(`ping-btn-${agentId}`);

            if (resultEl) {
                if (data.error) {
                    resultEl.textContent = data.error;
                } else if (data.rtt_ms != null) {
                    resultEl.textContent = `${data.rtt_ms}ms`;
                }
            }
            if (btn) btn.disabled = false;
        }

        // ---------------------------------------------------------------
        // Utility functions
        // ---------------------------------------------------------------
        function formatTime(isoString) {
            if (!isoString) return "\u2014";
            const date = new Date(isoString);
            const now = new Date();
            const diffSec = Math.floor((now - date) / 1000);

            if (diffSec < 5) return "just now";
            if (diffSec < 60) return `${diffSec}s ago`;
            if (diffSec < 3600) return `${Math.floor(diffSec / 60)}m ${diffSec % 60}s ago`;
            if (diffSec < 86400) {
                const h = Math.floor(diffSec / 3600);
                const m = Math.floor((diffSec % 3600) / 60);
                return `${h}h ${m}m ago`;
            }
            return date.toLocaleString();
        }

        function formatUptime(isoString, isOnline) {
            if (!isoString) return "\u2014";
            if (!isOnline) return "offline";
            const date = new Date(isoString);
            const now = new Date();
            const diffSec = Math.floor((now - date) / 1000);

            if (diffSec < 60) return `${diffSec}s`;
            if (diffSec < 3600) {
                const m = Math.floor(diffSec / 60);
                const s = diffSec % 60;
                return `${m}m ${s}s`;
            }
            const h = Math.floor(diffSec / 3600);
            const m = Math.floor((diffSec % 3600) / 60);
            if (h < 24) return `${h}h ${m}m`;
            const d = Math.floor(h / 24);
            return `${d}d ${h % 24}h`;
        }

        function renderCapabilities(caps) {
            if (!caps || caps.length === 0) return "";
            const badges = caps.map(c =>
                `<span class="capability-badge">${escapeHtml(c)}</span>`
            ).join("");
            return `<div class="agent-capabilities">${badges}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement("div");
            div.textContent = text;
            return div.innerHTML;
        }

        // ---------------------------------------------------------------
        // Event Log
        // ---------------------------------------------------------------
        let eventLog = [];
        const MAX_DISPLAY_EVENTS = 500;

        function handleEventLog(events) {
            eventLog = events;
            renderEventLog();
        }

        function handleNewEvent(event) {
            eventLog.push(event);
            // Trim oldest if over limit
            if (eventLog.length > MAX_DISPLAY_EVENTS) {
                eventLog = eventLog.slice(-MAX_DISPLAY_EVENTS);
            }
            appendEventEntry(event);
        }

        function renderEventLog() {
            const container = document.getElementById("event-log");
            if (eventLog.length === 0) {
                container.innerHTML = '<div class="event-empty">No events yet. Activity will appear here.</div>';
                return;
            }
            container.innerHTML = eventLog.map(e => eventEntryHtml(e)).join("");
            container.scrollTop = container.scrollHeight;
        }

        function appendEventEntry(event) {
            const container = document.getElementById("event-log");
            // Remove empty state if present
            const empty = container.querySelector(".event-empty");
            if (empty) empty.remove();

            const wasAtBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 40;

            const div = document.createElement("div");
            div.className = "event-entry";
            div.innerHTML = eventEntryInner(event);
            container.appendChild(div);

            // Auto-scroll only if user was already at the bottom
            if (wasAtBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }

        function eventEntryHtml(event) {
            return `<div class="event-entry">${eventEntryInner(event)}</div>`;
        }

        function eventEntryInner(event) {
            const time = formatEventTime(event.timestamp);
            const sev = (event.severity || "INFO").toLowerCase();
            const cat = event.category || "";
            const msg = event.message || "";
            const msgClass = sev === "error" ? " error" : (sev === "warn" ? " warn" : "");
            return `<span class="event-time">${time}</span>`
                + `<span class="event-severity ${sev}">${event.severity}</span>`
                + `<span class="event-category">[${escapeHtml(cat)}]</span>`
                + `<span class="event-message${msgClass}">${escapeHtml(msg)}</span>`;
        }

        function formatEventTime(isoString) {
            if (!isoString) return "";
            const d = new Date(isoString);
            return d.toLocaleTimeString("en-US", { hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit" });
        }

        function clearEventLog() {
            eventLog = [];
            renderEventLog();
        }

        function exportEventLog() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            fetch("/api/events/export", { method: "POST" })
                .then(r => r.json())
                .then(data => {
                    if (data.ok) {
                        alert(`Exported ${data.event_count} events to ${data.filepath}`);
                    }
                })
                .catch(err => console.error("Export failed:", err));
        }

        // ---------------------------------------------------------------
        // Task Queue
        // ---------------------------------------------------------------
        let tasks = [];
        let taskCounts = { pending: 0, running: 0, completed: 0, failed: 0 };
        let activePhase = null;   // { task_id, phase, detail }
        let phaseClearTimer = null;

        function submitTask() {
            const input = document.getElementById("task-input");
            const select = document.getElementById("task-complexity");
            const capsInput = document.getElementById("task-capabilities");
            const desc = input.value.trim();
            if (!desc) return;

            const caps = capsInput.value
                .split(",")
                .map(s => s.trim())
                .filter(s => s.length > 0);

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "task_submit",
                    description: desc,
                    complexity: select.value,
                    required_capabilities: caps,
                }));
            }
            input.value = "";
            capsInput.value = "";
            input.focus();
        }

        function handleTaskStatus(data) {
            tasks = data.tasks || [];
            taskCounts = data.counts || taskCounts;
            renderTaskStats();
            renderTaskHistory();
        }

        function handleTaskPhase(data) {
            // Clear any pending phase-clear timer
            if (phaseClearTimer) {
                clearTimeout(phaseClearTimer);
                phaseClearTimer = null;
            }

            activePhase = {
                task_id: data.task_id,
                short_id: data.short_id,
                phase: data.phase,
                detail: data.detail || "",
            };
            renderActiveTask();

            // Clear the phase indicator 3s after terminal states
            if (data.phase === "COMPLETED" || data.phase === "FAILED") {
                phaseClearTimer = setTimeout(() => {
                    activePhase = null;
                    renderActiveTask();
                }, 3000);
            }
        }

        function renderTaskStats() {
            document.getElementById("stat-pending").textContent = taskCounts.pending || 0;
            document.getElementById("stat-running").textContent = taskCounts.running || 0;
            document.getElementById("stat-completed").textContent = taskCounts.completed || 0;
            document.getElementById("stat-failed").textContent = taskCounts.failed || 0;
        }

        function renderActiveTask() {
            const panel = document.getElementById("task-active-panel");
            if (!activePhase) {
                panel.classList.add("hidden");
                return;
            }

            panel.classList.remove("hidden");

            // Find the task description from our list
            const task = tasks.find(t => t.task_id === activePhase.task_id);
            document.getElementById("task-active-title").textContent =
                task ? task.description : activePhase.short_id;
            document.getElementById("task-active-id").textContent = activePhase.short_id;

            // Update OATI phase boxes
            const phaseOrder = ["OBSERVE", "THINK", "ACT", "ITERATE"];
            const currentIdx = phaseOrder.indexOf(activePhase.phase);
            const isFinal = activePhase.phase === "COMPLETED" || activePhase.phase === "FAILED";

            document.querySelectorAll("#oati-phases .oati-phase").forEach(el => {
                const phaseName = el.dataset.phase;
                const idx = phaseOrder.indexOf(phaseName);
                el.className = "oati-phase";

                if (isFinal) {
                    // All phases complete â€” mark them green or red
                    el.classList.add(activePhase.phase === "COMPLETED" ? "done" : "failed");
                } else if (idx < currentIdx) {
                    el.classList.add("done");
                } else if (idx === currentIdx) {
                    el.classList.add("active");
                }
            });

            document.getElementById("task-active-detail").textContent = activePhase.detail;
        }

        function renderTaskHistory() {
            const container = document.getElementById("task-history");
            if (tasks.length === 0) {
                container.innerHTML = '<div class="task-empty-state">No tasks yet. Submit one above.</div>';
                return;
            }

            container.innerHTML = tasks.map(t => {
                const resultHtml = t.result
                    ? `<div class="task-result">${escapeHtml(String(t.result))}</div>`
                    : "";

                const timeStr = t.completed_at
                    ? formatTime(t.completed_at)
                    : formatTime(t.created_at);

                const caps = (t.required_capabilities || []);
                const capBadges = caps.length > 0
                    ? caps.map(c => `<span class="capability-badge">${escapeHtml(c)}</span>`).join("")
                    : "";

                return `
                    <div class="task-item">
                        <div class="task-item-header">
                            <div class="task-item-left">
                                <span class="task-id">${escapeHtml(t.short_id)}</span>
                                <span class="task-status-badge ${t.status}">${t.status}</span>
                                <span class="task-status-badge" style="background:rgba(91,155,213,0.1);color:var(--primary)">${escapeHtml(t.complexity)}</span>
                                ${capBadges}
                            </div>
                            <span class="task-meta">${escapeHtml(t.source)} &middot; ${timeStr}</span>
                        </div>
                        <div class="task-description">${escapeHtml(t.description)}</div>
                        ${resultHtml}
                    </div>
                `;
            }).join("");
        }

        // Update relative timestamps every 5 seconds (uptime + last seen + tasks)
        setInterval(() => {
            if (agents.length > 0) renderAgents();
            if (tasks.length > 0) renderTaskHistory();
        }, 5000);

        // ---------------------------------------------------------------
        // Context Window
        // ---------------------------------------------------------------

        function handleContextStatus(data) {
            // Usage percentage + progress bar
            const pct = data.usage_pct || 0;
            const pctEl = document.getElementById("ctx-usage-pct");
            if (pctEl) pctEl.textContent = pct.toFixed(1) + "%";

            const bar = document.getElementById("ctx-usage-bar");
            if (bar) {
                bar.style.width = pct + "%";
                bar.className = "memory-usage-fill";
                if (pct > 90) bar.classList.add("critical");
                else if (pct > 70) bar.classList.add("warning");
            }

            // Token counts
            const totalEl = document.getElementById("ctx-total-tokens");
            if (totalEl) totalEl.textContent = (data.session_total_tokens || 0).toLocaleString();

            const promptEl = document.getElementById("ctx-prompt-tokens");
            if (promptEl) promptEl.textContent = (data.session_prompt_tokens || 0).toLocaleString();

            const respEl = document.getElementById("ctx-response-tokens");
            if (respEl) respEl.textContent = (data.session_response_tokens || 0).toLocaleString();

            // Model and limit
            const modelEl = document.getElementById("ctx-model");
            if (modelEl) modelEl.textContent = data.current_model || "--";

            const limitEl = document.getElementById("ctx-limit");
            if (limitEl) limitEl.textContent = (data.context_limit || 0).toLocaleString();

            // Rotation info
            const rotCountEl = document.getElementById("ctx-rotation-count");
            if (rotCountEl) rotCountEl.textContent = data.rotation_count || 0;

            const threshEl = document.getElementById("ctx-threshold");
            if (threshEl) threshEl.textContent = (data.rotation_threshold_pct || 90) + "%";

            const startEl = document.getElementById("ctx-session-start");
            if (startEl) {
                startEl.textContent = data.session_start
                    ? new Date(data.session_start).toLocaleString()
                    : "--";
            }

            const lastRotEl = document.getElementById("ctx-last-rotation");
            if (lastRotEl) {
                lastRotEl.textContent = data.last_rotation_at
                    ? new Date(data.last_rotation_at).toLocaleString()
                    : "None";
            }
        }

        // ---------------------------------------------------------------
        // Memory Status
        // ---------------------------------------------------------------

        function handleMemoryStatus(data) {
            const stm = data.short_term || {};
            const wm = data.working || {};
            const ltm = data.long_term || {};

            // Short-term memory cards
            const stmCount = stm.message_count || 0;
            const stmMax = stm.max_messages || 0;
            const stmPct = stm.usage_pct || 0;
            const summaries = stm.summary_count || 0;

            document.getElementById("mem-stm-count").textContent = stmCount;
            document.getElementById("mem-stm-max").textContent = stmMax;
            document.getElementById("mem-stm-summaries").textContent = summaries;

            // Usage bar with color thresholds
            const bar = document.getElementById("mem-stm-bar");
            bar.style.width = stmPct + "%";
            bar.className = "memory-usage-fill";
            if (stmPct > 90) bar.classList.add("critical");
            else if (stmPct > 70) bar.classList.add("warning");

            // Working memory
            const wmCount = wm.active_count || 0;
            const wmEntries = wm.entries || [];
            document.getElementById("mem-wm-count").textContent = wmCount;

            // Render working memory entries
            const container = document.getElementById("mem-working-entries");
            if (wmEntries.length === 0) {
                container.innerHTML = '<div class="analytics-empty">No active tasks in working memory.</div>';
            } else {
                container.innerHTML = wmEntries.map(e => `
                    <div class="memory-working-entry">
                        <span class="entry-desc" title="${e.description || ''}">${e.short_id} â€” ${e.description || 'Unknown'}</span>
                        <span class="entry-phase">${e.phase || '?'}</span>
                    </div>
                `).join("");
            }

            // Long-term memory
            const ltmTotal = ltm.total_count || 0;
            const ltmCounts = ltm.counts_by_category || {};
            const ltmInitialized = ltm.initialized || false;
            const ltmError = ltm.error || null;

            document.getElementById("mem-ltm-total").textContent = ltmTotal;
            document.getElementById("mem-ltm-knowledge").textContent = ltmCounts.knowledge || 0;
            document.getElementById("mem-ltm-task-result").textContent = ltmCounts.task_result || 0;
            document.getElementById("mem-ltm-preference").textContent = ltmCounts.user_preference || 0;
            document.getElementById("mem-ltm-learning").textContent = ltmCounts.system_learning || 0;

            const statusEl = document.getElementById("mem-ltm-status");
            if (ltmError) {
                statusEl.textContent = "Error: " + ltmError;
                statusEl.className = "ltm-status error";
            } else if (ltmInitialized) {
                statusEl.textContent = "Collection: " + (ltm.collection_name || "cam_long_term");
                statusEl.className = "ltm-status";
            } else {
                statusEl.textContent = "Not initialized";
                statusEl.className = "ltm-status";
            }

            // Episodic memory
            const ep = data.episodic || {};
            document.getElementById("mem-episodic-total").textContent = ep.total_count || 0;
            document.getElementById("mem-episodic-today").textContent = ep.count_today || 0;

            // Format oldest/newest as short dates
            const oldest = ep.oldest_timestamp;
            const newest = ep.newest_timestamp;
            document.getElementById("mem-episodic-oldest").textContent =
                oldest ? new Date(oldest).toLocaleDateString() : "--";
            document.getElementById("mem-episodic-newest").textContent =
                newest ? new Date(newest).toLocaleDateString() : "--";

            const epStatus = document.getElementById("mem-episodic-status");
            epStatus.textContent = "Retention: " + (ep.retention_days || 365) + " days";
        }

        function searchEpisodes() {
            const input = document.getElementById("episodic-search-input");
            const keyword = (input.value || "").trim();
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({
                type: "episodic_search",
                keyword: keyword,
                limit: 50,
            }));
        }

        function handleEpisodicSearchResults(data) {
            const container = document.getElementById("episodic-results");
            const episodes = data.episodes || [];

            if (episodes.length === 0) {
                container.innerHTML = '<div class="analytics-empty">No episodes found.</div>';
                return;
            }

            container.innerHTML = episodes.map(ep => {
                const time = new Date(ep.timestamp);
                const timeStr = time.toLocaleString(undefined, {
                    month: "short", day: "numeric",
                    hour: "2-digit", minute: "2-digit",
                });
                const participant = ep.participant || "system";
                const content = (ep.content || "").substring(0, 200);
                return `
                    <div class="episodic-entry">
                        <span class="episodic-participant ${participant}">${participant}</span>
                        <span class="episodic-content" title="${ep.content || ''}">${content}</span>
                        <span class="episodic-time">${timeStr}</span>
                    </div>
                `;
            }).join("");
        }

        // Enter key triggers episodic search
        document.getElementById("episodic-search-input")
            .addEventListener("keydown", function(e) {
                if (e.key === "Enter") searchEpisodes();
            });

        // Analytics
        // ---------------------------------------------------------------
        let analyticsData = null;

        function handleAnalytics(data) {
            analyticsData = data;
            renderAnalytics();
        }

        function renderAnalytics() {
            if (!analyticsData) return;
            const d = analyticsData;

            document.getElementById("an-total-tasks").textContent = formatNumber(d.total_tasks);
            document.getElementById("an-success-rate").textContent =
                d.total_tasks > 0 ? d.success_rate.toFixed(1) + "%" : "--";
            document.getElementById("an-avg-completion").textContent =
                d.total_tasks > 0 ? formatDuration(d.avg_completion_seconds) : "--";
            document.getElementById("an-model-cost").textContent = "$" + d.total_model_cost_usd.toFixed(4);
            document.getElementById("an-model-calls").textContent = formatNumber(d.total_model_calls);
            document.getElementById("an-total-tokens").textContent = formatNumber(d.total_model_tokens);

            renderAgentBarChart(d.tasks_per_agent || {});
        }

        function renderAgentBarChart(agentTasks) {
            const container = document.getElementById("agent-bar-chart");
            const entries = Object.entries(agentTasks);

            if (entries.length === 0) {
                container.innerHTML = '<div class="analytics-empty">No task data yet.</div>';
                return;
            }

            // Sort by count descending
            entries.sort((a, b) => b[1] - a[1]);
            const maxCount = entries[0][1];

            container.innerHTML = entries.map(([agent, count]) => {
                const pct = maxCount > 0 ? (count / maxCount) * 100 : 0;
                return `
                    <div class="bar-row">
                        <span class="bar-label" title="${escapeHtml(agent)}">${escapeHtml(agent)}</span>
                        <div class="bar-track">
                            <div class="bar-fill" style="width:${pct}%"></div>
                        </div>
                        <span class="bar-count">${count}</span>
                    </div>
                `;
            }).join("");
        }

        function formatDuration(seconds) {
            if (seconds == null || seconds === 0) return "--";
            if (seconds < 60) return seconds.toFixed(1) + "s";
            const m = Math.floor(seconds / 60);
            const s = Math.round(seconds % 60);
            return m + "m " + s + "s";
        }

        function formatNumber(n) {
            if (n == null) return "0";
            if (n >= 1000000) return (n / 1000000).toFixed(1) + "M";
            if (n >= 1000) return (n / 1000).toFixed(1) + "K";
            return String(n);
        }

        // ---------------------------------------------------------------
        // Command Palette
        // ---------------------------------------------------------------
        function renderCommandSelect() {
            const select = document.getElementById("cmd-select");
            // Keep the placeholder option
            select.innerHTML = '<option value="">-- Select command --</option>';
            commandLibrary.forEach(cmd => {
                const opt = document.createElement("option");
                opt.value = cmd.name;
                opt.textContent = cmd.name.replace(/_/g, " ");
                select.appendChild(opt);
            });
            updateCommandExecuteBtn();
        }

        function renderAgentSelect() {
            const select = document.getElementById("cmd-agent-select");
            const prev = select.value;
            select.innerHTML = '<option value="">-- Select agent --</option>';
            agents.filter(a => a.status === "online" || a.status === "busy").forEach(a => {
                const opt = document.createElement("option");
                opt.value = a.agent_id;
                opt.textContent = a.name + (a.status === "busy" ? " (busy)" : "");
                select.appendChild(opt);
            });
            // Restore previous selection if still valid
            if (prev && select.querySelector(`option[value="${prev}"]`)) {
                select.value = prev;
            }
            updateCommandExecuteBtn();
        }

        function onCommandSelect() {
            const cmdName = document.getElementById("cmd-select").value;
            const descEl = document.getElementById("cmd-description");
            const paramsEl = document.getElementById("cmd-params");

            if (!cmdName) {
                descEl.textContent = "";
                paramsEl.innerHTML = "";
                updateCommandExecuteBtn();
                return;
            }

            const cmd = commandLibrary.find(c => c.name === cmdName);
            if (!cmd) return;

            descEl.textContent = cmd.description;

            // Render parameter inputs
            if (cmd.parameters && cmd.parameters.length > 0) {
                paramsEl.innerHTML = cmd.parameters.map(p => {
                    const placeholder = p.required ? "required" : (p.default || "optional");
                    return `
                        <div class="command-param-group">
                            <label>${escapeHtml(p.name)}:</label>
                            <input type="text"
                                data-param="${escapeHtml(p.name)}"
                                placeholder="${escapeHtml(placeholder)}"
                                value="${p.default && !p.required ? escapeHtml(p.default) : ''}">
                        </div>
                    `;
                }).join("");
            } else {
                paramsEl.innerHTML = "";
            }
            updateCommandExecuteBtn();
        }

        function updateCommandExecuteBtn() {
            const cmdName = document.getElementById("cmd-select").value;
            const agentId = document.getElementById("cmd-agent-select").value;
            const btn = document.getElementById("cmd-execute-btn");

            // Check required params are filled
            let paramsOk = true;
            if (cmdName) {
                const cmd = commandLibrary.find(c => c.name === cmdName);
                if (cmd && cmd.parameters) {
                    cmd.parameters.filter(p => p.required).forEach(p => {
                        const input = document.querySelector(`#cmd-params input[data-param="${p.name}"]`);
                        if (!input || !input.value.trim()) paramsOk = false;
                    });
                }
            }

            btn.disabled = !cmdName || !agentId || !paramsOk;
        }

        function executeCommand() {
            const cmdName = document.getElementById("cmd-select").value;
            const agentId = document.getElementById("cmd-agent-select").value;
            if (!cmdName || !agentId) return;

            // Gather params
            const params = {};
            document.querySelectorAll("#cmd-params input[data-param]").forEach(input => {
                const val = input.value.trim();
                if (val) params[input.dataset.param] = val;
            });

            // Show pending state in result panel
            const panel = document.getElementById("cmd-result-panel");
            panel.classList.add("visible");
            panel.innerHTML = `<div class="result-header">${escapeHtml(cmdName)} â†’ ${escapeHtml(agentId)}</div>`
                + `<div class="result-pending">Waiting for response...</div>`;

            // Track this as pending so we can route the response
            pendingCommand = { agent_id: agentId, command_name: cmdName };

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "command_execute",
                    command_name: cmdName,
                    agent_id: agentId,
                    params: params,
                }));
            }
        }

        function handleCommandExecuteResult(data) {
            if (!data.ok) {
                showCommandResult(data.error || "Command failed", true);
                pendingCommand = null;
            }
            // If ok, we wait for the command_response broadcast from the agent
        }

        function showCommandResult(text, isError) {
            const panel = document.getElementById("cmd-result-panel");
            const header = panel.querySelector(".result-header");
            const headerText = header ? header.textContent : "";
            panel.classList.add("visible");
            panel.innerHTML = `<div class="result-header">${escapeHtml(headerText)}</div>`
                + `<div class="${isError ? 'result-error' : ''}">${escapeHtml(text)}</div>`;
        }

        // Update agent dropdown whenever agents change
        const _origRenderAgents = renderAgents;
        renderAgents = function() {
            _origRenderAgents();
            renderAgentSelect();
        };

        // Also listen for param input changes to update execute button
        document.getElementById("cmd-params").addEventListener("input", updateCommandExecuteBtn);
        document.getElementById("cmd-agent-select").addEventListener("change", updateCommandExecuteBtn);

        // ---------------------------------------------------------------
        // Task Chains
        // ---------------------------------------------------------------
        let chains = [];
        let chainBuilderSteps = [];

        function handleChainStatus(data) {
            chains = data.chains || [];
            renderChains();
        }

        function renderChains() {
            const container = document.getElementById("chain-list");
            if (chains.length === 0) {
                container.innerHTML = '<div class="chain-empty">No chains yet. Build one above or click "Load Test Chain" to try it out.</div>';
                return;
            }

            container.innerHTML = chains.map(chain => {
                const status = chain.status;
                const current = chain.current_step;
                const total = chain.total_steps;
                const pct = total > 0 ? Math.round((countCompletedSteps(chain) / total) * 100) : 0;
                const progressClass = status === "failed" ? "failed" : (status === "completed" ? "completed" : "running");

                const stepsHtml = chain.steps.map((step, i) => {
                    let stepClass = "";
                    if (step.status === "completed") {
                        stepClass = "done";
                    } else if (step.status === "failed") {
                        stepClass = "failed";
                    } else if (step.status === "running") {
                        stepClass = "active";
                    }
                    const label = "Step " + (i + 1);
                    return `<div class="chain-step ${stepClass}" title="${escapeHtml(step.description.substring(0, 100))}">${label}</div>`;
                }).join("");

                return `
                    <div class="chain-card">
                        <div class="chain-card-header">
                            <div class="chain-card-left">
                                <span class="chain-card-name">${escapeHtml(chain.name)}</span>
                                <span class="chain-card-id">${escapeHtml(chain.short_id)}</span>
                            </div>
                            <span class="chain-status-badge ${status}">${status}</span>
                        </div>
                        <div class="chain-progress-bar">
                            <div class="chain-progress-fill ${progressClass}" style="width:${pct}%"></div>
                        </div>
                        <div class="chain-steps">${stepsHtml}</div>
                    </div>
                `;
            }).join("");
        }

        function countCompletedSteps(chain) {
            return chain.steps.filter(s => s.status === "completed").length;
        }

        function addChainStep() {
            chainBuilderSteps.push({ description: "", complexity: "low", capabilities: "" });
            renderChainBuilder();
        }

        function removeChainStep(i) {
            chainBuilderSteps.splice(i, 1);
            renderChainBuilder();
        }

        function renderChainBuilder() {
            const container = document.getElementById("chain-step-rows");
            if (chainBuilderSteps.length === 0) {
                container.innerHTML = "";
                return;
            }

            container.innerHTML = chainBuilderSteps.map((step, i) => `
                <div class="chain-step-row">
                    <span class="chain-step-num">${i + 1}</span>
                    <input type="text" placeholder="Step description..."
                        value="${escapeHtml(step.description)}"
                        oninput="chainBuilderSteps[${i}].description=this.value">
                    <select onchange="chainBuilderSteps[${i}].complexity=this.value">
                        <option value="low" ${step.complexity === "low" ? "selected" : ""}>LOW</option>
                        <option value="medium" ${step.complexity === "medium" ? "selected" : ""}>MEDIUM</option>
                        <option value="high" ${step.complexity === "high" ? "selected" : ""}>HIGH</option>
                    </select>
                    <input type="text" placeholder="Capabilities..."
                        value="${escapeHtml(step.capabilities || "")}"
                        oninput="chainBuilderSteps[${i}].capabilities=this.value"
                        style="max-width:140px">
                    <button class="chain-step-remove" onclick="removeChainStep(${i})" title="Remove step">&times;</button>
                </div>
            `).join("");
        }

        function submitChain() {
            const nameInput = document.getElementById("chain-name-input");
            const name = nameInput.value.trim();
            if (!name) { nameInput.focus(); return; }
            if (chainBuilderSteps.length === 0) return;

            // Validate steps have descriptions
            const validSteps = chainBuilderSteps.filter(s => s.description.trim());
            if (validSteps.length === 0) return;

            const steps = validSteps.map(s => ({
                description: s.description.trim(),
                complexity: s.complexity,
                required_capabilities: s.capabilities
                    ? s.capabilities.split(",").map(c => c.trim()).filter(c => c)
                    : [],
            }));

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "chain_submit",
                    name: name,
                    steps: steps,
                }));
            }

            // Clear builder
            nameInput.value = "";
            chainBuilderSteps = [];
            renderChainBuilder();
        }

        function loadTestChain() {
            document.getElementById("chain-name-input").value = "System Info â†’ Analyze â†’ Summarize";
            chainBuilderSteps = [
                {
                    description: "system_info",
                    complexity: "low",
                    capabilities: "system_info",
                },
                {
                    description: "Analyze the following system information and identify any potential issues, resource bottlenecks, or notable observations.",
                    complexity: "medium",
                    capabilities: "",
                },
                {
                    description: "Summarize the analysis into 3-5 concise bullet points suitable for a status report.",
                    complexity: "low",
                    capabilities: "",
                },
            ];
            renderChainBuilder();
        }

        // ---------------------------------------------------------------
        // Agent Swarm
        // ---------------------------------------------------------------
        let swarms = [];
        let swarmBuilderSubtasks = [];

        function handleSwarmStatus(data) {
            swarms = data.swarms || [];
            renderSwarms();
        }

        function renderSwarms() {
            const container = document.getElementById("swarm-list");
            if (!container) return;

            if (swarms.length === 0) {
                container.innerHTML = '<div class="swarm-empty">No swarms yet. Build one above or click "Load Test Swarm" to try it out.</div>';
                return;
            }

            container.innerHTML = swarms.map(s => {
                const statusClass = s.status;
                const progressClass = s.status === 'completed' ? 'completed' : s.status === 'failed' ? 'failed' : '';
                const done = (s.subtasks || []).filter(t => t.status === 'completed' || t.status === 'failed').length;
                const total = (s.subtasks || []).length;

                // Hub-and-spoke visualization
                const objectiveText = s.objective.length > 60 ? s.objective.slice(0, 57) + '...' : s.objective;
                const spokes = (s.subtasks || []).map(t => {
                    const label = t.description.length > 25 ? t.description.slice(0, 22) + '...' : t.description;
                    const agent = t.assigned_agent || '';
                    return `<div class="swarm-spoke">
                        <div class="swarm-spoke-line"></div>
                        <div class="swarm-spoke-node">
                            <span class="swarm-spoke-dot ${t.status}"></span>
                            <span title="${escapeHtml(t.description)}">${escapeHtml(label)}</span>
                        </div>
                        ${agent ? `<span class="swarm-spoke-agent">${escapeHtml(agent)}</span>` : ''}
                    </div>`;
                }).join('');

                // Result preview for completed swarms
                let resultHtml = '';
                if (s.status === 'completed' && s.final_result) {
                    const preview = String(s.final_result).length > 400
                        ? String(s.final_result).slice(0, 397) + '...'
                        : String(s.final_result);
                    resultHtml = `<div class="swarm-result-preview">${escapeHtml(preview)}</div>`;
                }
                if (s.status === 'failed' && s.final_result) {
                    resultHtml = `<div class="swarm-result-preview" style="border-left: 2px solid #ef4444;">${escapeHtml(String(s.final_result))}</div>`;
                }

                return `<div class="swarm-card">
                    <div class="swarm-card-header">
                        <div>
                            <span class="swarm-card-name">${escapeHtml(s.name)}</span>
                            <span class="swarm-card-id">(${s.short_id})</span>
                        </div>
                        <span class="swarm-badge ${statusClass}">${s.status}</span>
                    </div>
                    <div class="swarm-progress">
                        <div class="swarm-progress-bar ${progressClass}" style="width: ${s.progress_pct}%"></div>
                    </div>
                    <div class="swarm-progress-label">${done}/${total} subtasks done${s.has_partial_failure ? ' (partial failure)' : ''}</div>
                    <div class="swarm-hub">
                        <div class="swarm-objective-pill" title="${escapeHtml(s.objective)}">${escapeHtml(objectiveText)}</div>
                        <div class="swarm-spokes">${spokes}</div>
                    </div>
                    ${resultHtml}
                </div>`;
            }).join('');
        }

        // Builder functions
        function renderSwarmBuilder() {
            const container = document.getElementById("swarm-subtask-rows");
            if (!container) return;

            container.innerHTML = swarmBuilderSubtasks.map((sub, i) => `
                <div class="swarm-subtask-row">
                    <span style="font-size:0.75rem;color:var(--text-tertiary);min-width:18px;">${i + 1}.</span>
                    <input type="text" value="${escapeHtml(sub.description)}" placeholder="Subtask description..."
                           onchange="swarmBuilderSubtasks[${i}].description = this.value">
                    <select onchange="swarmBuilderSubtasks[${i}].complexity = this.value">
                        <option value="auto" ${sub.complexity === 'auto' ? 'selected' : ''}>Auto</option>
                        <option value="low" ${sub.complexity === 'low' ? 'selected' : ''}>Low</option>
                        <option value="medium" ${sub.complexity === 'medium' ? 'selected' : ''}>Medium</option>
                        <option value="high" ${sub.complexity === 'high' ? 'selected' : ''}>High</option>
                    </select>
                    <input type="text" class="swarm-caps-input" value="${escapeHtml(sub.capabilities)}" placeholder="capabilities..."
                           onchange="swarmBuilderSubtasks[${i}].capabilities = this.value">
                    <button onclick="swarmBuilderSubtasks.splice(${i}, 1); renderSwarmBuilder();">x</button>
                </div>
            `).join('');
        }

        function addSwarmSubtask() {
            swarmBuilderSubtasks.push({ description: '', complexity: 'auto', capabilities: '' });
            renderSwarmBuilder();
            // Focus the new input
            setTimeout(() => {
                const rows = document.querySelectorAll('#swarm-subtask-rows .swarm-subtask-row input[type="text"]');
                if (rows.length) rows[rows.length - 2]?.focus();
            }, 50);
        }

        function submitSwarm() {
            const name = (document.getElementById("swarm-name-input")?.value || "").trim();
            const objective = (document.getElementById("swarm-objective-input")?.value || "").trim();
            if (!name || !objective) {
                alert("Swarm name and objective are required.");
                return;
            }

            const subtasks = swarmBuilderSubtasks
                .filter(s => s.description.trim())
                .map(s => ({
                    description: s.description.trim(),
                    complexity: s.complexity || "auto",
                    required_capabilities: s.capabilities ? s.capabilities.split(",").map(c => c.trim()).filter(Boolean) : [],
                }));

            if (subtasks.length === 0) {
                alert("Add at least one subtask with a description.");
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "swarm_submit",
                    name: name,
                    objective: objective,
                    subtasks: subtasks,
                }));
            }

            // Clear builder
            document.getElementById("swarm-name-input").value = "";
            document.getElementById("swarm-objective-input").value = "";
            swarmBuilderSubtasks = [];
            renderSwarmBuilder();
        }

        function loadTestSwarm() {
            document.getElementById("swarm-name-input").value = "Motorcycle Market Research";
            document.getElementById("swarm-objective-input").value = "Research the current Portland-area motorcycle market for Doppler Cycles";
            swarmBuilderSubtasks = [
                {
                    description: "Research Portland metro motorcycle registration stats, popular models, and riding season patterns",
                    complexity: "medium",
                    capabilities: "research",
                },
                {
                    description: "Find and compare competing mobile motorcycle mechanics and diagnostic services in the Portland area",
                    complexity: "medium",
                    capabilities: "research",
                },
                {
                    description: "Draft a 30-second elevator pitch for Doppler Cycles based on market positioning",
                    complexity: "medium",
                    capabilities: "content",
                },
            ];
            renderSwarmBuilder();
        }

        // ---------------------------------------------------------------
        // Task Scheduler
        // ---------------------------------------------------------------
        let schedules = [];

        function handleScheduleStatus(data) {
            schedules = data.schedules || [];
            renderSchedules();
        }

        function onScheduleTypeChange() {
            const type = document.getElementById("sched-type").value;
            document.getElementById("sched-interval-group").style.display =
                type === "interval" ? "" : "none";
            document.getElementById("sched-time-group").style.display =
                type === "daily" ? "" : "none";
        }

        function createSchedule() {
            const nameInput = document.getElementById("sched-name");
            const descInput = document.getElementById("sched-desc");
            const name = nameInput.value.trim();
            const description = descInput.value.trim();
            if (!name) { nameInput.focus(); return; }
            if (!description) { descInput.focus(); return; }

            const schedule_type = document.getElementById("sched-type").value;
            const complexity = document.getElementById("sched-complexity").value;
            const interval_seconds = parseInt(document.getElementById("sched-interval").value) || 300;
            const run_at_time = document.getElementById("sched-time").value.trim() || "09:00";
            const capsStr = document.getElementById("sched-caps").value.trim();
            const required_capabilities = capsStr
                ? capsStr.split(",").map(c => c.trim()).filter(c => c)
                : [];

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "schedule_create",
                    name, description, complexity, schedule_type,
                    interval_seconds, run_at_time, required_capabilities,
                }));
            }

            // Clear form
            nameInput.value = "";
            descInput.value = "";
            document.getElementById("sched-caps").value = "";
        }

        function toggleSchedule(id) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "schedule_toggle", schedule_id: id }));
            }
        }

        function deleteSchedule(id) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "schedule_delete", schedule_id: id }));
            }
        }

        function formatScheduleTime(isoStr) {
            if (!isoStr) return "â€”";
            try {
                const d = new Date(isoStr);
                return d.toLocaleTimeString("en-US", {
                    hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit"
                }) + " " + d.toLocaleDateString("en-US", { month: "short", day: "numeric" });
            } catch (e) {
                return isoStr;
            }
        }

        function renderSchedules() {
            const container = document.getElementById("schedule-list");
            if (schedules.length === 0) {
                container.innerHTML = '<div class="schedule-empty">No scheduled tasks yet.</div>';
                return;
            }

            container.innerHTML = schedules.map(s => {
                const enabledClass = s.enabled ? "on" : "off";
                const enabledLabel = s.enabled ? "Enabled" : "Disabled";
                const cardClass = s.enabled ? "" : " disabled";
                const toggleLabel = s.enabled ? "Disable" : "Enable";
                const typeLabel = s.schedule_type.toUpperCase();

                let timingInfo = "";
                if (s.schedule_type === "interval") {
                    timingInfo = "Every " + s.interval_seconds + "s";
                } else if (s.schedule_type === "daily") {
                    timingInfo = "Daily at " + escapeHtml(s.run_at_time) + " UTC";
                } else {
                    timingInfo = "One-time";
                }

                return `
                    <div class="schedule-card${cardClass}">
                        <div class="schedule-card-header">
                            <div class="schedule-card-left">
                                <span class="schedule-card-name">${escapeHtml(s.name)}</span>
                                <span class="schedule-card-id">${escapeHtml(s.short_id)}</span>
                                <span class="schedule-enabled-badge ${enabledClass}">${enabledLabel}</span>
                                <span class="schedule-type-badge">${typeLabel}</span>
                            </div>
                            <div class="schedule-card-actions">
                                <button class="schedule-card-btn" onclick="toggleSchedule('${s.schedule_id}')">${toggleLabel}</button>
                                <button class="schedule-card-btn danger" onclick="deleteSchedule('${s.schedule_id}')">Delete</button>
                            </div>
                        </div>
                        <div class="schedule-card-meta">
                            <span>${timingInfo}</span>
                            <span>Runs: ${s.run_count}</span>
                            <span>Next: ${formatScheduleTime(s.next_run_at)}</span>
                            <span>Last: ${formatScheduleTime(s.last_run_at)}</span>
                        </div>
                    </div>
                `;
            }).join("");
        }

        // ---------------------------------------------------------------
        // Content Calendar
        // ---------------------------------------------------------------
        let contentEntries = [];

        const CONTENT_STATUS_ORDER = {
            idea: 0, planned: 1, in_progress: 2, review: 3, published: 4, archived: 5,
        };

        function handleContentCalendarStatus(data) {
            contentEntries = data.entries || [];
            renderContentCalendar();
        }

        function createContentEntry() {
            const titleInput = document.getElementById("content-title");
            const descInput = document.getElementById("content-desc");
            const title = titleInput.value.trim();
            const description = descInput.value.trim();
            if (!title) { titleInput.focus(); return; }

            const content_type = document.getElementById("content-type").value;
            const scheduled_date = document.getElementById("content-date").value || null;

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "content_entry_create",
                    title, description, content_type, scheduled_date,
                }));
            }

            // Clear form
            titleInput.value = "";
            descInput.value = "";
            document.getElementById("content-date").value = "";
        }

        function updateContentStatus(entryId, newStatus) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "content_entry_update",
                    entry_id: entryId,
                    status: newStatus,
                }));
            }
        }

        function deleteContentEntry(entryId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "content_entry_delete",
                    entry_id: entryId,
                }));
            }
        }

        function renderContentCalendar() {
            const container = document.getElementById("content-list");
            if (contentEntries.length === 0) {
                container.innerHTML = '<div class="content-empty">No content entries yet.</div>';
                return;
            }

            // Sort by status priority (active first), then by updated_at
            const sorted = [...contentEntries].sort((a, b) => {
                const sa = CONTENT_STATUS_ORDER[a.status] ?? 9;
                const sb = CONTENT_STATUS_ORDER[b.status] ?? 9;
                if (sa !== sb) return sa - sb;
                return (b.updated_at || "").localeCompare(a.updated_at || "");
            });

            const statuses = ["idea", "planned", "in_progress", "review", "published", "archived"];

            container.innerHTML = sorted.map(e => {
                const typeLabel = (e.content_type || "general").replace(/_/g, " ").toUpperCase();
                const statusClass = e.status || "idea";
                const statusLabel = (e.status || "idea").replace(/_/g, " ");

                let dateInfo = "";
                if (e.scheduled_date) {
                    dateInfo = `<span>Target: ${escapeHtml(e.scheduled_date)}</span>`;
                }

                const statusOptions = statuses.map(s => {
                    const sel = s === e.status ? " selected" : "";
                    const label = s.replace(/_/g, " ");
                    return `<option value="${s}"${sel}>${label}</option>`;
                }).join("");

                return `
                    <div class="content-card">
                        <div class="content-card-header">
                            <div class="content-card-left">
                                <span class="content-card-title">${escapeHtml(e.title)}</span>
                                <span class="content-card-id">${escapeHtml(e.short_id)}</span>
                                <span class="content-status-badge ${statusClass}">${statusLabel}</span>
                                <span class="content-type-badge">${typeLabel}</span>
                            </div>
                            <div class="content-card-actions">
                                <select onchange="updateContentStatus('${e.entry_id}', this.value)">
                                    ${statusOptions}
                                </select>
                                <button class="content-card-btn danger" onclick="deleteContentEntry('${e.entry_id}')">Delete</button>
                            </div>
                        </div>
                        <div class="content-card-meta">
                            ${e.description ? `<span>${escapeHtml(e.description.substring(0, 100))}</span>` : ""}
                            ${dateInfo}
                        </div>
                    </div>
                `;
            }).join("");
        }

        // ---------------------------------------------------------------
        // Content Pipeline (Kanban)
        // ---------------------------------------------------------------

        let pipelineData = { pipelines: [], status: { total: 0, by_stage: {}, by_status: {} } };

        const PIPELINE_STAGES = ["research", "outline", "script", "review", "tts", "package", "done"];

        function handlePipelineStatus(data) {
            pipelineData = {
                pipelines: data.pipelines || [],
                status: data.status || { total: 0, by_stage: {}, by_status: {} },
            };
            renderPipeline();
        }

        function renderPipeline() {
            // Update stats bar
            const st = pipelineData.status;
            const byStatus = st.by_status || {};
            const byStage = st.by_stage || {};
            const el = (id) => document.getElementById(id);
            if (el("pl-stat-active")) el("pl-stat-active").textContent = byStatus.active || 0;
            if (el("pl-stat-review")) el("pl-stat-review").textContent = byStage.review || 0;
            if (el("pl-stat-completed")) el("pl-stat-completed").textContent = byStatus.completed || 0;
            if (el("pl-stat-failed")) el("pl-stat-failed").textContent = byStatus.failed || 0;

            const kanban = document.getElementById("pipeline-kanban");
            if (!kanban) return;

            if (pipelineData.pipelines.length === 0) {
                kanban.innerHTML = '<div class="pipeline-empty">No pipelines yet. Enter a title and topic above to start.</div>';
                return;
            }

            // Build columns
            kanban.innerHTML = PIPELINE_STAGES.map(stage => {
                const cards = pipelineData.pipelines
                    .filter(p => p.stage === stage)
                    .map(p => renderPipelineCard(p, stage))
                    .join("");
                return `
                    <div class="pipeline-column">
                        <div class="pipeline-col-header ${stage}">${stage.toUpperCase()}</div>
                        ${cards}
                    </div>
                `;
            }).join("");
        }

        function renderPipelineCard(p, stage) {
            const pid = p.pipeline_id;
            const shortId = pid.substring(0, 8);
            let statusClass = "";
            if (p.status === "paused") statusClass = " paused";
            else if (p.status === "failed") statusClass = " failed";
            else if (p.status === "cancelled") statusClass = " cancelled";

            let actions = "";
            if (stage === "review" && p.status === "paused") {
                actions = `
                    <div class="pipeline-card-actions">
                        <button class="pipeline-btn-approve" onclick="approvePipeline('${pid}')">Approve</button>
                        <button class="pipeline-btn-reject" onclick="rejectPipeline('${pid}')">Reject</button>
                    </div>
                `;
            } else if (p.status === "active" || p.status === "paused") {
                actions = `
                    <div class="pipeline-card-actions">
                        <button class="pipeline-btn-cancel" onclick="cancelPipeline('${pid}')">Cancel</button>
                    </div>
                `;
            }

            return `
                <div class="pipeline-card">
                    <div class="pipeline-card-title">${escapeHtml(p.title)}</div>
                    <div class="pipeline-card-topic">${escapeHtml((p.topic || "").substring(0, 60))}</div>
                    <div class="pipeline-card-status${statusClass}">${p.status} &middot; ${shortId}</div>
                    ${actions}
                </div>
            `;
        }

        function createPipeline() {
            const titleInput = document.getElementById("pipeline-title");
            const topicInput = document.getElementById("pipeline-topic");
            const title = titleInput.value.trim();
            const topic = topicInput.value.trim();
            if (!title) { titleInput.focus(); return; }
            if (!topic) { topicInput.focus(); return; }
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "pipeline_create", title, topic }));
            }
            titleInput.value = "";
            topicInput.value = "";
        }

        function approvePipeline(pipelineId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "pipeline_approve", pipeline_id: pipelineId }));
            }
        }

        function rejectPipeline(pipelineId) {
            const notes = prompt("Rejection reason (optional):");
            if (notes === null) return;  // user cancelled
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "pipeline_reject", pipeline_id: pipelineId, notes }));
            }
        }

        function cancelPipeline(pipelineId) {
            if (!confirm("Cancel this pipeline?")) return;
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "pipeline_cancel", pipeline_id: pipelineId }));
            }
        }

        // ---------------------------------------------------------------
        // Voice Synthesis (TTS)
        // ---------------------------------------------------------------

        function handleTTSStatus(data) {
            const el = document.getElementById("tts-status");
            if (!el) return;

            const dotClass = data.initialized ? "ok" : "error";
            let statusText = "";

            if (data.initialized) {
                statusText = `Piper ready â€” ${data.voice_count} voice(s), ${data.audio_count} audio file(s)`;
            } else if (data.error) {
                statusText = data.error;
            } else {
                statusText = "TTS not initialized";
            }

            el.innerHTML = `<span class="tts-status-dot ${dotClass}"></span><span>${escapeHtml(statusText)}</span>`;
        }

        function handleTTSVoices(data) {
            const select = document.getElementById("tts-voice");
            if (!select) return;

            // Preserve current selection
            const current = select.value;
            select.innerHTML = '<option value="">Default voice</option>';

            (data.voices || []).forEach(v => {
                const opt = document.createElement("option");
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });

            // Restore selection if still available
            if (current) select.value = current;
        }

        function handleTTSAudioList(data) {
            const container = document.getElementById("tts-audio-list");
            if (!container) return;

            const audioFiles = data.audio || [];
            if (audioFiles.length === 0) {
                container.innerHTML = '<div class="tts-empty">No audio files yet.</div>';
                return;
            }

            container.innerHTML = audioFiles.map(a => {
                const text = a.text ? escapeHtml(a.text.substring(0, 120)) : "(no text)";
                const voice = a.voice || "unknown";
                const duration = a.duration_secs ? `${a.duration_secs.toFixed(1)}s` : "";
                const size = a.file_size_bytes ? formatBytes(a.file_size_bytes) : "";
                const ts = a.timestamp ? new Date(a.timestamp).toLocaleString() : "";
                const filename = a.filename || "";
                const audioSrc = filename ? `/api/tts/audio/${encodeURIComponent(filename)}` : "";

                return `
                    <div class="tts-item">
                        <div class="tts-item-header">
                            <div class="tts-item-meta">
                                <span class="tts-voice-badge">${escapeHtml(voice)}</span>
                                ${duration ? `<span>${duration}</span>` : ""}
                                ${size ? `<span>${size}</span>` : ""}
                                ${ts ? `<span>${ts}</span>` : ""}
                            </div>
                            <div class="tts-item-actions">
                                <button class="tts-delete-btn" onclick="ttsDeleteAudio('${escapeHtml(filename)}')">Delete</button>
                            </div>
                        </div>
                        <div class="tts-item-text">${text}</div>
                        ${audioSrc ? `<audio controls preload="none" src="${audioSrc}"></audio>` : ""}
                    </div>
                `;
            }).join("");
        }

        function handleTTSResult(data) {
            const btn = document.getElementById("tts-synthesize-btn");
            if (btn) {
                btn.disabled = false;
                btn.textContent = "Synthesize";
            }

            if (!data.ok) {
                const errorMsg = data.error || "Synthesis failed";
                console.warn("TTS synthesis failed:", errorMsg);
                // Show inline error
                const statusEl = document.getElementById("tts-status");
                if (statusEl) {
                    const prev = statusEl.innerHTML;
                    statusEl.innerHTML = `<span class="tts-status-dot error"></span><span style="color:var(--danger)">${escapeHtml(errorMsg)}</span>`;
                    setTimeout(() => { statusEl.innerHTML = prev; }, 5000);
                }
                return;
            }

            // Refresh the audio list
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "tts_list_audio" }));
                ws.send(JSON.stringify({ type: "tts_status" }));
            }
        }

        function handleTTSQueueResult(data) {
            // Refresh audio list after batch synthesis
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "tts_list_audio" }));
                ws.send(JSON.stringify({ type: "tts_status" }));
            }
        }

        function ttsSynthesize() {
            const textEl = document.getElementById("tts-text");
            const voiceEl = document.getElementById("tts-voice");
            const btn = document.getElementById("tts-synthesize-btn");
            if (!textEl || !ws || ws.readyState !== WebSocket.OPEN) return;

            const text = textEl.value.trim();
            if (!text) return;

            const voice = voiceEl ? voiceEl.value : "";

            btn.disabled = true;
            btn.textContent = "Synthesizing...";

            const msg = { type: "tts_synthesize", text: text };
            if (voice) msg.voice = voice;
            ws.send(JSON.stringify(msg));

            // Clear the textarea after sending
            textEl.value = "";
        }

        function ttsDeleteAudio(filename) {
            if (!confirm("Delete this audio file?")) return;
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: "tts_delete", filename: filename }));
        }

        function formatBytes(bytes) {
            if (bytes === 0) return "0 B";
            const k = 1024;
            const sizes = ["B", "KB", "MB", "GB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
        }

        // ---------------------------------------------------------------
        // Research Results
        // ---------------------------------------------------------------
        let researchEntries = [];

        function handleResearchStatus(data) {
            researchEntries = data.entries || [];
            renderResearchResults();
        }

        function handleResearchSearchResults(data) {
            researchEntries = data.entries || [];
            renderResearchResults();
        }

        function deleteResearchEntry(entryId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "research_result_delete",
                    entry_id: entryId,
                }));
            }
        }

        function searchResearch() {
            const input = document.getElementById("research-search-input");
            const keyword = input.value.trim();
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "research_search",
                    keyword: keyword,
                }));
            }
        }

        function renderResearchResults() {
            const container = document.getElementById("research-list");
            if (researchEntries.length === 0) {
                container.innerHTML = '<div class="research-empty">No research results yet.</div>';
                return;
            }

            container.innerHTML = researchEntries.map(e => {
                const statusClass = e.status || "in_progress";
                const statusLabel = (e.status || "in_progress").replace(/_/g, " ");
                const summaryPreview = e.summary
                    ? escapeHtml(e.summary.substring(0, 200)) + (e.summary.length > 200 ? "..." : "")
                    : "<em>No summary yet</em>";
                const costStr = e.cost_usd > 0 ? `$${e.cost_usd.toFixed(4)}` : "â€”";
                const modelStr = e.model_used || "â€”";

                return `
                    <div class="research-card">
                        <div class="research-card-header">
                            <div class="research-card-left">
                                <span class="research-card-query">${escapeHtml(e.query.substring(0, 120))}</span>
                                <span class="research-card-id">${escapeHtml(e.short_id)}</span>
                                <span class="research-status-badge ${statusClass}">${statusLabel}</span>
                            </div>
                            <div class="research-card-actions">
                                <button class="content-card-btn danger" onclick="deleteResearchEntry('${e.entry_id}')">Delete</button>
                            </div>
                        </div>
                        <div class="research-card-meta">
                            <span>Sources: ${e.source_count || 0}</span>
                            <span>Pages: ${e.pages_fetched || 0}</span>
                            <span>Model: ${escapeHtml(modelStr)}</span>
                            <span>Tokens: ${e.tokens_used || 0}</span>
                            <span>Cost: ${costStr}</span>
                        </div>
                        <div class="research-card-summary">${summaryPreview}</div>
                    </div>
                `;
            }).join("");
        }

        // ---------------------------------------------------------------
        // Business Operations
        // ---------------------------------------------------------------
        let bizCustomers = [];
        let bizAppointments = [];
        let bizInvoices = [];
        let bizInventory = [];
        let bizStatus = {};
        let activeBizTab = "appointments";

        function switchBizTab(tab, btn) {
            activeBizTab = tab;
            document.querySelectorAll(".biz-filter-btn").forEach(b => b.classList.remove("active"));
            if (btn) btn.classList.add("active");
            document.querySelectorAll(".biz-tab-content").forEach(el => el.classList.remove("active"));
            const target = document.getElementById("biz-tab-" + tab);
            if (target) target.classList.add("active");
        }

        function handleBusinessStatus(data) {
            bizCustomers = data.customers || [];
            bizAppointments = data.appointments || [];
            bizInvoices = data.invoices || [];
            bizInventory = data.inventory || [];
            bizStatus = data.status || {};
            renderBizAppointments();
            renderBizCustomers();
            renderBizInvoices();
            renderBizInventory();
            updateBizStats();
            populateBizCustomerDropdowns();
        }

        function updateBizStats() {
            const el = document.getElementById("biz-stats");
            if (!el) return;
            const s = bizStatus;
            el.innerHTML = `${s.customer_count || 0} customers &middot; `
                + `${s.upcoming_appointments || 0} upcoming &middot; `
                + `$${(s.total_revenue || 0).toFixed(0)} revenue &middot; `
                + (s.low_stock_count > 0 ? `<span style="color:var(--warning)">${s.low_stock_count} low stock</span>` : "0 low stock");
        }

        function populateBizCustomerDropdowns() {
            const selectors = ["biz-appt-customer", "biz-inv-customer"];
            selectors.forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;
                const current = sel.value;
                sel.innerHTML = '<option value="">-- Customer --</option>';
                bizCustomers.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c.customer_id;
                    opt.textContent = c.name;
                    opt.dataset.name = c.name;
                    opt.dataset.bike = c.bike_info || "";
                    sel.appendChild(opt);
                });
                if (current) sel.value = current;
            });
        }

        // --- Customers ---
        function createCustomer() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const name = document.getElementById("biz-cust-name").value.trim();
            if (!name) return;
            ws.send(JSON.stringify({
                type: "business_customer_create",
                name: name,
                phone: document.getElementById("biz-cust-phone").value.trim(),
                email: document.getElementById("biz-cust-email").value.trim(),
                bike_info: document.getElementById("biz-cust-bike").value.trim(),
                notes: document.getElementById("biz-cust-notes").value.trim(),
            }));
            document.getElementById("biz-cust-name").value = "";
            document.getElementById("biz-cust-phone").value = "";
            document.getElementById("biz-cust-email").value = "";
            document.getElementById("biz-cust-bike").value = "";
            document.getElementById("biz-cust-notes").value = "";
        }

        function deleteCustomer(customerId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            if (!confirm("Delete this customer?")) return;
            ws.send(JSON.stringify({ type: "business_customer_delete", customer_id: customerId }));
        }

        function renderBizCustomers() {
            const container = document.getElementById("biz-customer-list");
            if (!container) return;
            if (bizCustomers.length === 0) {
                container.innerHTML = '<div class="biz-empty">No customers yet.</div>';
                return;
            }
            container.innerHTML = bizCustomers.map(c => `
                <div class="biz-card">
                    <div class="biz-card-info">
                        <div class="biz-card-title">${escapeHtml(c.name)}</div>
                        <div class="biz-card-meta">
                            ${c.phone ? escapeHtml(c.phone) + " &middot; " : ""}${c.email ? escapeHtml(c.email) + " &middot; " : ""}${c.bike_info ? escapeHtml(c.bike_info) : ""}
                        </div>
                        ${c.notes ? '<div class="biz-card-meta">' + escapeHtml(c.notes) + '</div>' : ''}
                    </div>
                    <div class="biz-card-actions">
                        <button class="biz-card-btn danger" onclick="deleteCustomer('${c.customer_id}')">Del</button>
                    </div>
                </div>
            `).join("");
        }

        // --- Appointments ---
        function createAppointment() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const sel = document.getElementById("biz-appt-customer");
            const opt = sel.options[sel.selectedIndex];
            const customerId = sel.value;
            const customerName = opt && opt.dataset ? (opt.dataset.name || "") : "";
            ws.send(JSON.stringify({
                type: "business_appointment_create",
                customer_id: customerId,
                customer_name: customerName,
                date: document.getElementById("biz-appt-date").value,
                time: document.getElementById("biz-appt-time").value,
                bike: document.getElementById("biz-appt-bike").value.trim(),
                service_type: document.getElementById("biz-appt-service").value.trim(),
                location: document.getElementById("biz-appt-location").value.trim(),
                estimated_cost: document.getElementById("biz-appt-cost").value || 0,
            }));
            document.getElementById("biz-appt-bike").value = "";
            document.getElementById("biz-appt-service").value = "";
            document.getElementById("biz-appt-location").value = "";
            document.getElementById("biz-appt-cost").value = "";
        }

        function updateAppointmentStatus(apptId, status) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({
                type: "business_appointment_update",
                appointment_id: apptId,
                status: status,
            }));
        }

        function deleteAppointment(apptId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            if (!confirm("Delete this appointment?")) return;
            ws.send(JSON.stringify({ type: "business_appointment_delete", appointment_id: apptId }));
        }

        function renderBizAppointments() {
            const container = document.getElementById("biz-appointment-list");
            if (!container) return;
            if (bizAppointments.length === 0) {
                container.innerHTML = '<div class="biz-empty">No appointments yet.</div>';
                return;
            }
            const statusOrder = { scheduled: 0, confirmed: 1, in_progress: 2, completed: 3, cancelled: 4, no_show: 5 };
            const sorted = [...bizAppointments].sort((a, b) => {
                const sa = statusOrder[a.status] ?? 9;
                const sb = statusOrder[b.status] ?? 9;
                if (sa !== sb) return sa - sb;
                return (b.date || "").localeCompare(a.date || "");
            });
            const apptStatuses = ["scheduled", "confirmed", "in_progress", "completed", "cancelled", "no_show"];
            container.innerHTML = sorted.map(a => {
                const statusOpts = apptStatuses.map(s =>
                    `<option value="${s}"${s === a.status ? " selected" : ""}>${s.replace(/_/g, " ")}</option>`
                ).join("");
                return `
                <div class="biz-card">
                    <div class="biz-card-info">
                        <div class="biz-card-title">
                            <span class="biz-status-badge ${a.status}">${(a.status || "").replace(/_/g, " ")}</span>
                            ${escapeHtml(a.customer_name || "Unknown")} &mdash; ${escapeHtml(a.service_type || "Service")}
                        </div>
                        <div class="biz-card-meta">
                            ${a.date || "No date"} ${a.time || ""} &middot; ${escapeHtml(a.bike || "")} &middot; ${escapeHtml(a.location || "")}
                            ${a.estimated_cost > 0 ? " &middot; Est: $" + a.estimated_cost.toFixed(0) : ""}
                        </div>
                        ${a.notes ? '<div class="biz-card-meta">' + escapeHtml(a.notes) + '</div>' : ''}
                    </div>
                    <div class="biz-card-actions">
                        <select class="biz-card-btn" onchange="updateAppointmentStatus('${a.appointment_id}', this.value)">
                            ${statusOpts}
                        </select>
                        <button class="biz-card-btn danger" onclick="deleteAppointment('${a.appointment_id}')">Del</button>
                    </div>
                </div>
                `;
            }).join("");
        }

        // --- Invoices ---
        function createInvoice() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const sel = document.getElementById("biz-inv-customer");
            const opt = sel.options[sel.selectedIndex];
            const customerId = sel.value;
            const customerName = opt && opt.dataset ? (opt.dataset.name || "") : "";
            ws.send(JSON.stringify({
                type: "business_invoice_create",
                customer_id: customerId,
                customer_name: customerName,
                labor_hours: parseFloat(document.getElementById("biz-inv-labor-hours").value) || 0,
                labor_rate: parseFloat(document.getElementById("biz-inv-labor-rate").value) || 75,
                notes: document.getElementById("biz-inv-notes").value.trim(),
            }));
            document.getElementById("biz-inv-labor-hours").value = "";
            document.getElementById("biz-inv-notes").value = "";
        }

        function updateInvoiceStatus(invoiceId, status) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({
                type: "business_invoice_update",
                invoice_id: invoiceId,
                status: status,
            }));
        }

        function deleteInvoice(invoiceId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            if (!confirm("Delete this invoice?")) return;
            ws.send(JSON.stringify({ type: "business_invoice_delete", invoice_id: invoiceId }));
        }

        function renderBizInvoices() {
            const container = document.getElementById("biz-invoice-list");
            if (!container) return;
            if (bizInvoices.length === 0) {
                container.innerHTML = '<div class="biz-empty">No invoices yet.</div>';
                return;
            }
            const invStatuses = ["draft", "sent", "paid", "overdue", "cancelled"];
            container.innerHTML = bizInvoices.map(inv => {
                const statusOpts = invStatuses.map(s =>
                    `<option value="${s}"${s === inv.status ? " selected" : ""}>${s}</option>`
                ).join("");
                const itemLines = (inv.items || []).map(it =>
                    `${escapeHtml(it.description || "")} x${it.qty || 0} @ $${(it.unit_price || 0).toFixed(2)}`
                ).join(", ");
                return `
                <div class="biz-card">
                    <div class="biz-card-info">
                        <div class="biz-card-title">
                            <span class="biz-status-badge ${inv.status}">${inv.status || "draft"}</span>
                            ${escapeHtml(inv.invoice_number)} &mdash; ${escapeHtml(inv.customer_name || "Unknown")}
                        </div>
                        <div class="biz-card-meta">
                            ${inv.date || "No date"} &middot; Labor: ${inv.labor_hours}h @ $${inv.labor_rate}/hr &middot; <strong>Total: $${inv.total.toFixed(2)}</strong>
                        </div>
                        ${itemLines ? '<div class="biz-card-meta">Items: ' + escapeHtml(itemLines) + '</div>' : ''}
                        ${inv.notes ? '<div class="biz-card-meta">' + escapeHtml(inv.notes) + '</div>' : ''}
                    </div>
                    <div class="biz-card-actions">
                        <select class="biz-card-btn" onchange="updateInvoiceStatus('${inv.invoice_id}', this.value)">
                            ${statusOpts}
                        </select>
                        <button class="biz-card-btn danger" onclick="deleteInvoice('${inv.invoice_id}')">Del</button>
                    </div>
                </div>
                `;
            }).join("");
        }

        // --- Inventory ---
        function createInventoryItem() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const name = document.getElementById("biz-inv-item-name").value.trim();
            if (!name) return;
            ws.send(JSON.stringify({
                type: "business_inventory_create",
                name: name,
                category: document.getElementById("biz-inv-item-category").value,
                quantity: parseInt(document.getElementById("biz-inv-item-qty").value) || 0,
                cost: parseFloat(document.getElementById("biz-inv-item-cost").value) || 0,
                reorder_threshold: parseInt(document.getElementById("biz-inv-item-reorder").value) || 0,
            }));
            document.getElementById("biz-inv-item-name").value = "";
            document.getElementById("biz-inv-item-qty").value = "";
            document.getElementById("biz-inv-item-cost").value = "";
            document.getElementById("biz-inv-item-reorder").value = "";
        }

        function adjustInventoryQty(itemId, delta) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const item = bizInventory.find(i => i.item_id === itemId);
            if (!item) return;
            const newQty = Math.max(0, item.quantity + delta);
            ws.send(JSON.stringify({
                type: "business_inventory_update",
                item_id: itemId,
                quantity: newQty,
            }));
        }

        function deleteInventoryItem(itemId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            if (!confirm("Delete this inventory item?")) return;
            ws.send(JSON.stringify({ type: "business_inventory_delete", item_id: itemId }));
        }

        function renderBizInventory() {
            const container = document.getElementById("biz-inventory-list");
            if (!container) return;
            if (bizInventory.length === 0) {
                container.innerHTML = '<div class="biz-empty">No inventory items yet.</div>';
                return;
            }
            container.innerHTML = bizInventory.map(item => {
                const reorderAlert = item.needs_reorder
                    ? '<span class="biz-reorder-alert">REORDER</span> '
                    : '';
                return `
                <div class="biz-card">
                    <div class="biz-card-info">
                        <div class="biz-card-title">${reorderAlert}${escapeHtml(item.name)}</div>
                        <div class="biz-card-meta">
                            ${escapeHtml(item.category || "")} &middot; Qty: ${item.quantity}${item.reorder_threshold > 0 ? " (reorder at " + item.reorder_threshold + ")" : ""}
                            ${item.cost > 0 ? " &middot; $" + item.cost.toFixed(2) + "/ea" : ""}
                            ${item.supplier ? " &middot; " + escapeHtml(item.supplier) : ""}
                            ${item.part_number ? " &middot; P/N: " + escapeHtml(item.part_number) : ""}
                        </div>
                        ${item.notes ? '<div class="biz-card-meta">' + escapeHtml(item.notes) + '</div>' : ''}
                    </div>
                    <div class="biz-card-actions">
                        <button class="biz-card-btn" onclick="adjustInventoryQty('${item.item_id}', -1)">-1</button>
                        <button class="biz-card-btn" onclick="adjustInventoryQty('${item.item_id}', 1)">+1</button>
                        <button class="biz-card-btn danger" onclick="deleteInventoryItem('${item.item_id}')">Del</button>
                    </div>
                </div>
                `;
            }).join("");
        }

        // ---------------------------------------------------------------
        // Service Records
        // ---------------------------------------------------------------
        let svcVehicles = [];
        let svcRecords = [];
        let svcStatus = {};
        let svcSelectedVehicleId = null;

        function handleServiceRecordsStatus(data) {
            svcVehicles = data.vehicles || [];
            svcRecords = data.records || [];
            svcStatus = data.status || {};
            renderSvcVehicles();
            renderSvcRecords();
            updateSvcStats();
            populateSvcOwnerDropdown();
        }

        function updateSvcStats() {
            const s = svcStatus;
            const el = id => document.getElementById(id);
            const set = (id, val) => { const e = el(id); if (e) e.textContent = val; };
            set("svc-stat-vehicles", s.total_vehicles || 0);
            set("svc-stat-records", s.total_records || 0);
            set("svc-stat-month", s.records_this_month || 0);
            set("svc-stat-revenue", "$" + (s.total_revenue || 0).toFixed(2));
        }

        function populateSvcOwnerDropdown() {
            const sel = document.getElementById("svc-v-owner");
            if (!sel) return;
            const current = sel.value;
            sel.innerHTML = '<option value="">-- Owner --</option>';
            // Use bizCustomers from the Business Operations panel
            if (typeof bizCustomers !== "undefined") {
                bizCustomers.forEach(c => {
                    const opt = document.createElement("option");
                    opt.value = c.customer_id;
                    opt.textContent = c.name;
                    opt.dataset.name = c.name;
                    sel.appendChild(opt);
                });
            }
            if (current) sel.value = current;
        }

        // --- Vehicles ---
        function svcCreateVehicle() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const ownerSel = document.getElementById("svc-v-owner");
            const ownerOpt = ownerSel.options[ownerSel.selectedIndex];
            ws.send(JSON.stringify({
                type: "service_vehicle_create",
                year: document.getElementById("svc-v-year").value.trim(),
                make: document.getElementById("svc-v-make").value.trim(),
                model: document.getElementById("svc-v-model").value.trim(),
                vin: document.getElementById("svc-v-vin").value.trim(),
                owner_id: ownerSel.value,
                owner_name: ownerOpt && ownerOpt.dataset.name ? ownerOpt.dataset.name : "",
                color: document.getElementById("svc-v-color").value.trim(),
                mileage: parseInt(document.getElementById("svc-v-mileage").value) || 0,
            }));
            // Clear form
            ["svc-v-year","svc-v-make","svc-v-model","svc-v-vin","svc-v-color","svc-v-mileage"].forEach(id => {
                document.getElementById(id).value = "";
            });
            document.getElementById("svc-v-owner").value = "";
        }

        function svcDeleteVehicle(vehicleId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            if (!confirm("Delete this vehicle and its history?")) return;
            ws.send(JSON.stringify({ type: "service_vehicle_delete", vehicle_id: vehicleId }));
            if (svcSelectedVehicleId === vehicleId) {
                svcSelectedVehicleId = null;
                renderSvcRecords();
            }
        }

        function svcViewHistory(vehicleId) {
            svcSelectedVehicleId = vehicleId;
            renderSvcRecords();
            // Show add-record button
            const btn = document.getElementById("svc-add-record-btn");
            if (btn) btn.style.display = "";
        }

        function renderSvcVehicles() {
            const container = document.getElementById("svc-vehicle-list");
            if (!container) return;
            if (svcVehicles.length === 0) {
                container.innerHTML = '<div class="svc-empty">No vehicles yet.</div>';
                return;
            }
            container.innerHTML = svcVehicles.map(v => {
                const selected = v.vehicle_id === svcSelectedVehicleId ? "border-color:var(--accent);" : "";
                const mileage = v.mileage ? `${v.mileage.toLocaleString()} mi` : "";
                return `<div class="svc-vehicle-card" style="${selected}">
                    <div class="svc-v-info">
                        <div class="svc-v-name">${v.display_name}</div>
                        <div class="svc-v-meta">
                            ${v.vin ? "VIN: " + v.vin.substring(0, 11) + "..." : ""}
                            ${v.owner_name ? " &middot; Owner: " + v.owner_name : ""}
                            ${mileage ? " &middot; " + mileage : ""}
                            ${v.color ? " &middot; " + v.color : ""}
                        </div>
                    </div>
                    <div class="svc-v-actions">
                        <button onclick="svcViewHistory('${v.vehicle_id}')">View History</button>
                        <button class="danger" onclick="svcDeleteVehicle('${v.vehicle_id}')">Delete</button>
                    </div>
                </div>`;
            }).join("");
        }

        // --- Service Records ---
        function renderSvcRecords() {
            const container = document.getElementById("svc-record-list");
            const titleEl = document.getElementById("svc-history-title");
            const addBtn = document.getElementById("svc-add-record-btn");
            if (!container) return;

            if (!svcSelectedVehicleId) {
                if (titleEl) titleEl.textContent = "Select a vehicle to view service history";
                container.innerHTML = '<div class="svc-empty">No service records.</div>';
                if (addBtn) addBtn.style.display = "none";
                return;
            }

            const vehicle = svcVehicles.find(v => v.vehicle_id === svcSelectedVehicleId);
            if (titleEl && vehicle) {
                titleEl.textContent = `Showing: ${vehicle.display_name}${vehicle.owner_name ? " (" + vehicle.owner_name + ")" : ""}`;
            }
            if (addBtn) addBtn.style.display = "";

            const filtered = svcRecords.filter(r => r.vehicle_id === svcSelectedVehicleId);
            if (filtered.length === 0) {
                container.innerHTML = '<div class="svc-empty">No service records for this vehicle.</div>';
                return;
            }

            container.innerHTML = filtered.map(r => {
                const services = (r.services_performed || []).join(", ");
                const partsHtml = (r.parts_used || []).map(p =>
                    `${p.description || "Part"}${p.quantity > 1 ? " x" + p.quantity : ""} ($${(p.quantity * p.unit_cost).toFixed(2)})`
                ).join(", ");
                return `<div class="svc-record-card">
                    <div class="svc-record-header">
                        <span class="svc-r-title">${r.date}</span>
                        <span class="svc-r-type">${r.service_type || "service"}</span>
                    </div>
                    <div class="svc-record-body">
                        ${services ? `<div class="svc-r-services">Services: ${services}</div>` : ""}
                        ${partsHtml ? `<div class="svc-r-parts">Parts: ${partsHtml}</div>` : ""}
                        <div class="svc-r-cost">
                            Labor: ${r.labor_hours.toFixed(1)} hrs &times; $${r.labor_rate.toFixed(2)} = $${r.labor_total.toFixed(2)}
                            &middot; Parts: $${r.parts_total.toFixed(2)}
                            &middot; <strong>Total: $${r.total_cost.toFixed(2)}</strong>
                        </div>
                        ${r.notes ? `<div class="svc-r-notes">Notes: ${r.notes}</div>` : ""}
                        ${r.recommendations ? `<div class="svc-r-notes">Rec: ${r.recommendations}</div>` : ""}
                    </div>
                    <div class="svc-record-actions">
                        <button onclick="svcGeneratePdf('${r.record_id}')">PDF Report</button>
                        <button class="danger" onclick="svcDeleteRecord('${r.record_id}')">Delete</button>
                    </div>
                </div>`;
            }).join("");
        }

        // --- Record form ---
        function svcToggleRecordForm() {
            const form = document.getElementById("svc-add-record-form");
            if (form) form.classList.toggle("visible");
        }

        function svcAddPartRow() {
            const container = document.getElementById("svc-parts-list");
            if (!container) return;
            const row = document.createElement("div");
            row.className = "svc-parts-row";
            row.innerHTML = `
                <input type="text" placeholder="Description" class="svc-part-desc" style="flex:1;">
                <input type="text" placeholder="Part #" class="svc-part-pn" style="max-width:90px;">
                <input type="number" placeholder="Qty" class="svc-part-qty" value="1" style="max-width:50px;">
                <input type="number" placeholder="Unit $" class="svc-part-cost" step="0.01" style="max-width:80px;">
                <button onclick="this.parentElement.remove()">&times;</button>
            `;
            container.appendChild(row);
        }

        function svcSubmitRecord() {
            if (!ws || ws.readyState !== WebSocket.OPEN || !svcSelectedVehicleId) return;

            const vehicle = svcVehicles.find(v => v.vehicle_id === svcSelectedVehicleId);
            const servicesStr = document.getElementById("svc-r-services").value.trim();
            const services = servicesStr ? servicesStr.split(",").map(s => s.trim()).filter(Boolean) : [];

            // Gather parts
            const parts = [];
            document.querySelectorAll("#svc-parts-list .svc-parts-row").forEach(row => {
                const desc = row.querySelector(".svc-part-desc").value.trim();
                if (!desc) return;
                parts.push({
                    description: desc,
                    part_number: row.querySelector(".svc-part-pn").value.trim(),
                    quantity: parseInt(row.querySelector(".svc-part-qty").value) || 1,
                    unit_cost: parseFloat(row.querySelector(".svc-part-cost").value) || 0,
                });
            });

            ws.send(JSON.stringify({
                type: "service_record_create",
                vehicle_id: svcSelectedVehicleId,
                customer_id: vehicle ? vehicle.owner_id : "",
                customer_name: vehicle ? vehicle.owner_name : "",
                date: document.getElementById("svc-r-date").value,
                service_type: document.getElementById("svc-r-type").value,
                services_performed: services,
                parts_used: parts,
                labor_hours: parseFloat(document.getElementById("svc-r-labor-hours").value) || 0,
                labor_rate: parseFloat(document.getElementById("svc-r-labor-rate").value) || 75,
                notes: document.getElementById("svc-r-notes").value.trim(),
                recommendations: document.getElementById("svc-r-recommendations").value.trim(),
            }));

            // Clear form
            document.getElementById("svc-r-date").value = "";
            document.getElementById("svc-r-services").value = "";
            document.getElementById("svc-r-notes").value = "";
            document.getElementById("svc-r-recommendations").value = "";
            document.getElementById("svc-r-labor-hours").value = "";
            document.getElementById("svc-parts-list").innerHTML = "";
            document.getElementById("svc-add-record-form").classList.remove("visible");
        }

        function svcDeleteRecord(recordId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            if (!confirm("Delete this service record?")) return;
            ws.send(JSON.stringify({ type: "service_record_delete", record_id: recordId }));
        }

        function svcGeneratePdf(recordId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: "service_record_pdf", record_id: recordId }));
        }

        function handleServiceRecordPdf(data) {
            if (data.ok && data.url) {
                window.open(data.url, "_blank");
            } else {
                console.warn("PDF generation failed:", data.error);
                alert("PDF generation failed: " + (data.error || "Unknown error"));
            }
        }

        // ---------------------------------------------------------------
        // Knowledge Ingestion
        // ---------------------------------------------------------------
        let kiDocuments = [];
        let kiStatus = {};

        function handleKnowledgeStatus(data) {
            kiDocuments = data.documents || [];
            kiStatus = data.status || {};
            renderKnowledgePanel();
        }

        function renderKnowledgePanel() {
            const s = kiStatus;
            const set = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
            set("ki-stat-docs", s.total_documents || 0);
            set("ki-stat-chunks", s.total_chunks || 0);
            set("ki-stat-failed", s.failed || 0);
            set("ki-stat-inbox", s.inbox_pending || 0);

            const list = document.getElementById("ki-history-list");
            if (!list) return;

            if (!kiDocuments.length) {
                list.innerHTML = '<div class="ki-empty">No documents ingested yet.</div>';
                return;
            }

            list.innerHTML = kiDocuments.map(doc => {
                const ts = doc.created_at ? new Date(doc.created_at).toLocaleString() : "";
                const meta = [
                    doc.file_type.toUpperCase(),
                    doc.status === "completed" ? doc.chunk_count + " chunks" : "",
                    doc.source,
                    ts,
                ].filter(Boolean).join(" &middot; ");
                const error = doc.error ? `<div style="color:var(--error);font-size:0.75rem;margin-top:2px;">${doc.error}</div>` : "";
                return `<div class="ki-doc-card">
                    <div>
                        <div class="ki-doc-name">${doc.filename}</div>
                        <div class="ki-doc-meta">${meta}</div>
                        ${error}
                    </div>
                    <span class="ki-doc-badge ${doc.status}">${doc.status}</span>
                </div>`;
            }).join("");
        }

        function kiUploadFiles(files) {
            for (const file of files) {
                const formData = new FormData();
                formData.append("file", file);
                fetch("/api/knowledge/upload", { method: "POST", body: formData })
                    .then(r => r.json())
                    .then(data => {
                        if (!data.ok) {
                            console.warn("Knowledge upload issue:", data.document?.error || "Unknown");
                        }
                    })
                    .catch(err => console.error("Knowledge upload failed:", err));
            }
        }

        function kiScanInbox() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "knowledge_scan_inbox" }));
            }
        }

        // Drag-and-drop + file input setup
        (function initKnowledgeUpload() {
            document.addEventListener("DOMContentLoaded", () => {
                const area = document.getElementById("ki-upload-area");
                const input = document.getElementById("ki-file-input");
                if (!area || !input) return;

                area.addEventListener("dragover", e => {
                    e.preventDefault();
                    area.classList.add("dragover");
                });
                area.addEventListener("dragleave", e => {
                    e.preventDefault();
                    area.classList.remove("dragover");
                });
                area.addEventListener("drop", e => {
                    e.preventDefault();
                    area.classList.remove("dragover");
                    if (e.dataTransfer.files.length) kiUploadFiles(e.dataTransfer.files);
                });
                area.addEventListener("click", e => {
                    if (e.target.tagName !== "LABEL") input.click();
                });
                input.addEventListener("change", () => {
                    if (input.files.length) kiUploadFiles(input.files);
                    input.value = "";
                });
            });
        })();

        // Hook into renderAgents to also render knowledge panel
        const _origRenderAgentsForKI = typeof renderAgents === "function" ? renderAgents : null;
        if (_origRenderAgentsForKI) {
            renderAgents = function() {
                _origRenderAgentsForKI.apply(this, arguments);
                renderKnowledgePanel();
            };
        }

        // ---------------------------------------------------------------
        // Diagnostic Decision Trees
        // ---------------------------------------------------------------
        let diagTrees = [];
        let diagSessions = [];
        let diagStatus = {};
        let diagActiveSession = null;   // session object during walk
        let diagActiveNode = null;       // current node data during walk

        function handleDiagnosticsStatus(data) {
            diagTrees = data.trees || [];
            diagSessions = data.sessions || [];
            diagStatus = data.status || {};
            renderDiagPanel();
        }

        function renderDiagPanel() {
            const s = diagStatus;
            const set = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
            set("diag-tree-count", s.trees_loaded || 0);
            set("diag-active-count", s.active || 0);
            set("diag-completed-count", s.completed || 0);
            renderDiagTreeGrid();
            renderDiagHistory();
        }

        function renderDiagTreeGrid() {
            const grid = document.getElementById("diag-tree-grid");
            if (!grid) return;
            // Hide grid if a session is active
            if (diagActiveSession) { grid.style.display = "none"; return; }
            grid.style.display = "";

            const catFilter = document.getElementById("diag-cat-filter");
            const filterVal = catFilter ? catFilter.value : "";
            const filtered = filterVal ? diagTrees.filter(t => t.category === filterVal) : diagTrees;

            if (!filtered.length) {
                grid.innerHTML = '<div class="ki-empty">No diagnostic trees loaded.</div>';
                return;
            }
            grid.innerHTML = filtered.map(t => `
                <div class="diag-tree-card" onclick="diagStartSession('${t.tree_id}')">
                    <span class="diag-cat diag-cat-${t.category}">${t.category}</span>
                    <h4>${esc(t.name)}</h4>
                    <div class="diag-desc">${esc(t.description)}</div>
                    <div class="diag-nodes">${t.node_count} steps</div>
                </div>
            `).join("");
        }

        // Category filter change
        document.addEventListener("DOMContentLoaded", () => {
            const f = document.getElementById("diag-cat-filter");
            if (f) f.addEventListener("change", renderDiagTreeGrid);
        });

        function diagStartSession(treeId) {
            if (!ws || ws.readyState !== 1) return;
            ws.send(JSON.stringify({
                type: "diag_start_session",
                tree_id: treeId,
                vehicle_id: "",
                vehicle_summary: "",
                customer_name: "",
            }));
        }

        function handleDiagSessionStarted(data) {
            if (!data.ok) { console.warn("Failed to start diagnostic session:", data.error); return; }
            diagActiveSession = data.session;
            diagActiveNode = data.node;
            showDiagWalker();
        }

        function showDiagWalker() {
            const walker = document.getElementById("diag-walker");
            const grid = document.getElementById("diag-tree-grid");
            if (!walker || !diagActiveSession || !diagActiveNode) return;
            if (grid) grid.style.display = "none";
            walker.style.display = "";
            renderDiagNode();
        }

        function hideDiagWalker() {
            const walker = document.getElementById("diag-walker");
            const grid = document.getElementById("diag-tree-grid");
            const findingsSection = document.getElementById("diag-findings-section");
            const aiSection = document.getElementById("diag-ai-section");
            if (walker) walker.style.display = "none";
            if (grid) grid.style.display = "";
            if (findingsSection) findingsSection.style.display = "none";
            if (aiSection) aiSection.style.display = "none";
            diagActiveSession = null;
            diagActiveNode = null;
        }

        function renderDiagNode() {
            const walker = document.getElementById("diag-walker");
            if (!walker || !diagActiveNode) return;

            const n = diagActiveNode;
            const s = diagActiveSession;
            const bc = (n.breadcrumbs || []).map(b => `<span>${esc(b)}</span>`).join(" &rsaquo; ");

            let safetyHtml = "";
            if (n.safety) {
                safetyHtml = `<div class="diag-safety">&#9888; Safety: ${esc(n.safety)}</div>`;
            }

            let bodyHtml = "";
            if (n.type === "question") {
                const answersHtml = (n.answers || []).map((a, i) =>
                    `<button class="diag-answer-btn" onclick="diagAnswer(${i})">${esc(a.label)}</button>`
                ).join("");
                bodyHtml = `
                    <div class="diag-question">${esc(n.text)}</div>
                    ${n.context ? `<div class="diag-context">${esc(n.context)}</div>` : ""}
                    ${answersHtml}
                `;
            } else if (n.type === "finding") {
                bodyHtml = renderDiagFindingInline(n);
            }

            const notesVal = s.notes || "";
            walker.innerHTML = `
                <div class="diag-walker">
                    <div class="diag-walker-header">
                        <h3>${esc(s.tree_name)}</h3>
                        <span class="diag-vehicle">${esc(s.vehicle_summary || "No vehicle selected")}</span>
                    </div>
                    <div class="diag-breadcrumbs">${bc}</div>
                    ${safetyHtml}
                    ${bodyHtml}
                    <textarea class="diag-notes-area" id="diag-notes-input"
                        placeholder="Technician notes..." onchange="diagSaveNotes()">${esc(notesVal)}</textarea>
                    <div class="diag-actions">
                        <button onclick="diagGoBack()">Back</button>
                        <button onclick="diagAiSuggest()">AI Suggestions</button>
                        <button class="diag-btn-success" onclick="diagComplete()">Complete &amp; Save Record</button>
                        <button class="diag-btn-danger" onclick="diagAbandon()">Abandon</button>
                    </div>
                </div>
            `;

            // Show findings list if any
            renderDiagFindings();
        }

        function renderDiagFindingInline(n) {
            const sevClass = n.severity ? `sev-${n.severity}` : "";
            const sevLabel = n.severity ? n.severity.toUpperCase() : "";
            const actionsHtml = (n.recommended_actions || []).map(a => `<li>${esc(a)}</li>`).join("");
            const partsHtml = (n.possible_parts || []).length ?
                `<p style="margin-top:0.4rem;font-weight:600;font-size:0.8rem;">Possible parts:</p>
                 <ul>${n.possible_parts.map(p => `<li>${esc(p)}</li>`).join("")}</ul>` : "";
            const followHtml = (n.follow_up_trees || []).length ?
                `<p style="margin-top:0.4rem;font-size:0.8rem;color:var(--text-tertiary);">
                 Suggested follow-up: ${n.follow_up_trees.map(t => esc(t)).join(", ")}</p>` : "";

            return `
                <div class="diag-finding ${sevClass}">
                    <h5>${esc(n.title || "")} <span class="diag-sev">${sevLabel}</span></h5>
                    <p>${esc(n.description || "")}</p>
                    ${actionsHtml ? `<ul>${actionsHtml}</ul>` : ""}
                    ${partsHtml}
                    ${followHtml}
                </div>
            `;
        }

        function renderDiagFindings() {
            const section = document.getElementById("diag-findings-section");
            const list = document.getElementById("diag-findings-list");
            if (!section || !list || !diagActiveSession) return;
            const findings = diagActiveSession.findings || [];
            if (!findings.length) { section.style.display = "none"; return; }
            section.style.display = "";
            list.innerHTML = findings.map(f => {
                const sevClass = f.severity ? `sev-${f.severity}` : "";
                const sevLabel = f.severity ? f.severity.toUpperCase() : "";
                return `
                    <div class="diag-finding ${sevClass}">
                        <h5>${esc(f.title || "")} <span class="diag-sev">${sevLabel}</span></h5>
                        <p>${esc(f.description || "")}</p>
                    </div>
                `;
            }).join("");
        }

        function diagAnswer(index) {
            if (!ws || ws.readyState !== 1 || !diagActiveSession) return;
            ws.send(JSON.stringify({
                type: "diag_answer",
                session_id: diagActiveSession.session_id,
                answer_index: index,
            }));
        }

        function handleDiagAnswerResult(data) {
            if (!data.ok) { console.warn("Diag answer failed:", data.error); return; }
            diagActiveNode = data.node;
            if (data.is_finding && data.finding) {
                if (!diagActiveSession.findings) diagActiveSession.findings = [];
                diagActiveSession.findings.push(data.finding);
            }
            if (data.answers) diagActiveSession.answers = data.answers;
            if (data.node && data.node.session) {
                diagActiveSession = data.node.session;
            }
            renderDiagNode();
        }

        function diagGoBack() {
            if (!ws || ws.readyState !== 1 || !diagActiveSession) return;
            ws.send(JSON.stringify({
                type: "diag_go_back",
                session_id: diagActiveSession.session_id,
            }));
        }

        function handleDiagGoBackResult(data) {
            if (!data.ok) { console.warn("Diag go back failed:", data.error); return; }
            diagActiveNode = data.node;
            if (data.node && data.node.session) {
                diagActiveSession = data.node.session;
            }
            renderDiagNode();
        }

        function diagAiSuggest() {
            if (!ws || ws.readyState !== 1 || !diagActiveSession) return;
            const aiSection = document.getElementById("diag-ai-section");
            if (aiSection) {
                aiSection.style.display = "";
                aiSection.innerHTML = '<div class="diag-ai-box">Asking AI for suggestions...</div>';
            }
            ws.send(JSON.stringify({
                type: "diag_ai_suggest",
                session_id: diagActiveSession.session_id,
            }));
        }

        function handleDiagAiSuggestResult(data) {
            const aiSection = document.getElementById("diag-ai-section");
            if (!aiSection) return;
            if (data.ok && data.suggestions) {
                aiSection.style.display = "";
                aiSection.innerHTML = `<div class="diag-ai-box"><strong>AI Suggestions:</strong>\n${esc(data.suggestions)}</div>`;
            } else {
                aiSection.innerHTML = `<div class="diag-ai-box" style="border-color:rgba(239,68,68,0.3);">AI suggestions unavailable: ${esc(data.error || "Unknown error")}</div>`;
            }
        }

        function diagComplete() {
            if (!ws || ws.readyState !== 1 || !diagActiveSession) return;
            if (!confirm("Complete this diagnostic session and save as a service record?")) return;
            ws.send(JSON.stringify({
                type: "diag_complete",
                session_id: diagActiveSession.session_id,
            }));
        }

        function handleDiagCompleteResult(data) {
            if (!data.ok) { console.warn("Diag complete failed:", data.error); return; }
            hideDiagWalker();
        }

        function diagAbandon() {
            if (!ws || ws.readyState !== 1 || !diagActiveSession) return;
            if (!confirm("Abandon this diagnostic session?")) return;
            ws.send(JSON.stringify({
                type: "diag_abandon",
                session_id: diagActiveSession.session_id,
            }));
        }

        function handleDiagAbandonResult(data) {
            if (!data.ok) { console.warn("Diag abandon failed:", data.error); return; }
            hideDiagWalker();
        }

        function diagSaveNotes() {
            if (!ws || ws.readyState !== 1 || !diagActiveSession) return;
            const el = document.getElementById("diag-notes-input");
            if (!el) return;
            ws.send(JSON.stringify({
                type: "diag_update_notes",
                session_id: diagActiveSession.session_id,
                notes: el.value,
            }));
        }

        function diagReloadTrees() {
            if (!ws || ws.readyState !== 1) return;
            ws.send(JSON.stringify({ type: "diag_reload_trees" }));
        }

        function renderDiagHistory() {
            const list = document.getElementById("diag-history-list");
            if (!list) return;
            const past = diagSessions.filter(s => s.status !== "active");
            if (!past.length) {
                list.innerHTML = '<div class="ki-empty">No diagnostic sessions yet.</div>';
                return;
            }
            list.innerHTML = past.slice(0, 25).map(s => {
                const statusCls = `diag-status-${s.status}`;
                const time = s.completed_at ? new Date(s.completed_at).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}) : "";
                const date = s.completed_at ? new Date(s.completed_at).toLocaleDateString() : "";
                return `
                    <div class="diag-history-item">
                        <div>
                            <span class="diag-hist-name">${esc(s.tree_name)}</span>
                            ${s.vehicle_summary ? ` &middot; <span style="color:var(--text-secondary)">${esc(s.vehicle_summary)}</span>` : ""}
                        </div>
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <span class="diag-status-badge ${statusCls}">${s.status}</span>
                            <span class="diag-hist-meta">${date} ${time}</span>
                        </div>
                    </div>
                `;
            }).join("");
        }

        // Escape HTML helper (reuse existing esc if available)
        if (typeof esc !== "function") {
            function esc(s) {
                if (!s) return "";
                const d = document.createElement("div");
                d.textContent = String(s);
                return d.innerHTML;
            }
        }

        // Hook into renderAgents for panel updates
        const _origRenderAgentsForDiag = typeof renderAgents === "function" ? renderAgents : null;
        if (_origRenderAgentsForDiag) {
            renderAgents = function() {
                _origRenderAgentsForDiag.apply(this, arguments);
                renderDiagPanel();
            };
        }

        // ---------------------------------------------------------------
        // Motorcycle Scout
        // ---------------------------------------------------------------
        let scoutEntries = [];
        let scoutStatus = {};
        let scoutFilterStatus = "";

        function handleScoutStatus(data) {
            scoutEntries = data.entries || [];
            scoutStatus = data.status || {};
            renderScoutListings();
            renderScoutStats();
        }

        function renderScoutStats() {
            const el = document.getElementById("scout-stats");
            const total = scoutStatus.total || 0;
            const hot = scoutStatus.hot_deals || 0;
            const byStatus = scoutStatus.by_status || {};
            el.innerHTML = `
                <span>Total: ${total}</span>
                ${hot > 0 ? `<span class="hot">Hot Deals: ${hot}</span>` : ""}
                <span>New: ${byStatus.new || 0}</span>
                <span>Flagged: ${byStatus.flagged || 0}</span>
            `;
        }

        function triggerScoutScan() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: "scout_scan" }));
        }

        function filterScoutListings() {
            scoutFilterStatus = document.getElementById("scout-status-filter").value;
            renderScoutListings();
        }

        function updateScoutListingStatus(entryId, status) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({
                type: "scout_update_status",
                entry_id: entryId,
                status: status,
            }));
        }

        function deleteScoutListing(entryId) {
            if (!confirm("Delete this listing?")) return;
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({
                type: "scout_delete",
                entry_id: entryId,
            }));
        }

        function rescoreScoutListing(entryId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({
                type: "scout_rescore",
                entry_id: entryId,
            }));
        }

        function renderScoutListings() {
            const container = document.getElementById("scout-list");
            let filtered = scoutEntries;
            if (scoutFilterStatus) {
                filtered = scoutEntries.filter(e => e.status === scoutFilterStatus);
            }

            if (filtered.length === 0) {
                container.innerHTML = '<div class="scout-empty">No scout results yet. Click "Scan Now" to search.</div>';
                return;
            }

            // Sort by deal_score descending
            filtered.sort((a, b) => (b.deal_score || 0) - (a.deal_score || 0));

            container.innerHTML = filtered.map(e => {
                const score = e.deal_score || 0;
                const scoreClass = score >= 8 ? "hot" : score >= 5 ? "warm" : "cool";
                const isHot = score >= 8;
                const statusClass = e.status || "new";
                const statusLabel = e.status || "new";
                const priceStr = e.price > 0 ? `$${e.price.toLocaleString()}` : "â€”";
                const yearStr = e.year > 0 ? e.year : "";
                const makeModel = [yearStr, e.make, e.model].filter(Boolean).join(" ");
                const sourceLabel = e.source === "craigslist" ? "CL" : e.source === "facebook" ? "FB" : (e.source || "â€”");
                const reasonStr = e.score_reason
                    ? escapeHtml(e.score_reason.substring(0, 150))
                    : "";
                const dateStr = e.date_found
                    ? new Date(e.date_found).toLocaleDateString()
                    : "";

                return `
                    <div class="scout-card${isHot ? " hot-deal" : ""}">
                        <div class="scout-card-header">
                            <div class="scout-card-left">
                                <span class="scout-deal-score ${scoreClass}">${score}/10</span>
                                <span class="scout-card-title">
                                    <a href="${escapeHtml(e.url)}" target="_blank" rel="noopener">${escapeHtml(e.title.substring(0, 100))}</a>
                                </span>
                                <span class="scout-status-badge ${statusClass}">${statusLabel}</span>
                            </div>
                            <div class="scout-card-actions">
                                <button class="scout-card-btn flag" onclick="updateScoutListingStatus('${e.entry_id}','flagged')" title="Flag">Flag</button>
                                <button class="scout-card-btn ok" onclick="updateScoutListingStatus('${e.entry_id}','reviewed')" title="Mark OK">OK</button>
                                <button class="scout-card-btn" onclick="updateScoutListingStatus('${e.entry_id}','dismissed')" title="Skip">Skip</button>
                                <button class="scout-card-btn" onclick="rescoreScoutListing('${e.entry_id}')" title="Re-score">Rescore</button>
                                <button class="scout-card-btn" onclick="deleteScoutListing('${e.entry_id}')" title="Delete">Del</button>
                            </div>
                        </div>
                        <div class="scout-card-meta">
                            <span class="price">${priceStr}</span>
                            <span>${sourceLabel}</span>
                            ${makeModel ? `<span>${escapeHtml(makeModel)}</span>` : ""}
                            ${e.location ? `<span>${escapeHtml(e.location)}</span>` : ""}
                            ${dateStr ? `<span>${dateStr}</span>` : ""}
                        </div>
                        ${reasonStr ? `<div class="scout-card-reason">${reasonStr}</div>` : ""}
                    </div>
                `;
            }).join("");
        }

        // ---------------------------------------------------------------
        // Market Analytics
        // ---------------------------------------------------------------
        let marketData = {
            tracked_makes: 0,
            total_snapshots: 0,
            latest_date: "",
            report_count: 0,
            latest_report_id: "",
            trends: [],
            undervalued: [],
            location_summary: [],
        };

        function handleMarketAnalytics(data) {
            marketData.tracked_makes = data.tracked_makes || 0;
            marketData.total_snapshots = data.total_snapshots || 0;
            marketData.latest_date = data.latest_date || "";
            marketData.report_count = data.report_count || 0;
            marketData.latest_report_id = data.latest_report_id || "";
            marketData.trends = data.trends || [];
            marketData.undervalued = data.undervalued || [];
            marketData.location_summary = data.location_summary || [];
            renderMarketStats();
            renderMarketTrends();
            renderMarketDeals();
            renderMarketHeatGrid();
            // Enable download button if reports exist
            const dlBtn = document.getElementById("market-download-btn");
            if (dlBtn) dlBtn.disabled = !marketData.latest_report_id;
        }

        function renderMarketStats() {
            const el = (id, val) => {
                const e = document.getElementById(id);
                if (e) e.textContent = val;
            };
            el("market-stat-makes", marketData.tracked_makes);
            el("market-stat-snapshots", marketData.total_snapshots);
            el("market-stat-date", marketData.latest_date || "â€”");
            el("market-stat-reports", marketData.report_count);
        }

        function renderMarketTrends() {
            const container = document.getElementById("market-trends");
            if (!container) return;
            const trends = marketData.trends;
            if (!trends.length) {
                container.innerHTML = '<div class="market-empty">No trend data yet. Take snapshots to build price history.</div>';
                return;
            }
            container.innerHTML = trends.map(t => {
                const arrows = { rising: "â†‘", falling: "â†“", stable: "â†’" };
                const arrow = arrows[t.direction] || "â†’";
                const dir = t.direction || "stable";
                const name = t.model ? `${t.make} ${t.model}` : t.make;
                const pctStr = (t.change_pct >= 0 ? "+" : "") + t.change_pct.toFixed(1) + "%";
                const priceStr = "$" + Math.round(t.recent_avg).toLocaleString();
                return `
                    <div class="market-trend-row" onclick="showMarketDetail('${escapeHtml(t.make)}', '${escapeHtml(t.model || "")}')">
                        <span class="market-trend-name">${escapeHtml(name)}</span>
                        <span class="market-trend-arrow ${dir}">${arrow}</span>
                        <span class="market-trend-pct ${dir}">${pctStr}</span>
                        <span class="market-trend-price">${priceStr}</span>
                        <span class="market-trend-pts">${t.data_points} pts</span>
                    </div>
                `;
            }).join("");
        }

        function renderMarketDeals() {
            const container = document.getElementById("market-deals");
            if (!container) return;
            const deals = marketData.undervalued;
            if (!deals.length) {
                container.innerHTML = '<div class="market-empty">No undervalued listings detected.</div>';
                return;
            }
            container.innerHTML = deals.map(d => {
                const yearStr = d.year ? d.year + " " : "";
                const title = yearStr + (d.make || "") + " " + (d.model || "");
                return `
                    <div class="market-deal-row">
                        <span class="market-deal-discount">-${d.discount_pct.toFixed(0)}%</span>
                        <span class="market-deal-title">${escapeHtml(title.trim())}</span>
                        <span class="market-deal-price">$${d.price.toLocaleString()}</span>
                        <span class="market-deal-avg">(avg: $${Math.round(d.avg_price).toLocaleString()})</span>
                    </div>
                `;
            }).join("");
        }

        function renderMarketHeatGrid() {
            const container = document.getElementById("market-heatgrid");
            if (!container) return;
            const locs = marketData.location_summary;
            if (!locs.length) {
                container.innerHTML = '<div class="market-empty">No location data available.</div>';
                return;
            }
            const maxCount = Math.max(...locs.map(l => l.count), 1);
            container.innerHTML = locs.map(l => {
                const ratio = l.count / maxCount;
                const heat = ratio > 0.6 ? "hot" : ratio > 0.3 ? "warm" : "cold";
                const hotStr = l.hot_deals ? ` (${l.hot_deals} hot)` : "";
                return `
                    <div class="market-heat-cell market-heat-${heat}">
                        <div class="heat-location">${escapeHtml(l.location)}</div>
                        <div class="heat-count">${l.count} listings${hotStr}</div>
                        <div class="heat-avg">avg $${Math.round(l.avg_price).toLocaleString()}</div>
                    </div>
                `;
            }).join("");
        }

        function triggerMarketSnapshot() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const btn = document.getElementById("market-snapshot-btn");
            if (btn) { btn.disabled = true; btn.textContent = "Taking snapshot..."; }
            ws.send(JSON.stringify({ type: "market_snapshot" }));
        }

        function triggerMarketReport() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const btn = document.getElementById("market-report-btn");
            if (btn) { btn.disabled = true; btn.textContent = "Generating..."; }
            ws.send(JSON.stringify({ type: "market_generate_report", report_type: "weekly" }));
        }

        function downloadLatestReport() {
            if (!marketData.latest_report_id) return;
            window.open("/api/market/report/" + marketData.latest_report_id + "/download", "_blank");
        }

        function showMarketDetail(make, model) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const overlay = document.getElementById("market-detail-overlay");
            const title = document.getElementById("market-detail-title");
            const chart = document.getElementById("market-detail-chart");
            const tbody = document.getElementById("market-detail-tbody");
            if (title) {
                const name = model ? `${make} ${model}` : make;
                title.textContent = `Price History â€” ${name}`;
            }
            if (chart) chart.innerHTML = '<div class="market-empty">Loading...</div>';
            if (tbody) tbody.innerHTML = "";
            if (overlay) overlay.classList.add("active");
            ws.send(JSON.stringify({ type: "market_get_history", make, model, days: 30 }));
        }

        function handleMarketHistoryResult(data) {
            if (!data.ok) {
                console.warn("Market history failed:", data.error);
                return;
            }
            const chart = document.getElementById("market-detail-chart");
            const tbody = document.getElementById("market-detail-tbody");
            const history = data.history || [];
            if (!history.length) {
                if (chart) chart.innerHTML = '<div class="market-empty">No history data.</div>';
                return;
            }
            // Render sparkline bars
            const maxPrice = Math.max(...history.map(h => h.avg_price), 1);
            if (chart) {
                chart.innerHTML = history.map(h => {
                    const pct = Math.max((h.avg_price / maxPrice) * 100, 5);
                    return `<div class="bar" style="height:${pct}%" title="${h.snapshot_date}: $${Math.round(h.avg_price)}"></div>`;
                }).join("");
            }
            // Render data table
            if (tbody) {
                tbody.innerHTML = history.map(h => `
                    <tr>
                        <td>${h.snapshot_date}</td>
                        <td>$${Math.round(h.avg_price).toLocaleString()}</td>
                        <td>$${(h.min_price || 0).toLocaleString()}</td>
                        <td>$${(h.max_price || 0).toLocaleString()}</td>
                        <td>${h.listing_count || 0}</td>
                    </tr>
                `).join("");
            }
        }

        function closeMarketDetail(event) {
            if (event && event.target !== event.currentTarget) return;
            const overlay = document.getElementById("market-detail-overlay");
            if (overlay) overlay.classList.remove("active");
        }

        // ---------------------------------------------------------------
        // Webhooks
        // ---------------------------------------------------------------
        let webhookData = { endpoints: [], status: {}, recent_deliveries: [] };

        function handleWebhookStatus(data) {
            if (data && data.endpoints) webhookData.endpoints = data.endpoints;
            if (data && data.status) webhookData.status = data.status;
            if (data && data.recent_deliveries) webhookData.recent_deliveries = data.recent_deliveries;
            renderWebhookStats();
            renderWebhookEndpoints();
            renderWebhookDeliveries();
        }

        function renderWebhookStats() {
            const s = webhookData.status || {};
            const el = document.getElementById("webhook-stats");
            if (!el) return;
            el.innerHTML = `
                <div class="webhook-stat-card">
                    <div class="stat-value">${s.endpoints_total || 0}</div>
                    <div class="stat-label">Endpoints</div>
                </div>
                <div class="webhook-stat-card">
                    <div class="stat-value">${s.endpoints_enabled || 0}</div>
                    <div class="stat-label">Enabled</div>
                </div>
                <div class="webhook-stat-card">
                    <div class="stat-value">${s.success_rate != null ? s.success_rate + '%' : 'â€”'}</div>
                    <div class="stat-label">Success</div>
                </div>
                <div class="webhook-stat-card">
                    <div class="stat-value">${s.deliveries_success || 0}</div>
                    <div class="stat-label">Delivered</div>
                </div>
                <div class="webhook-stat-card">
                    <div class="stat-value">${s.deliveries_retrying || 0}</div>
                    <div class="stat-label">Retrying</div>
                </div>
                <div class="webhook-stat-card">
                    <div class="stat-value">${s.inbound_count || 0}</div>
                    <div class="stat-label">Inbound</div>
                </div>
            `;
        }

        function renderWebhookEndpoints() {
            const el = document.getElementById("webhook-endpoints-list");
            if (!el) return;
            const eps = webhookData.endpoints || [];
            if (eps.length === 0) {
                el.innerHTML = '<div class="empty-state">No webhook endpoints registered</div>';
                return;
            }
            el.innerHTML = eps.map(ep => {
                const dirBadge = `<span class="webhook-badge ${ep.direction}">${ep.direction}</span>`;
                const enabledBadge = ep.enabled
                    ? '<span class="webhook-badge enabled">enabled</span>'
                    : '<span class="webhook-badge disabled">disabled</span>';
                const filters = (ep.event_filters || []).join(", ") || "all";
                const sev = ep.severity_filter || "all";
                return `
                    <div class="webhook-endpoint-row">
                        <div class="webhook-endpoint-header">
                            <div>
                                <span class="webhook-endpoint-name">${esc(ep.name)}</span>
                                ${dirBadge} ${enabledBadge}
                            </div>
                            <div class="webhook-endpoint-actions">
                                <button onclick="toggleWebhookEnabled('${ep.endpoint_id}', ${!ep.enabled})"
                                    title="${ep.enabled ? 'Disable' : 'Enable'}">${ep.enabled ? 'â¸' : 'â–¶'}</button>
                                <button onclick="testWebhook('${ep.endpoint_id}')" title="Test delivery">Test</button>
                                <button class="danger" onclick="deleteWebhook('${ep.endpoint_id}')" title="Delete">âœ•</button>
                            </div>
                        </div>
                        ${ep.url ? `<div class="webhook-endpoint-url">${esc(ep.url)}</div>` : ''}
                        <div class="webhook-endpoint-meta">Events: ${esc(filters)} | Severity: ${esc(sev)}</div>
                    </div>
                `;
            }).join("");
        }

        function renderWebhookDeliveries() {
            const el = document.getElementById("webhook-deliveries-list");
            if (!el) return;
            const dels = webhookData.recent_deliveries || [];
            if (dels.length === 0) {
                el.innerHTML = '<div class="empty-state">No deliveries yet</div>';
                return;
            }
            el.innerHTML = dels.slice(0, 30).map(d => {
                const statusInfo = d.http_status ? `(${d.http_status})` : '';
                return `
                    <div class="webhook-delivery-row">
                        <div class="webhook-delivery-dot ${d.status}"></div>
                        <div class="webhook-delivery-category">${esc(d.event_category)}</div>
                        <div class="webhook-delivery-message">${esc(d.event_message)}</div>
                        <div class="webhook-delivery-status">
                            ${d.status}${statusInfo} ${d.attempt_count}/${d.max_attempts}
                        </div>
                    </div>
                `;
            }).join("");
        }

        function toggleWebhookForm() {
            const form = document.getElementById("webhook-register-form");
            if (form) form.classList.toggle("active");
        }

        function registerWebhook() {
            const name = document.getElementById("wh-name")?.value?.trim();
            const url = document.getElementById("wh-url")?.value?.trim();
            const direction = document.getElementById("wh-direction")?.value || "outbound";
            const secret = document.getElementById("wh-secret")?.value?.trim() || "";
            const severity = document.getElementById("wh-severity")?.value || "all";
            const filtersRaw = document.getElementById("wh-filters")?.value?.trim() || "";
            const filters = filtersRaw ? filtersRaw.split(",").map(s => s.trim()).filter(Boolean) : [];

            if (!name) { alert("Endpoint name is required"); return; }

            ws.send(JSON.stringify({
                type: "webhook_register",
                name, url, direction, secret,
                event_filters: filters,
                severity_filter: severity,
                enabled: true,
            }));

            // Reset form
            ["wh-name", "wh-url", "wh-secret", "wh-filters"].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = "";
            });
            toggleWebhookForm();
        }

        function toggleWebhookEnabled(endpointId, enabled) {
            ws.send(JSON.stringify({
                type: "webhook_toggle",
                endpoint_id: endpointId,
                enabled: enabled,
            }));
        }

        function testWebhook(endpointId) {
            ws.send(JSON.stringify({
                type: "webhook_test",
                endpoint_id: endpointId,
            }));
        }

        function deleteWebhook(endpointId) {
            if (!confirm("Delete this webhook endpoint?")) return;
            ws.send(JSON.stringify({
                type: "webhook_delete",
                endpoint_id: endpointId,
            }));
        }

        // ---------------------------------------------------------------
        // Security & Audit
        // ---------------------------------------------------------------
        let pendingApprovals = [];
        let auditEntries = [];
        let auditActors = [];
        let activeAuditFilter = "all";

        function handleApprovalRequest(data) {
            // Add to pending approvals and show the queue
            pendingApprovals.push(data);
            renderApprovalQueue();
        }

        function respondToApproval(taskId, approved) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "approval_response",
                    task_id: taskId,
                    approved: approved,
                }));
            }
            // Remove from pending list
            pendingApprovals = pendingApprovals.filter(a => a.task_id !== taskId);
            renderApprovalQueue();
        }

        function renderApprovalQueue() {
            const queue = document.getElementById("approval-queue");
            const list = document.getElementById("approval-list");

            if (pendingApprovals.length === 0) {
                queue.style.display = "none";
                return;
            }

            queue.style.display = "block";
            list.innerHTML = pendingApprovals.map(a => `
                <div class="approval-request">
                    <div class="approval-info">
                        <div class="approval-desc">${escapeHtml(a.description || "")}</div>
                        <div class="approval-meta">
                            <span>Action: ${escapeHtml(a.action_type || "")}</span>
                            <span>Tier: ${a.tier}</span>
                            <span class="audit-risk ${a.risk_level}">${a.risk_level}</span>
                            <span>${escapeHtml(a.short_id || "")}</span>
                        </div>
                    </div>
                    <div class="approval-actions">
                        <button class="approval-btn approve" onclick="respondToApproval('${a.task_id}', true)">Approve</button>
                        <button class="approval-btn reject" onclick="respondToApproval('${a.task_id}', false)">Reject</button>
                    </div>
                </div>
            `).join("");
        }

        function handleSecurityAuditStatus(data) {
            auditEntries = data.entries || [];
            const status = data.status || {};
            auditActors = status.actors || [];
            populateAuditActorFilter();
            renderAuditLog();
        }

        function handleSecurityAuditFiltered(data) {
            auditEntries = data.entries || [];
            renderAuditLog();
        }

        function populateAuditActorFilter() {
            const select = document.getElementById("audit-actor-filter");
            const currentVal = select.value;
            select.innerHTML = '<option value="">All actors</option>';
            auditActors.forEach(actor => {
                const opt = document.createElement("option");
                opt.value = actor;
                opt.textContent = actor;
                select.appendChild(opt);
            });
            select.value = currentVal;
        }

        function filterAuditLog(filter, btn) {
            activeAuditFilter = filter;

            // Update active button state
            document.querySelectorAll(".audit-filter-btn").forEach(b => b.classList.remove("active"));
            if (btn) btn.classList.add("active");

            // Send filter request to server
            if (ws && ws.readyState === WebSocket.OPEN) {
                const payload = { type: "security_audit_filter", limit: 200 };
                if (filter !== "all") {
                    payload.risk_level = filter;
                }
                const actor = document.getElementById("audit-actor-filter").value;
                if (actor) {
                    payload.actor = actor;
                }
                ws.send(JSON.stringify(payload));
            }
        }

        function filterAuditByActor(actor) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const payload = { type: "security_audit_filter", limit: 200 };
                if (actor) {
                    payload.actor = actor;
                }
                if (activeAuditFilter !== "all") {
                    payload.risk_level = activeAuditFilter;
                }
                ws.send(JSON.stringify(payload));
            }
        }

        function renderAuditLog() {
            const container = document.getElementById("audit-log-container");

            if (auditEntries.length === 0) {
                container.innerHTML = '<div class="audit-empty">No audit entries yet. Actions will appear here as tasks are processed.</div>';
                return;
            }

            container.innerHTML = auditEntries.map(e => {
                const ts = new Date(e.timestamp);
                const timeStr = ts.toLocaleTimeString("en-US", {
                    hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit"
                });
                const targetPreview = (e.target || "").substring(0, 80);

                return `
                    <div class="audit-entry">
                        <span class="audit-time">${timeStr}</span>
                        <span class="audit-risk ${e.risk_level}">${e.risk_level}</span>
                        <span class="audit-actor">${escapeHtml(e.actor)}</span>
                        <span class="audit-action" title="${escapeHtml(e.target || "")}">[${escapeHtml(e.action_type)}] ${escapeHtml(targetPreview)}</span>
                        <span class="audit-result ${e.result}">${e.result}</span>
                    </div>
                `;
            }).join("");
        }

        // ---------------------------------------------------------------
        // Settings Panel
        // ---------------------------------------------------------------
        let currentConfig = null;
        let configLastLoaded = "";

        function handleConfig(data) {
            currentConfig = data.config;
            configLastLoaded = data.last_loaded;
            renderSettings();
        }

        function renderSettings() {
            if (!currentConfig) return;

            // Update last-loaded timestamp
            const loadedEl = document.getElementById("settings-last-loaded");
            if (configLastLoaded) {
                const d = new Date(configLastLoaded);
                loadedEl.textContent = "Loaded: " + d.toLocaleTimeString("en-US", {
                    hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit"
                });
            }

            const grid = document.getElementById("settings-grid");
            grid.innerHTML = "";

            // Render each top-level section as a card
            for (const [section, values] of Object.entries(currentConfig)) {
                const card = document.createElement("div");
                card.className = "settings-card";

                let heading = `<h3>${escapeHtml(section)}</h3>`;
                let rows = renderConfigRows(values, "");

                card.innerHTML = heading + rows;
                grid.appendChild(card);
            }
        }

        function renderConfigRows(obj, prefix) {
            let html = "";
            for (const [key, value] of Object.entries(obj)) {
                const fullKey = prefix ? prefix + "." + key : key;
                if (value !== null && typeof value === "object" && !Array.isArray(value)) {
                    // Nested section â€” render inline with dotted keys
                    html += renderConfigRows(value, fullKey);
                } else {
                    html += `<div class="settings-row">
                        <span class="key">${escapeHtml(fullKey)}</span>
                        <span class="val">${escapeHtml(String(value))}</span>
                    </div>`;
                }
            }
            return html;
        }

        function reloadConfig() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "config_reload" }));
            }
        }

        // ---------------------------------------------------------------
        // System Self-Test
        // ---------------------------------------------------------------

        function runSelfTest() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const btn = document.getElementById("self-test-btn");
            btn.disabled = true;
            btn.textContent = "Running...";
            document.getElementById("self-test-results").innerHTML =
                '<div class="self-test-empty">Running system tests...</div>';
            document.getElementById("self-test-summary").style.display = "none";
            ws.send(JSON.stringify({ type: "run_self_test" }));
        }

        function renderSelfTestResults(data) {
            const btn = document.getElementById("self-test-btn");
            btn.disabled = false;
            btn.textContent = "Run System Test";

            // Summary bar
            const summaryEl = document.getElementById("self-test-summary");
            summaryEl.style.display = "flex";
            summaryEl.className = "self-test-summary " +
                (data.failed === 0 ? "all-pass" : "has-fail");
            summaryEl.innerHTML = `
                <span class="st-pass-count">${data.passed} passed</span>
                <span class="st-fail-count">${data.failed} failed</span>
                <span>of ${data.total}</span>
                <span class="st-duration">${(data.duration_ms / 1000).toFixed(1)}s</span>
            `;

            // Group results by category
            const categories = {};
            const categoryOrder = ["config", "database", "model", "memory", "core", "network"];
            for (const r of (data.results || [])) {
                const cat = r.category || "other";
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(r);
            }

            let html = "";
            for (const cat of categoryOrder) {
                const items = categories[cat];
                if (!items) continue;
                html += `<div class="self-test-category">`;
                html += `<div class="self-test-category-label">${cat}</div>`;
                for (const r of items) {
                    const cls = r.passed ? "st-pass" : "st-fail";
                    const dur = r.duration_ms < 1000
                        ? `${Math.round(r.duration_ms)}ms`
                        : `${(r.duration_ms / 1000).toFixed(1)}s`;
                    html += `
                        <div class="self-test-item">
                            <div class="st-dot ${cls}"></div>
                            <div class="st-name">${r.name}</div>
                            <div class="st-message">${r.message}</div>
                            <div class="st-time">${dur}</div>
                        </div>
                    `;
                }
                html += `</div>`;
            }

            document.getElementById("self-test-results").innerHTML = html;
        }

        // ---------------------------------------------------------------
        // Launch Readiness
        // ---------------------------------------------------------------

        function runLaunchReadiness() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const btn = document.getElementById("lr-btn");
            btn.disabled = true;
            btn.textContent = "Running...";
            document.getElementById("lr-results").innerHTML =
                '<div class="lr-empty">Running integration checks...</div>';
            document.getElementById("lr-summary").style.display = "none";

            // Show and reset progress bar
            const progContainer = document.getElementById("lr-progress-container");
            progContainer.style.display = "block";
            document.getElementById("lr-progress-bar").style.width = "0%";
            document.getElementById("lr-progress-text").textContent = "0 / 12";

            ws.send(JSON.stringify({ type: "run_launch_readiness" }));
        }

        function handleLRProgress(data) {
            const pct = Math.round((data.completed / data.total) * 100);
            document.getElementById("lr-progress-bar").style.width = pct + "%";
            document.getElementById("lr-progress-text").textContent =
                `${data.completed} / ${data.total} â€” ${data.result.name}`;
        }

        function renderLRResults(data) {
            const btn = document.getElementById("lr-btn");
            btn.disabled = false;
            btn.textContent = "Run Launch Check";

            // Hide progress bar
            document.getElementById("lr-progress-container").style.display = "none";

            // Summary bar
            const summaryEl = document.getElementById("lr-summary");
            summaryEl.style.display = "flex";
            summaryEl.className = "lr-summary " +
                (data.failed === 0 ? "all-pass" : "has-fail");
            summaryEl.innerHTML = `
                <span class="st-pass-count">${data.passed} passed</span>
                <span class="st-fail-count">${data.failed} failed</span>
                <span>of ${data.total}</span>
                <span class="st-duration">${(data.duration_ms / 1000).toFixed(1)}s</span>
            `;

            // Group results by category
            const categories = {};
            const categoryOrder = [
                "prerequisite", "task_flow", "agent",
                "data", "resilience", "communication"
            ];
            for (const r of (data.results || [])) {
                const cat = r.category || "other";
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(r);
            }

            let html = "";
            for (const cat of categoryOrder) {
                const items = categories[cat];
                if (!items) continue;
                html += `<div class="self-test-category">`;
                html += `<div class="self-test-category-label">${cat.replace("_", " ")}</div>`;
                for (const r of items) {
                    const cls = r.passed ? "st-pass" : "st-fail";
                    const dur = r.duration_ms < 1000
                        ? `${Math.round(r.duration_ms)}ms`
                        : `${(r.duration_ms / 1000).toFixed(1)}s`;
                    html += `
                        <div class="self-test-item">
                            <div class="st-dot ${cls}"></div>
                            <div class="st-name">${r.name}</div>
                            <div class="st-message">${r.message}</div>
                            <div class="st-time">${dur}</div>
                        </div>
                    `;
                }
                html += `</div>`;
            }

            document.getElementById("lr-results").innerHTML = html;
        }

        // ---------------------------------------------------------------
        // Persona
        // ---------------------------------------------------------------
        let personaData = null;

        function handlePersona(data) {
            personaData = data.persona;
            renderPersona();
        }

        function renderPersona() {
            if (!personaData) return;
            const p = personaData;

            // Identity card
            const identityEl = document.getElementById("persona-identity");
            const toneTags = (p.tone || []).map(t =>
                `<span class="persona-tag tone">${t}</span>`
            ).join("");
            const domainTags = (p.knowledge_domains || []).map(d =>
                `<span class="persona-tag domain">${d}</span>`
            ).join("");

            identityEl.innerHTML = `
                <div class="persona-name">${p.name || "Cam"}</div>
                <div class="persona-tagline">${p.tagline || ""}</div>
                <div class="persona-role">${p.role || ""}</div>
                ${toneTags ? `<div class="persona-tags">${toneTags}</div>` : ""}
                ${domainTags ? `<div class="persona-tags">${domainTags}</div>` : ""}
            `;

            // Prompt preview card
            const promptCard = document.getElementById("persona-prompt-card");
            const promptText = document.getElementById("persona-prompt-text");
            const tokenEst = document.getElementById("persona-token-estimate");

            if (p.system_prompt) {
                promptCard.style.display = "block";
                promptText.textContent = p.system_prompt;
                tokenEst.textContent = `~${p.prompt_token_estimate || 0} tokens`;
            }
        }

        function reloadPersona() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "persona_reload" }));
            }
        }

        // ---------------------------------------------------------------
        // Notifications
        // ---------------------------------------------------------------
        function handleNewNotification(notif, count) {
            notifications.unshift(notif);
            // Cap local list
            if (notifications.length > 200) notifications = notifications.slice(0, 200);
            unreadCount = count;
            updateNotificationBadge();
            renderNotificationList();
            showToast(notif);
        }

        function handleNotificationHistory(notifs, count) {
            notifications = notifs || [];
            unreadCount = count;
            updateNotificationBadge();
            renderNotificationList();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById("notification-badge");
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? "99+" : String(unreadCount);
                badge.classList.remove("hidden");
            } else {
                badge.classList.add("hidden");
            }
        }

        function toggleNotificationDropdown() {
            const dd = document.getElementById("notification-dropdown");
            dd.classList.toggle("open");
        }

        // Close dropdown when clicking outside
        document.addEventListener("click", (e) => {
            const wrapper = document.querySelector(".notification-wrapper");
            const dd = document.getElementById("notification-dropdown");
            if (dd.classList.contains("open") && !wrapper.contains(e.target)) {
                dd.classList.remove("open");
            }
        });

        function renderNotificationList() {
            const container = document.getElementById("notification-list");
            if (notifications.length === 0) {
                container.innerHTML = '<div class="notification-empty">No notifications yet.</div>';
                return;
            }

            container.innerHTML = notifications.map(n => {
                const readClass = n.read ? "read" : "unread";
                const time = formatEventTime(n.timestamp);
                return `
                    <div class="notification-item ${readClass}" onclick="dismissNotification('${n.id}')">
                        <div class="notification-item-header">
                            <span class="notification-item-title">
                                <span class="notification-severity-badge ${n.severity}">${n.severity}</span>
                                ${escapeHtml(n.title)}
                            </span>
                            <span class="notification-item-time">${time}</span>
                        </div>
                        <div class="notification-item-message">${escapeHtml(n.message)}</div>
                    </div>
                `;
            }).join("");
        }

        function dismissNotification(id) {
            // Optimistic local update
            const notif = notifications.find(n => n.id === id);
            if (notif && !notif.read) {
                notif.read = true;
                unreadCount = Math.max(0, unreadCount - 1);
                updateNotificationBadge();
                renderNotificationList();
            }
            // Tell server
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "notification_dismiss", id: id }));
            }
        }

        function dismissAllNotifications() {
            // Optimistic local update
            notifications.forEach(n => n.read = true);
            unreadCount = 0;
            updateNotificationBadge();
            renderNotificationList();
            // Tell server
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: "notification_dismiss_all" }));
            }
        }

        function showToast(notif) {
            // Check notification prefs â€” suppressed toasts still go to dropdown
            const notifPrefs = getPref('notifPrefs', { info: true, warning: true, error: true, critical: true });
            if (notif.severity && notifPrefs[notif.severity] === false) return;
            const container = document.getElementById("toast-container");
            const el = document.createElement("div");
            el.className = `toast severity-${notif.severity}`;
            el.innerHTML = `
                <div class="toast-title">
                    <span class="notification-severity-badge ${notif.severity}">${notif.severity}</span>
                    ${escapeHtml(notif.title)}
                </div>
                <div class="toast-message">${escapeHtml(notif.message)}</div>
            `;
            el.onclick = () => removeToast(el);
            container.appendChild(el);

            // Auto-dismiss: 15s for critical, 8s for everything else
            const timeout = notif.severity === "critical" ? 15000 : 8000;
            setTimeout(() => removeToast(el), timeout);
        }

        function removeToast(el) {
            if (!el || !el.parentNode) return;
            el.classList.add("toast-out");
            el.addEventListener("animationend", () => {
                if (el.parentNode) el.parentNode.removeChild(el);
            });
        }

        // ---------------------------------------------------------------
        // File Transfers
        // ---------------------------------------------------------------

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + " B";
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
            return (bytes / (1024 * 1024)).toFixed(1) + " MB";
        }

        function renderFtAgentSelects() {
            ["ft-send-agent", "ft-request-agent"].forEach(id => {
                const select = document.getElementById(id);
                const prev = select.value;
                select.innerHTML = '<option value="">-- Select agent --</option>';
                agents.filter(a => a.status === "online" || a.status === "busy").forEach(a => {
                    const opt = document.createElement("option");
                    opt.value = a.agent_id;
                    opt.textContent = a.name + (a.status === "busy" ? " (busy)" : "");
                    select.appendChild(opt);
                });
                if (prev && select.querySelector(`option[value="${prev}"]`)) {
                    select.value = prev;
                }
            });
        }

        function handleTransferProgress(data) {
            const idx = fileTransfers.findIndex(t => t.transfer_id === data.transfer_id);
            if (idx >= 0) {
                fileTransfers[idx] = data;
            } else {
                fileTransfers.unshift(data);
            }
            renderTransfers();
        }

        function handleTransferHistory(data) {
            fileTransfers = data.transfers || [];
            renderTransfers();
        }

        function renderTransfers() {
            const activeContainer = document.getElementById("ft-active-transfers");
            const historyContainer = document.getElementById("ft-history");

            const active = fileTransfers.filter(t => t.status === "active" || t.status === "pending");
            const done = fileTransfers.filter(t => t.status !== "active" && t.status !== "pending");

            if (active.length === 0 && done.length === 0) {
                activeContainer.innerHTML = "";
                historyContainer.innerHTML = '<div class="ft-empty">No file transfers yet.</div>';
                return;
            }

            activeContainer.innerHTML = active.map(t => renderTransferCard(t, true)).join("");
            historyContainer.innerHTML = done.length > 0
                ? done.map(t => renderTransferCard(t, false)).join("")
                : "";
        }

        function renderTransferCard(t, isActive) {
            const dirArrow = t.direction === "to_agent" ? "\u2191" : "\u2193";
            const dirClass = t.direction === "to_agent" ? "upload" : "download";
            const dirLabel = t.direction === "to_agent" ? "Send" : "Receive";
            const pct = Math.round((t.progress || 0) * 100);
            const fillClass = t.status === "completed" ? "completed" : (t.status === "failed" ? "failed" : "");
            const cancelBtn = isActive
                ? `<button class="ft-cancel-btn" onclick="cancelTransfer('${t.transfer_id}')">Cancel</button>`
                : "";
            const errorHtml = t.error ? `<div class="ft-error">${escapeHtml(t.error)}</div>` : "";
            const sizeStr = t.file_size > 0 ? formatFileSize(t.file_size) : "";
            const chunkStr = t.chunk_count > 0 ? `${t.chunks_done}/${t.chunk_count} chunks` : "";
            const metaParts = [t.agent_name, dirLabel, sizeStr, chunkStr].filter(Boolean);

            return `
                <div class="ft-transfer-card">
                    <div class="ft-transfer-header">
                        <div class="ft-transfer-left">
                            <span class="ft-direction ${dirClass}">${dirArrow}</span>
                            <span class="ft-filename">${escapeHtml(t.filename || "unknown")}</span>
                            <span class="ft-meta">${escapeHtml(metaParts.join(" \u00b7 "))}</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:0.5rem;">
                            <span class="ft-status-badge ${t.status}">${t.status}</span>
                            ${cancelBtn}
                        </div>
                    </div>
                    <div class="ft-progress-bar">
                        <div class="ft-progress-fill ${fillClass}" style="width:${pct}%"></div>
                    </div>
                    ${errorHtml}
                </div>
            `;
        }

        function sendFile() {
            const agentId = document.getElementById("ft-send-agent").value;
            const fileInput = document.getElementById("ft-send-file");
            const destPath = document.getElementById("ft-send-dest").value.trim();

            if (!agentId) { alert("Select an agent first."); return; }
            if (!fileInput.files || fileInput.files.length === 0) { alert("Select a file first."); return; }

            const file = fileInput.files[0];

            if (file.size > 50 * 1024 * 1024) {
                alert("File too large (max 50 MB).");
                return;
            }

            // For files < 1MB, send via WebSocket; for larger files, use HTTP upload
            if (file.size < 1024 * 1024) {
                const reader = new FileReader();
                reader.onload = function() {
                    const arrayBuf = reader.result;
                    const bytes = new Uint8Array(arrayBuf);
                    let binary = "";
                    for (let i = 0; i < bytes.length; i++) {
                        binary += String.fromCharCode(bytes[i]);
                    }
                    const b64 = btoa(binary);

                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: "file_send",
                            agent_id: agentId,
                            filename: file.name,
                            dest_path: destPath,
                            data: b64,
                        }));
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // Use HTTP multipart upload
                const formData = new FormData();
                formData.append("file", file);
                formData.append("agent_id", agentId);
                formData.append("dest_path", destPath);

                fetch("/api/file/upload", { method: "POST", body: formData })
                    .then(r => r.json())
                    .then(data => {
                        if (!data.ok) {
                            alert("Upload failed: " + (data.error || "Unknown error"));
                        }
                    })
                    .catch(err => {
                        alert("Upload error: " + err.message);
                    });
            }

            // Clear file input
            fileInput.value = "";
        }

        function requestFile() {
            const agentId = document.getElementById("ft-request-agent").value;
            const filePath = document.getElementById("ft-request-path").value.trim();

            if (!agentId) { alert("Select an agent first."); return; }
            if (!filePath) { alert("Enter a remote file path."); return; }

            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "file_request_from_agent",
                    agent_id: agentId,
                    file_path: filePath,
                }));
            }
            document.getElementById("ft-request-path").value = "";
        }

        function cancelTransfer(transferId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: "file_transfer_cancel",
                    transfer_id: transferId,
                }));
            }
        }

        // Hook into renderAgents to update file transfer agent selects
        const _origRenderAgents2 = renderAgents;
        renderAgents = function() {
            _origRenderAgents2();
            renderFtAgentSelects();
            renderDeployPanel();
        };

        // ---------------------------------------------------------------
        // Connector Deploy
        // ---------------------------------------------------------------

        let deployLocalVersion = null;
        let deployAgentVersions = {};
        let deployHistory = [];
        let deployHistoryVisible = false;

        function handleDeployStatus(data) {
            deployLocalVersion = data.local_version || null;
            deployAgentVersions = data.agent_versions || {};
            deployHistory = data.history || [];
            renderDeployPanel();
            renderDeployHistory();
        }

        function handleDeployVersionResult(data) {
            if (data.agent_id) {
                deployAgentVersions[data.agent_id] = data.remote;
            }
            if (data.local) {
                deployLocalVersion = data.local;
            }
            renderDeployPanel();
        }

        function handleDeployResult(data) {
            // Add to history
            deployHistory.unshift(data);
            if (deployHistory.length > 10) deployHistory.length = 10;
            renderDeployHistory();
            renderDeployPanel();
            // Re-enable buttons
            document.querySelectorAll(".deploy-btn").forEach(b => b.disabled = false);
        }

        function handleDeployProgress(data) {
            // Update the row to show "deploying..." status
            const row = document.getElementById("deploy-row-" + data.agent_id);
            if (row) {
                const badge = row.querySelector(".deploy-ver-badge");
                if (badge) {
                    badge.className = "deploy-ver-badge unknown";
                    badge.textContent = "deploying...";
                }
            }
        }

        function renderDeployPanel() {
            // Update local version display
            const hashEl = document.getElementById("deploy-local-hash");
            if (deployLocalVersion) {
                hashEl.textContent = deployLocalVersion.short || "--";
                hashEl.title = deployLocalVersion.hash || "";
            }

            // Build agent rows
            const container = document.getElementById("deploy-agent-list");
            const online = agents.filter(a => a.status === "online" || a.status === "busy");

            if (online.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.85rem;">No agents connected</div>';
                return;
            }

            container.innerHTML = online.map(a => {
                const ver = deployAgentVersions[a.agent_id];
                const localHash = deployLocalVersion ? deployLocalVersion.hash : "";
                let badgeClass = "unknown";
                let badgeText = "unchecked";

                if (ver) {
                    if (ver.error && !ver.hash) {
                        badgeText = ver.short || "error";
                        badgeClass = "unknown";
                    } else if (ver.hash && localHash && ver.hash === localHash) {
                        badgeText = ver.short;
                        badgeClass = "match";
                    } else if (ver.hash) {
                        badgeText = ver.short;
                        badgeClass = "mismatch";
                    } else {
                        badgeText = ver.short || "unknown";
                        badgeClass = "unknown";
                    }
                }

                return `<div class="deploy-agent-row" id="deploy-row-${a.agent_id}">
                    <span class="status-dot ${a.status === 'online' ? 'online' : 'warning'}"></span>
                    <span class="agent-name">${a.name}</span>
                    <span class="agent-ip">${a.ip || ''}</span>
                    <span class="deploy-ver-badge ${badgeClass}" title="${ver && ver.hash ? ver.hash : ''}">${badgeText}</span>
                    <div class="deploy-actions">
                        <button class="deploy-btn" onclick="checkAgentVersion('${a.agent_id}')">Check</button>
                        <button class="deploy-btn" onclick="deployToAgent('${a.agent_id}')">Deploy</button>
                    </div>
                </div>`;
            }).join("");
        }

        function checkAgentVersion(agentId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            // Update badge to show checking
            const row = document.getElementById("deploy-row-" + agentId);
            if (row) {
                const badge = row.querySelector(".deploy-ver-badge");
                if (badge) {
                    badge.className = "deploy-ver-badge unknown";
                    badge.textContent = "checking...";
                }
            }
            ws.send(JSON.stringify({ type: "deploy_check_version", agent_id: agentId }));
        }

        function deployToAgent(agentId) {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const agent = agents.find(a => a.agent_id === agentId);
            const name = agent ? agent.name : agentId;
            if (!confirm("Deploy connector to " + name + "?\n\nThis will push the updated file and restart the agent service.")) return;
            // Disable buttons during deploy
            const row = document.getElementById("deploy-row-" + agentId);
            if (row) {
                row.querySelectorAll(".deploy-btn").forEach(b => b.disabled = true);
                const badge = row.querySelector(".deploy-ver-badge");
                if (badge) {
                    badge.className = "deploy-ver-badge unknown";
                    badge.textContent = "deploying...";
                }
            }
            ws.send(JSON.stringify({ type: "deploy_agent", agent_id: agentId }));
        }

        function deployAll() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const online = agents.filter(a => a.status === "online" || a.status === "busy");
            if (online.length === 0) { alert("No agents online"); return; }
            if (!confirm("Deploy connector to all " + online.length + " online agent(s)?\n\nAgents will be updated one at a time.")) return;
            document.getElementById("deploy-all-btn").disabled = true;
            ws.send(JSON.stringify({ type: "deploy_all" }));
        }

        function toggleDeployHistory() {
            deployHistoryVisible = !deployHistoryVisible;
            document.getElementById("deploy-history-list").style.display = deployHistoryVisible ? "flex" : "none";
            document.getElementById("deploy-history-arrow").innerHTML = deployHistoryVisible ? "&#9660;" : "&#9654;";
        }

        function renderDeployHistory() {
            const container = document.getElementById("deploy-history-list");
            if (!deployHistory.length) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.8rem;">No deploys yet</div>';
                return;
            }
            container.innerHTML = deployHistory.slice(0, 10).map(d => {
                const icon = d.ok ? '<span class="deploy-ok">&#10003;</span>' : '<span class="deploy-fail">&#10007;</span>';
                const ver = d.old_version && d.new_version
                    ? `${d.old_version} &rarr; ${d.new_version}`
                    : (d.new_version || "");
                const time = d.completed_at ? new Date(d.completed_at).toLocaleTimeString() : "";
                return `<div class="deploy-history-item">
                    ${icon}
                    <span>${d.agent_name || d.agent_id}</span>
                    <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-secondary);">${ver}</span>
                    <span>${d.message || ""}</span>
                    <span class="deploy-time">${time}</span>
                </div>`;
            }).join("");
        }

        // ---------------------------------------------------------------
        // Backup & Recovery
        // ---------------------------------------------------------------

        let backupStatus = { last_backup: null, count: 0, total_size: 0, backups: [] };

        function handleBackupStatus(data) {
            backupStatus = {
                last_backup: data.last_backup || null,
                count: data.count || 0,
                total_size: data.total_size || 0,
                backups: data.backups || [],
            };
            renderBackupPanel();
        }

        function handleBackupResult(data) {
            if (data.ok) {
                addNotification("Backup complete: " + data.filename, "info");
            } else {
                addNotification("Backup failed: " + (data.error || "unknown"), "error");
            }
            const btn = document.getElementById("backup-now-btn");
            if (btn) btn.disabled = false;
        }

        function handleBackupRestoreResult(data) {
            if (data.ok) {
                addNotification("Restore complete: " + data.files_restored + " files. Restart server to apply.", "info");
            } else {
                addNotification("Restore failed: " + (data.error || "unknown"), "error");
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return "0 B";
            const units = ["B", "KB", "MB", "GB"];
            let i = 0;
            let val = bytes;
            while (val >= 1024 && i < units.length - 1) {
                val /= 1024;
                i++;
            }
            return val.toFixed(1) + " " + units[i];
        }

        function renderBackupPanel() {
            // Status cards
            const lastEl = document.getElementById("backup-last-time");
            const countEl = document.getElementById("backup-count");
            const sizeEl = document.getElementById("backup-total-size");

            if (backupStatus.last_backup) {
                const ts = backupStatus.last_backup.created_at || backupStatus.last_backup.timestamp;
                lastEl.textContent = ts ? new Date(ts).toLocaleString() : "Unknown";
            } else {
                lastEl.textContent = "Never";
            }
            countEl.textContent = backupStatus.count;
            sizeEl.textContent = formatBytes(backupStatus.total_size);

            // Backup list
            const container = document.getElementById("backup-list");
            if (!backupStatus.backups || backupStatus.backups.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.85rem;">No backups yet</div>';
                return;
            }

            container.innerHTML = backupStatus.backups.map(b => {
                const date = b.created_at ? new Date(b.created_at).toLocaleString() : "";
                return `<div class="backup-row">
                    <span class="backup-filename">${b.filename}</span>
                    <span class="backup-size">${formatBytes(b.size)}</span>
                    <span class="backup-date">${date}</span>
                    <button class="backup-btn backup-btn-restore" onclick="restoreBackup('${b.filename}')">Restore</button>
                </div>`;
            }).join("");
        }

        function triggerBackup() {
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            const btn = document.getElementById("backup-now-btn");
            if (btn) btn.disabled = true;
            ws.send(JSON.stringify({ type: "backup_now" }));
        }

        function restoreBackup(filename) {
            if (!confirm("Restore from " + filename + "?\n\nThis will overwrite current data. The server will need a restart after restore.")) return;
            if (!ws || ws.readyState !== WebSocket.OPEN) return;
            ws.send(JSON.stringify({ type: "backup_restore", filename: filename }));
        }

        // ---------------------------------------------------------------
        // Message Bus
        // ---------------------------------------------------------------
        let busMessages = [];
        let busStats = {};
        let busMatrix = {};

        const BUS_CHANNEL_COLORS = {
            task_updates: "#3b82f6",
            content_pipeline: "#a855f7",
            research_results: "#22c55e",
            alerts: "#ef4444",
            system: "#6b7280",
        };

        function handleBusStatus(data) {
            busMessages = data.messages || [];
            busStats = (data.stats && data.stats.channels) ? data.stats.channels : {};
            busMatrix = data.matrix || {};
            renderBusPanel();
        }

        function handleBusMessage(data) {
            const msg = data.message;
            if (msg) {
                busMessages.unshift(msg);
                if (busMessages.length > 200) busMessages.length = 200;
            }
            if (data.stats && data.stats.channels) {
                busStats = data.stats.channels;
            }
            renderBusPanel();
        }

        function renderBusPanel() {
            renderBusStats();
            renderBusMatrix();
            renderBusLog();
        }

        function renderBusStats() {
            const el = document.getElementById("msgbus-stats");
            if (!el) return;
            const channels = ["task_updates", "content_pipeline", "research_results", "alerts", "system"];
            let total = 0;
            let html = "";
            channels.forEach(ch => {
                const count = busStats[ch] || 0;
                total += count;
                const label = ch.replace(/_/g, " ");
                html += '<div class="msgbus-stat-card msgbus-ch-' + ch + '">' +
                    '<span class="msgbus-stat-label">' + label + '</span>' +
                    '<span class="msgbus-stat-count">' + count + '</span></div>';
            });
            el.innerHTML = html;
            const totalEl = document.getElementById("msgbus-total");
            if (totalEl) totalEl.textContent = total + " messages";
        }

        function renderBusMatrix() {
            const el = document.getElementById("msgbus-matrix-rows");
            if (!el) return;
            const senders = Object.keys(busMatrix);
            if (senders.length === 0) {
                el.innerHTML = '<span class="msgbus-empty">No agent activity yet</span>';
                return;
            }
            // Sort by total messages desc
            senders.sort((a, b) => {
                const aTotal = Object.values(busMatrix[a]).reduce((s, v) => s + v, 0);
                const bTotal = Object.values(busMatrix[b]).reduce((s, v) => s + v, 0);
                return bTotal - aTotal;
            });
            let html = "";
            senders.forEach(sender => {
                const channels = busMatrix[sender];
                let badges = "";
                Object.keys(channels).sort((a, b) => channels[b] - channels[a]).forEach(ch => {
                    badges += '<span class="msgbus-matrix-badge msgbus-badge-' + ch + '">' +
                        ch.replace(/_/g, " ") + ' (' + channels[ch] + ')</span>';
                });
                html += '<div class="msgbus-matrix-row">' +
                    '<span class="msgbus-matrix-sender">' + sender + '</span>' +
                    '<span class="msgbus-matrix-channels">' + badges + '</span></div>';
            });
            el.innerHTML = html;
        }

        function renderBusLog() {
            const el = document.getElementById("msgbus-log");
            if (!el) return;
            const filter = document.getElementById("msgbus-filter");
            const selectedChannel = filter ? filter.value : "";
            let msgs = busMessages;
            if (selectedChannel) {
                msgs = msgs.filter(m => m.channel === selectedChannel);
            }
            if (msgs.length === 0) {
                el.innerHTML = '<div class="msgbus-empty">No messages' +
                    (selectedChannel ? ' on ' + selectedChannel : '') + '</div>';
                return;
            }
            // Show newest first (busMessages is already newest-first from handleBusMessage,
            // but initial load from bus_status is oldest-first, so reverse if needed)
            const sorted = msgs.slice(0, 100);
            if (sorted.length > 1 && sorted[0].timestamp < sorted[sorted.length - 1].timestamp) {
                sorted.reverse();
            }
            let html = "";
            sorted.forEach(m => {
                const t = m.timestamp ? new Date(m.timestamp) : new Date();
                const time = t.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", second: "2-digit" });
                const payloadStr = JSON.stringify(m.payload || {});
                const shortPayload = payloadStr.length > 80 ? payloadStr.slice(0, 77) + "..." : payloadStr;
                html += '<div class="msgbus-log-entry">' +
                    '<span class="msgbus-log-time">' + time + '</span>' +
                    '<span class="msgbus-log-sender">' + (m.sender || "?") + '</span>' +
                    '<span class="msgbus-log-channel msgbus-badge-' + m.channel + '">' + (m.channel || "").replace(/_/g, " ") + '</span>' +
                    '<span class="msgbus-log-payload" title="' + payloadStr.replace(/"/g, '&quot;') + '">' + shortPayload + '</span>' +
                    '</div>';
            });
            el.innerHTML = html;
        }

        function filterBusMessages() {
            renderBusLog();
        }

        // ---------------------------------------------------------------
        // Settings Tabs & Customization
        // ---------------------------------------------------------------
        function switchSettingsTab(tab, btn) {
            document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.settings-tab-content').forEach(c => c.classList.remove('active'));
            if (btn) btn.classList.add('active');
            const content = document.getElementById('settings-tab-' + tab);
            if (content) content.classList.add('active');
            if (tab === 'layout') renderLayoutEditor();
            if (tab === 'theme') renderThemeSelector();
            if (tab === 'notifications') renderNotificationPrefs();
        }

        function getOrderedPanels() {
            const saved = getPref('panelOrder', null);
            if (saved) {
                // Merge: saved order first, then any new panels not in saved
                const result = saved.filter(id => PANEL_REGISTRY.some(p => p.id === id));
                PANEL_REGISTRY.forEach(p => {
                    if (!result.includes(p.id)) result.push(p.id);
                });
                return result;
            }
            return PANEL_REGISTRY.map(p => p.id);
        }

        function renderLayoutEditor() {
            const editor = document.getElementById('layout-editor');
            if (!editor) return;
            const hidden = getPref('hiddenPanels', []);
            const sizes = getPref('panelSizes', {});
            const order = getOrderedPanels();
            editor.innerHTML = order.map((id, i) => {
                const reg = PANEL_REGISTRY.find(p => p.id === id);
                const name = reg ? reg.name : id;
                const visible = !hidden.includes(id);
                const sz = sizes[id] || 'normal';
                return `<div class="layout-row">
                    <button class="layout-toggle ${visible ? 'on' : ''}" onclick="togglePanel('${id}')" title="${visible ? 'Hide' : 'Show'}"></button>
                    <span class="panel-name">${name}</span>
                    <select class="layout-size-select" onchange="setPanelSize('${id}', this.value)">
                        <option value="compact" ${sz === 'compact' ? 'selected' : ''}>Compact</option>
                        <option value="normal" ${sz === 'normal' ? 'selected' : ''}>Normal</option>
                        <option value="expanded" ${sz === 'expanded' ? 'selected' : ''}>Expanded</option>
                    </select>
                    <button class="layout-arrow" onclick="movePanelUp('${id}')" ${i === 0 ? 'disabled' : ''} title="Move up">&#9650;</button>
                    <button class="layout-arrow" onclick="movePanelDown('${id}')" ${i === order.length - 1 ? 'disabled' : ''} title="Move down">&#9660;</button>
                </div>`;
            }).join('');
        }

        function togglePanel(id) {
            const hidden = getPref('hiddenPanels', []);
            const idx = hidden.indexOf(id);
            if (idx >= 0) hidden.splice(idx, 1);
            else hidden.push(id);
            setPref('hiddenPanels', hidden);
            applyPanelVisibility();
            renderLayoutEditor();
        }

        function movePanelUp(id) {
            const order = getOrderedPanels();
            const idx = order.indexOf(id);
            if (idx <= 0) return;
            [order[idx - 1], order[idx]] = [order[idx], order[idx - 1]];
            setPref('panelOrder', order);
            applyPanelOrder();
            renderLayoutEditor();
        }

        function movePanelDown(id) {
            const order = getOrderedPanels();
            const idx = order.indexOf(id);
            if (idx < 0 || idx >= order.length - 1) return;
            [order[idx], order[idx + 1]] = [order[idx + 1], order[idx]];
            setPref('panelOrder', order);
            applyPanelOrder();
            renderLayoutEditor();
        }

        function setPanelSize(id, size) {
            const sizes = getPref('panelSizes', {});
            sizes[id] = size;
            setPref('panelSizes', sizes);
            applyPanelSizes();
        }

        function renderThemeSelector() {
            const container = document.getElementById('theme-cards');
            if (!container) return;
            const current = getPref('theme', 'dark');
            const themes = [
                { id: 'dark', name: 'Dark', desc: 'Default dark theme', gradient: 'linear-gradient(135deg, #0f1923, #1a2332, #2a3a4a)' },
                { id: 'light', name: 'Light', desc: 'Clean light theme', gradient: 'linear-gradient(135deg, #f0f2f5, #ffffff, #e4e7eb)' },
                { id: 'doppler', name: 'Doppler', desc: 'Chrome & exhaust glow', gradient: 'linear-gradient(135deg, #121218, #f08c2e, #c8c8d0)' },
            ];
            container.innerHTML = themes.map(t =>
                `<div class="theme-card ${current === t.id ? 'active' : ''}" onclick="selectTheme('${t.id}')">
                    <div class="theme-preview" style="background: ${t.gradient}"></div>
                    <div class="theme-label">${t.name}</div>
                    <div class="theme-desc">${t.desc}</div>
                </div>`
            ).join('');
        }

        function selectTheme(theme) {
            applyTheme(theme);
            renderThemeSelector();
        }

        function renderNotificationPrefs() {
            const container = document.getElementById('notif-prefs');
            if (!container) return;
            const prefs = getPref('notifPrefs', { info: true, warning: true, error: true, critical: true });
            const severities = [
                { id: 'critical', label: 'Critical', desc: 'Urgent alerts requiring immediate attention' },
                { id: 'error', label: 'Error', desc: 'Error conditions and failures' },
                { id: 'warning', label: 'Warning', desc: 'Warnings and potential issues' },
                { id: 'info', label: 'Info', desc: 'Informational messages and status updates' },
            ];
            container.innerHTML = severities.map(s => {
                const on = prefs[s.id] !== false;
                return `<div class="notif-pref-row">
                    <div class="notif-pref-label">${s.label}<small>${s.desc}</small></div>
                    <button class="layout-toggle ${on ? 'on' : ''}" onclick="toggleNotifPref('${s.id}')"></button>
                </div>`;
            }).join('');
        }

        function toggleNotifPref(severity) {
            const prefs = getPref('notifPrefs', { info: true, warning: true, error: true, critical: true });
            prefs[severity] = !prefs[severity];
            setPref('notifPrefs', prefs);
            renderNotificationPrefs();
        }

        // ---------------------------------------------------------------
        // Start
        // ---------------------------------------------------------------
        connect();
    </script>
</body>
</html>
